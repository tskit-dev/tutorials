
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>ARGs as tree sequences &#8212; Tree Sequence Tutorials</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'args';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tree sequences and simulation" href="simulation_overview.html" />
    <link rel="prev" title="Working with Metadata" href="metadata.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/tskit_logo.svg" class="logo__image only-light" alt="Tree Sequence Tutorials - Home"/>
    <script>document.write(`<img src="_static/tskit_logo.svg" class="logo__image only-dark" alt="Tree Sequence Tutorials - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="what_is.html">What is a tree sequence?</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tree sequence basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="terminology_and_concepts.html">Terminology &amp; concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with <strong class="program">tskit</strong></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Statistics and Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="analysing_tree_sequences.html"><em>Analysing tree sequences</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="analysing_trees.html">Analysing trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="incremental_algorithms.html"><em>Incremental algorithms</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="counting_topologies.html">Counting topologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallelization.html"><em>Parallelization</em></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further tskit tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tables_and_editing.html">Tables and editing</a></li>
<li class="toctree-l1"><a class="reference internal" href="simplification.html"><em>Simplification</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="viz.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Working with Metadata</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">ARGs as tree sequences</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Simulation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="simulation_overview.html">Tree sequences and simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="no_mutations.html">Do you really need mutations?</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="advanced_msprime.html">Advanced <strong class="program">msprime</strong> topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="demography.html">Demography</a></li>
<li class="toctree-l2"><a class="reference internal" href="bottlenecks.html">Instantaneous Bottlenecks</a></li>
<li class="toctree-l2"><a class="reference internal" href="introgression.html">Introgression</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="completing_forward_sims.html">Completing forwards simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="forward_sims.html">Building a forward simulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="more_forward_sims.html"><em>Advanced forward simulations</em></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Other languages</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tskitr.html">Tskit and R</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorial_development.html"><em>Developing new tutorials</em></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tskit for ...</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="popgen.html"><code class="docutils literal notranslate"><span class="pre">Tskit</span></code> for population genetics</a></li>
<li class="toctree-l1"><a class="reference internal" href="phylogen.html"><code class="docutils literal notranslate"><span class="pre">Tskit</span></code> for phylogenetics</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/args.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>ARGs as tree sequences</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#full-args">Full ARGs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#local-trees-and-arity">Local trees and arity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sprs-and-recombination">SPRs and recombination</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-likelihoods">Calculating likelihoods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simplification">Simplification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#disadvantages-of-full-args">Disadvantages of Full ARGs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arg-formats-and-tskit">ARG formats and <code class="docutils literal notranslate"><span class="pre">tskit</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-args-in-tskit">Working with ARGs in <code class="docutils literal notranslate"><span class="pre">tskit</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#graph-traversal">Graph traversal</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#traversing-parent-nodes">Traversing parent nodes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#traversing-child-nodes">Traversing child nodes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-graph-analysis">Other graph analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-software">Other software</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="args-as-tree-sequences">
<span id="sec-args"></span><h1>ARGs as tree sequences<a class="headerlink" href="#args-as-tree-sequences" title="Link to this heading">#</a></h1>
<p>At its heart, a <code class="docutils literal notranslate"><span class="pre">tskit</span></code> <a class="reference internal" href="what_is.html#sec-what-is"><span class="std std-ref">tree sequence</span></a> consists of a list of
<a class="reference internal" href="terminology_and_concepts.html#sec-terminology-nodes"><span class="std std-ref">Nodes</span></a>, and a list of <a class="reference internal" href="terminology_and_concepts.html#sec-terminology-edges"><span class="std std-ref">Edges</span></a> that connect
parent to child nodes. Therefore a succinct tree sequence is equivalent to a
<a class="reference external" href="https://en.wikipedia.org/wiki/Directed_graph">directed graph</a>,
which is additionally annotated with genomic positions such that at each
position, a path through the edges exists which defines a tree. This graph
interpretation of a tree sequence maps very closely to the concept of
an “ancestral recombination graph” (or ARG). See
<a class="reference external" href="http://dx.doi.org/10.1093/genetics/iyae100">this paper</a> for further details.</p>
<section id="full-args">
<h2>Full ARGs<a class="headerlink" href="#full-args" title="Link to this heading">#</a></h2>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>An original, narrower definition, which we do not use here, restricts the term ARG to
the neutral coalescent process with simple crossover-recombination, and the
graph structure defined by that process, see e.g.
<a class="reference external" href="https://research.monash.edu/en/publications/an-ancestral-recombination-graph">Griffiths &amp; Marjoram (1997)</a></p>
</aside>
<p>The term “ARG” is <a class="reference external" href="https://doi.org/10.1086%2F508901">often used</a> to refer to
a structure consisting of nodes and edges that describe the genetic genealogy of a set
of sampled chromosomes which have evolved via a process of inheritance combined
with recombination. We use the term “full ARG” for a commonly-described type of
ARG that contains not just nodes that involve coalescence of ancestral material,
but also additional non-coalescent nodes. These nodes correspond to
recombination events, and common ancestor events that are not associated with
coalescence in any of the local trees. Full ARGs can be stored and analysed in
<a class="reference external" href="https://tskit.dev">tskit</a> like any other tree sequence. A full ARG can be generated using
<a class="reference external" href="https://tskit.dev/msprime/docs/stable/api.html#msprime.sim_ancestry" title="(in Project name not set)"><code class="docutils literal notranslate"><span class="pre">msprime.sim_ancestry()</span></code></a> by specifying <code class="docutils literal notranslate"><span class="pre">coalescing_segments_only=False</span></code> along with
<code class="docutils literal notranslate"><span class="pre">additional_nodes</span> <span class="pre">=</span> <span class="pre">msprime.NodeType.COMMON_ANCESTOR</span> <span class="pre">|</span> <span class="pre">msprime.NodeType.RECOMBINANT</span></code>
(or the equivalent <code class="docutils literal notranslate"><span class="pre">record_full_arg=True</span></code>) as described
<a class="reference external" href="https://tskit.dev/msprime/docs/stable/ancestry.html#sec-ancestry-full-arg" title="(in Project name not set)"><span class="xref std std-ref">in the msprime docs</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">msprime</span>

<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;samples&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># Three diploid individuals == six sample genomes</span>
    <span class="s2">&quot;sequence_length&quot;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
    <span class="s2">&quot;recombination_rate&quot;</span><span class="p">:</span> <span class="mf">1e-7</span><span class="p">,</span>
    <span class="s2">&quot;population_size&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="mi">333</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ts_arg</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">sim_ancestry</span><span class="p">(</span>
    <span class="o">**</span><span class="n">parameters</span><span class="p">,</span>
    <span class="n">discrete_genome</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># the strict Hudson ARG needs unique crossover positions (i.e. a continuous genome)</span>
    <span class="n">coalescing_segments_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># setting record_full_arg=True is equivalent to these last 2 parameters</span>
    <span class="n">additional_nodes</span><span class="o">=</span><span class="n">msprime</span><span class="o">.</span><span class="n">NodeType</span><span class="o">.</span><span class="n">COMMON_ANCESTOR</span> <span class="o">|</span> <span class="n">msprime</span><span class="o">.</span><span class="n">NodeType</span><span class="o">.</span><span class="n">RECOMBINANT</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulated a &quot;full ARG&quot; under the Hudson model:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot; ARG stored in a tree sequence with </span><span class="si">{</span><span class="n">ts_arg</span><span class="o">.</span><span class="n">num_nodes</span><span class="si">}</span><span class="s2"> nodes and&quot;</span>
    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">ts_arg</span><span class="o">.</span><span class="n">num_edges</span><span class="si">}</span><span class="s2"> edges (creating </span><span class="si">{</span><span class="n">ts_arg</span><span class="o">.</span><span class="n">num_trees</span><span class="si">}</span><span class="s2"> local trees)&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simulated a &quot;full ARG&quot; under the Hudson model:
 ARG stored in a tree sequence with 17 nodes and 18 edges (creating 3 local trees)
</pre></div>
</div>
</div>
</div>
<p>Like any tree sequence, we can also add mutations to the ARG to generate genetic
variation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1e-7</span>
<span class="n">ts_arg</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">sim_mutations</span><span class="p">(</span><span class="n">ts_arg</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">888</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Sample node:  &quot;</span> <span class="o">+</span> <span class="s2">&quot;   &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">ts_arg</span><span class="o">.</span><span class="n">samples</span><span class="p">()))</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ts_arg</span><span class="o">.</span><span class="n">variants</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable site </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">alleles</span><span class="p">)[</span><span class="n">v</span><span class="o">.</span><span class="n">genotypes</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Sample node:  0   1   2   3   4   5
Variable site 0: [&#39;T&#39; &#39;C&#39; &#39;T&#39; &#39;C&#39; &#39;C&#39; &#39;C&#39;]
Variable site 1: [&#39;C&#39; &#39;C&#39; &#39;C&#39; &#39;C&#39; &#39;G&#39; &#39;C&#39;]
Variable site 2: [&#39;T&#39; &#39;T&#39; &#39;G&#39; &#39;T&#39; &#39;T&#39; &#39;T&#39;]
</pre></div>
</div>
</div>
</div>
<section id="visualization">
<h3>Visualization<a class="headerlink" href="#visualization" title="Link to this heading">#</a></h3>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>In an <code class="docutils literal notranslate"><span class="pre">msprime</span></code> full ARG, recombinations are recorded in a specific way, by storing
the parental genomes of a gamete. This means that
<em>two</em> <code class="docutils literal notranslate"><span class="pre">tskit</span></code> nodes are created for each recombination, capturing transmission
to the left vs right of the crossover breakpoint. These two nodes, which exist
at the same timepoint, are identified by the
<a class="reference external" href="https://tskit.dev/msprime/docs/stable/api.html#msprime.msprime.NODE_IS_RE_EVENT" title="(in Project name not set)"><code class="xref py py-data docutils literal notranslate"><span class="pre">NODE_IS_RE_EVENT</span></code></a> and
are displayed as a single point in the “ortho” viz below, labelled with
two node IDs separated by a slash.</p>
</aside>
<p>The normal <a class="reference internal" href="viz.html#sec-tskit-viz"><span class="std std-ref">Visualization</span></a> of a tree sequence is as a set of local
trees. However, all tree sequences can also be
<a class="reference internal" href="viz.html#sec-tskit-viz-other-graph"><span class="std std-ref">plotted as graphs</span></a>. In particular, the Hudson “full ARG”
model guarantees that the graph consists of nodes which mark a split into two child lineages
(“common ancestor” nodes) or nodes which mark a split into two parent lineages
(“recombination” nodes). Such ARGs can be visualized with edges drawn as horizontal and vertical
lines (the “ortho” style in the
<a class="reference external" href="https://github.com/kitchensjn/tskit_arg_visualizer">tskit_arg_visualiser</a> software):</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%javascript</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span><span class="nx">paths</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">d3</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://d3js.org/d3.v7.min&#39;</span><span class="p">}});</span>
<span class="nx">require</span><span class="p">([</span><span class="s2">&quot;d3&quot;</span><span class="p">],</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">d3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nb">window</span><span class="p">.</span><span class="nx">d3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">d3</span><span class="p">;});</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/javascript">require.config({paths: {d3: 'https://d3js.org/d3.v7.min'}});
require(["d3"], function(d3) {window.d3 = d3;});
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tskit_arg_visualizer</span>
<span class="n">d3arg</span> <span class="o">=</span> <span class="n">tskit_arg_visualizer</span><span class="o">.</span><span class="n">D3ARG</span><span class="o">.</span><span class="n">from_ts</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="n">ts_arg</span><span class="p">)</span>
<span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">300</span>  <span class="c1"># width and height</span>
<span class="n">d3arg</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">edge_type</span><span class="o">=</span><span class="s2">&quot;ortho&quot;</span><span class="p">,</span> <span class="n">sample_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
<div class="output text_html"><style>.d3arg {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: white;
    padding: 20px 20px 60px 20px;
}

.d3arg:hover .dashboard {
    visibility: visible;
}

.d3arg .dashboard {
    display: flex;
    visibility: hidden;
}

.d3arg .dashboard .dashbutton {
    position: relative;
    font-size: 30px;
    border: 0px;
    background-color: white;
    width: 30px;
    height: 30px;
}

.d3arg .dashboard .dashbutton .tip {
    width: 150px;
    font-size: 12px;
    background-color: lightgrey;
    color: #053e4e;
    text-align: center;
    padding: 5px 0px;
    position: absolute;
    z-index: 1;
    top: 100%;
    left: 50%; 
    margin-left: -60px;
    visibility: hidden;
}

.d3arg .dashboard .dashbutton:hover .desc {
    visibility: visible;
}

.d3arg .dashboard path {
    fill: grey;
}

.d3arg .dashboard .dashbutton:hover path {
    fill: #053e4e;
}

.d3arg .dashboard .activecolor:active path {
    fill: #1eebb1;
}

.d3arg .savemethods, .d3arg .labelmethods {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: row;
    flex-wrap: wrap;
}

.d3arg .savemethods button, .d3arg .labelmethods button {
    background-color: lightgrey;
    color: #053e4e;
    font-size: 12px;
    width: auto;
    border: none;
}

.d3arg .savemethods button:hover, .d3arg .labelmethods button:hover {
    color: #1eebb1;
}

.d3arg .labelmethods button.node-labels-default {
    text-decoration: underline;
}

.d3arg .yaxis path {
    stroke: #053e4e;
    stroke-width: 3px;
}

.d3arg .yaxis line {
    stroke: #053e4e;
    stroke-width: 3px;
}

.d3arg .yaxis text {
    fill: #053e4e;
    stroke: 1px;
}

.d3arg .hiddennode {
    fill: lightgrey;
    stroke: lightgrey;
    stroke-width: 4px;
}

.d3arg .underlink {
    stroke: #ffffff;
    stroke-width: 12px;
    fill: none;
}

.d3arg .hiddenlink {
    stroke: lightgrey;
    stroke-width: 4px;
    fill: none;
}

.d3arg .labels {
    text-anchor: middle;
}

.d3arg .label {
    fill: #053e4e;
    font-family: Arial;
    font-size: 12px;
}

.d3arg .label.start {
    text-anchor: start;
}

.d3arg .label.stop {
    text-anchor: end;
}

.d3arg .hiddenlabel {
    fill: lightgrey;
    font-family: Arial;
    font-size: 12px;
}

.d3arg svg {
    display: block;
}

.d3arg button {
    display: block;
    cursor: pointer;
}

.d3arg .saving {
    display: flex;
    flex-direction: row;
}

.d3arg .saving .message {
    display: none;
}

.d3arg .tooltip {
    position: absolute;
    max-width: 500px;
    padding: 10px;
    background-color: white;
    color: black;
    text-align: center;
    z-index: 9999;
}

.d3arg .sites text {
    text-anchor: middle;
}</style><div id="arg_7194715985" class="d3arg" style="min-width:590.0px; min-height:455.0px;"></div><script>function parseRgbString(rgbString) {
  const match = rgbString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
  if (match) {
    const r = parseInt(match[1]);
    const g = parseInt(match[2]);
    const b = parseInt(match[3]);
    const a = match[4] ? parseFloat(match[4]) : 1; // Default alpha to 1 if not present
    return { r, g, b, a };
  }
  return null; // Or throw an error for invalid format
}

function ensureRequire() {
    // Needed e.g. in Jupyter notebooks: if require is already available, return resolved promise
    if (typeof require !== 'undefined') {
        return Promise.resolve(require);
    }

    // Otherwise, dynamically load require.js
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js';
        script.onload = () => resolve(require);
        script.onerror = reject;
        document.head.appendChild(script);
    });
};

function main_visualizer(
    d3,
    divnum,
    graph,
    width,
    height,
    y_axis,
    edge_styles,
    condense_mutations,
    label_mutations,
    tree_highlighting,
    title,
    rotate_tip_labels,
    plot_type,
    preamble,
    source,
    filename_for_saving,
) {
    /*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
    
    function download (url, name, opts) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', url)
        xhr.responseType = 'blob'
        xhr.onload = function () {
            saveAs(xhr.response, name, opts)
        }
        xhr.onerror = function () {
            console.error('could not download file')
        }
        xhr.send()
    }
    
    function corsEnabled (url) {
        var xhr = new XMLHttpRequest()
        // use sync to avoid popup blocker
        xhr.open('HEAD', url, false)
        try {
            xhr.send()
        } catch (e) {}
        return xhr.status >= 200 && xhr.status <= 299
    }
    
    // 'a.click()' doesn't work for all browsers (#465)
    function click (node) {
        try {
            node.dispatchEvent(new MouseEvent('click'))
        } catch (e) {
            var evt = document.createEvent('MouseEvents')
            evt.initMouseEvent('click', true, true, window, 0, 0, 0, 80,
                                20, false, false, false, false, 0, null)
            node.dispatchEvent(evt)
        }
    }
    
    function saveAs (blob, name, opts) {
        var URL = URL || webkitURL
        // Namespace is used to prevent conflict w/ Chrome Poper Blocker extension (Issue #561)
        var a = document.createElementNS('http://www.w3.org/1999/xhtml', 'a')
        name = name || blob.name || 'download'

        a.download = name
        a.rel = 'noopener' // tabnabbing

        // TODO: detect chrome extensions & packaged apps
        // a.target = '_blank'

        if (typeof blob === 'string') {
            // Support regular links
            a.href = blob
            if (a.origin !== location.origin) {
            corsEnabled(a.href)
                ? download(blob, name, opts)
                : click(a, a.target = '_blank')
            } else {
            click(a)
            }
        } else {
            // Support blobs
            a.href = URL.createObjectURL(blob)
            setTimeout(function () { URL.revokeObjectURL(a.href) }, 4E4) // 40s
            setTimeout(function () { click(a) }, 0)
        }
    }

    const NODE_IS_SAMPLE = 1;
    const NODE_IS_RE_EVENT = 131072;
    var line = d3.line();
    var step = d3.line().curve(d3.curveStep);
    var stepAfter = d3.line().curve(d3.curveStepAfter);
    var stepBefore = d3.line().curve(d3.curveStepBefore);


    // https://gist.github.com/Rokotyan/0556f8facbaf344507cdc45dc3622177
    // Below are the functions that handle actual exporting:
    // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
    function getSVGString( svgNode ) {
        svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
        var cssStyleText = getCSSStyles();
        appendCSS( cssStyleText, svgNode );
        var serializer = new XMLSerializer();
        var svgString = serializer.serializeToString(svgNode);
        svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
        svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix
        return svgString;

        function getCSSStyles() {
            // Extract CSS Rules
            var extractedCSSText = "";
            for (var i = 0; i < document.styleSheets.length; i++) { // this could be improved as it loops through all stylings on page
                var s = document.styleSheets[i];
                try {
                    if(!s.cssRules) continue;
                } catch( e ) {
                    if(e.name !== 'SecurityError') throw e; // for Firefox
                    continue;
                }
                var cssRules = s.cssRules;
                for (var r = 0; r < cssRules.length; r++) {
                    extractedCSSText += cssRules[r].cssText.replace(".d3arg ", ""); // removing reference to d3arg
                }
            }
            return extractedCSSText;

        }

        function appendCSS( cssText, element ) {
            var styleElement = document.createElement("style");
            styleElement.setAttribute("type","text/css"); 
            styleElement.innerHTML = cssText;
            var refNode = element.hasChildNodes() ? element.children[0] : null;
            element.insertBefore( styleElement, refNode );
        }
    }


    function svgString2Image( svgString, width, height, format, callback ) {
        var format = format ? format : 'png';
        var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL
        var canvas = document.createElement("canvas");
        var context = canvas.getContext("2d");
        canvas.width = width;
        canvas.height = height;
        var image = new Image();
        image.onload = function() {
            context.clearRect ( 0, 0, width, height);
            context.drawImage(image, 0, 0, width, height);
            canvas.toBlob( function(blob) {
                var filesize = Math.round( blob.length/1024 ) + ' KB';
                if ( callback ) callback( blob, filesize );
            });
        };
        image.src = imgsrc;
    }

    function draw_force_diagram() {
        var evenly_distributed_positions = graph.evenly_distributed_positions;
        var div_selector = "#arg_" + String(divnum);
        if (preamble) {
            d3.select(div_selector).html(preamble);
        }
        var tip = d3.select(div_selector).append("div")
            .attr("class", "tooltip")
            .style("display", "none");

        var dashboard = d3.select(div_selector).append("div").attr("class", "dashboard");
        
        var saving = dashboard.append("button").attr("class", "dashbutton");
        saving.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .attr("viewBox", "0 0 512 512")
            .append("path")
            .attr("d", "M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z");
        var saving_methods = saving.append("span").attr("class", "tip desc");
        var methods = saving_methods.append("div").text("Download As:").append("div").attr("class", "savemethods")

        methods.append("button").text("JSON")
            .on("click", function() {
                d3.selectAll(div_selector + " .node").classed("fix", function(d) {
                    d.fx = d.x;
                });
                src = JSON.parse(source);
                src.data.nodes = graph.nodes;
                var textBlob = new Blob([JSON.stringify(src)], {type: "text/plain"});
                saveAs(textBlob, filename_for_saving + ".json");
            });
        methods.append("button").text("SVG")
            .on('click', function(){
                var svgString = getSVGString(svg.node());
                var svgBlob = new Blob([svgString], {type:"image/svg+xml;charset=utf-8"});
                saveAs(svgBlob, filename_for_saving);
            });
        methods.append("button").text("PNG")
            .on('click', function(){
                var svgString = getSVGString(svg.node());
                svgString2Image(svgString, 2*width, 2*height, 'png', save); // passes Blob and filesize String to the callback
            
                function save(dataBlob){
                    saveAs(dataBlob, filename_for_saving); // FileSaver.js function
                }
            });
        
        /*
        methods.append("button").text("HTML")
            .on("click", function(){
                d3.selectAll(div_selector + " .node").classed("fix", function(d) {
                    d.fx = d.x;
                });
                var html = document.querySelector("html").outerHTML;
                var arg_div = document.getElementById(div_selector).innerHTML;
                console.log(arg_div);
                html = html.replace(arg_div, "");
                html = html.replace(source.match(/'nodes': .*'links'/), "'nodes': " + JSON.stringify(graph.nodes) + ", 'links'")
                saveAs(new Blob([html], {type:"text/plain;charset=utf-8"}), "tskit_arg_visualizer.html");
            })
        */

        var reheat = dashboard.append("button").attr("class", "dashbutton activecolor")
            .on("click", function(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();       
                var order = d3.selectAll(div_selector + " .sample").data().sort((a, b) => d3.ascending(a.x, b.x)).map(a => a.id);;
                d3.selectAll(div_selector + " .node").classed("unfix", function(d) {
                    if ((d.ts_flags & NODE_IS_SAMPLE) & (d.x_pos_reference == -1)) {
                        delete d.fx;
                    } else {
                        d.fx = evenly_distributed_positions[order.indexOf(d.id)];
                    }
                });
            });
        reheat.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .attr("viewBox", "0 0 384 512")
            .append("path")
            .attr("d", "M153.6 29.9l16-21.3C173.6 3.2 180 0 186.7 0C198.4 0 208 9.6 208 21.3V43.5c0 13.1 5.4 25.7 14.9 34.7L307.6 159C356.4 205.6 384 270.2 384 337.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6C85.9 176 96 186.1 96 198.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7c0-27.7 9-54.8 25.6-76.9z");
        reheat.append("span").attr("class", "tip desc").text("Reheat Simulation");
        
        if (plot_type == "full") {
            var evenly_distribute = dashboard.append("button").attr("class", "dashbutton activecolor")
                .on("click", function() {
                    var order = d3.selectAll(div_selector + " .sample").data().sort((a, b) => d3.ascending(a.x, b.x)).map(a => a.id);;
                    d3.selectAll(div_selector + " .sample").classed("distribute", function(d) {
                        d.fx = evenly_distributed_positions[order.indexOf(d.id)];
                    });
                });
            evenly_distribute.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                .attr("xmlns", "http://www.w3.org/2000/svg")
                .attr("viewBox", "0 0 512 512")
                .append("path")
                .attr("d", "M504.3 273.6c4.9-4.5 7.7-10.9 7.7-17.6s-2.8-13-7.7-17.6l-112-104c-7-6.5-17.2-8.2-25.9-4.4s-14.4 12.5-14.4 22l0 56-192 0 0-56c0-9.5-5.7-18.2-14.4-22s-18.9-2.1-25.9 4.4l-112 104C2.8 243 0 249.3 0 256s2.8 13 7.7 17.6l112 104c7 6.5 17.2 8.2 25.9 4.4s14.4-12.5 14.4-22l0-56 192 0 0 56c0 9.5 5.7 18.2 14.4 22s18.9 2.1 25.9-4.4l112-104z")
            evenly_distribute.append("span").attr("class", "tip desc").text("Space Samples");
        }

        var labelling = dashboard.append("button").attr("class", "dashbutton");
        labelling.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .attr("viewBox", "0 0 512 512")
            .append("path")
            .attr("d", "M0 80L0 229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0L418.7 317.3c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7L48 32C21.5 32 0 53.5 0 80zm112 32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z");
        var labelling_methods = labelling.append("span").attr("class", "tip desc");
        var methods = labelling_methods.append("div").text("Node Labels:").append("div").attr("class", "labelmethods")
        
        function switch_node_label(selected) {
            label_text.each(function(d) {
                d3.select(this).selectAll("*").remove();
                if (selected == "default") {
                    multi_line_text.call(this, d.label, (d.parent_of.length == 0));
                } else if (selected == "id") {
                    multi_line_text.call(this, "#" + String(d.id));
                } else {
                    multi_line_text.call(this, "");
                }
            })
        }
        
        methods.append("button").attr("class", "node-labels-default").text("DEFAULT")
            .on("click", function() {
                switch_node_label("default");
                // Underline the current selection (could use different highlighting method here)
                d3.selectAll(div_selector + " .labelmethods button").style("text-decoration", "none");
                d3.select(this).style("text-decoration", "underline");
            });
        methods.append("button").attr("class", "node-labels-id").text("#ID")
            .on('click', function(){
                switch_node_label("id");
                // Underline the current selection (could use different highlighting method here)
                d3.selectAll(div_selector + " .labelmethods button").style("text-decoration", "none");
                d3.select(this).style("text-decoration", "underline");
            });
        methods.append("button").attr("class", "node-labels-none").text("NONE")
            .on('click', function(){
                switch_node_label("none");
                // Underline the current selection (could use different highlighting method here)
                d3.selectAll(div_selector + " .labelmethods button").style("text-decoration", "none");
                d3.select(this).style("text-decoration", "underline");
            });


        var svg = d3.select(div_selector).append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("background-color", "white");

        var result = y_axis.ticks.map(function (x) { 
            return parseInt(x, 10); 
        });

        if (eval(y_axis.include_labels)) {
            var bottom = height - 50;
            if (tree_highlighting) {
                bottom = height - 125;
            }
            var top = 50;
            if (title != "None") {
                top = 100
            }
            var yscale = d3.scaleLinear() 
                .domain([y_axis.max_min[0], y_axis.max_min[1]]) 
                .range([y_axis.max_min[0], y_axis.max_min[1]]); 

            var y_axis_text = y_axis.text;

            var d3_y_axis = d3.axisRight().scale(yscale)
                .tickValues(result)
                .tickFormat((d, i) => y_axis_text[i]); 

            var y_axis_labels = svg
                .append("g")
                .attr("class", "yaxis")
                .attr("transform", "translate(25,0)")
                .call(d3_y_axis);
            
            if (y_axis.title != "None") {
                y_axis_labels.append("text")
                .attr("x", -15)
                .attr("y", (y_axis.max_min[0]+y_axis.max_min[1])/2)
                .attr("fill", "black")
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .attr("class", "label")
                .attr("transform", "rotate(-90, -15, " + (y_axis.max_min[0]+y_axis.max_min[1])/2 + ")")
                .text(y_axis.title);
            }
        }

        var simulation = d3
            .forceSimulation(graph.nodes)
            .force("link", d3.forceLink()
                .id(d => d.id)
                .links(graph.links)
            )
            //.force("center", d3.forceCenter(275,250).strength(-10))
            .force("charge", d3.forceManyBody().strength(-100))
            .on("tick", ticked);

        var link_container = svg
            .append("g")
            .attr("class", "links")
            .selectAll("path")
            .data(graph.links)
            .enter()
            .append("g")
            .attr("bounds", d => d.bounds);

        if ((edge_styles.type == "ortho") & eval(edge_styles.include_underlink)) {
            var underlink = link_container
                .append("path")
                .attr("class", "underlink");
        }

        var link = link_container
            .append("path")
            .attr("class", "link")
            .attr("stroke", d => d.stroke)
            .attr("stroke-width", "4px");
        
        if (eval(edge_styles.variable_width)) {
            link
                .style("stroke-width", d => d.region_fraction * 7 + 1);
        }

        if (tree_highlighting) {
            d3.selectAll(div_selector + " .link")
                .on('mouseover', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        d3.select(this)
                            .style('stroke', '#1eebb1')
                            .style("cursor", "pointer");
                        d3.selectAll(div_selector + " .sites .e" + d.id).style("display", "block");
                        d3.selectAll(div_selector + " .endpoints")
                            .style('display', 'none'); /* hide other labels to avoid clashes */
                        const bars = d3.select(div_selector + " .breakpoints").selectAll(".included");
                        bars /* colour in all bars covered by these bounds */
                            .filter(function(j) {
                                return d.bounds.split(" ").some(function(region) {
                                    region = region.split("-");
                                    return (parseFloat(region[0]) <= j.start) & (parseFloat(region[1]) >= j.stop)
                                });
                            })
                            .selectAll("rect").style('fill', '#1eebb1');
                        bars /* show the leftmost position label */
                            .filter(function(j) {
                                return d.bounds.split(" ").some(function(region) {
                                    region = region.split("-");
                                    return (parseFloat(region[0]) == j.start)
                                });
                            })
                            .selectAll("text.start").style('display', 'block');
                        bars /* show the rightmost position label */
                            .filter(function(j) {
                                return d.bounds.split(" ").some(function(region) {
                                    region = region.split("-");
                                    return (parseFloat(region[1]) == j.stop)
                                });
                            })
                            .selectAll("text.stop").style('display', 'block');
                    }
                })
                .on('mouseout', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        d3.select(this)
                            .style('stroke', d.stroke)
                            .style("cursor", "default");
                        const bars = d3.select(div_selector + " .breakpoints").selectAll(".included");
                        bars.selectAll("rect").style("fill", d.fill);
                        bars.selectAll("text").style("display", "none");
                        d3.selectAll(div_selector + " .endpoints")
                            .style('display', 'block');
                        d3.selectAll(div_selector + " .sites .e" + d.id).style("display", "none");
                    }
                });
        }

        var node_group = svg
            .append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter()
            .append("g");

        var missing_edges = node_group
            .filter(d => (d.not_included_parents>0) | (d.not_included_children>0))
            .append("g")
            .attr("class", "missing");

        var missing_parents = missing_edges
            .filter(d => d.not_included_parents>0)
            .append("g")
            .attr("class", "parents")
            .append("g");
        var missing_parents_paths = missing_parents.append("path");
        var missing_parents_texts = missing_parents
            .append("text")
                .attr("class", "label")
                .style("fill", "gray")
                .text(d => d.not_included_parents);

        var missing_children = missing_edges
            .filter(d => d.not_included_children>0)
            .append("g")
            .attr("class", "children")
            .append("g");
        var missing_children_paths = missing_children.append("path");
        var missing_children_texts = missing_children
            .append("text")
                .attr("class", "label")
                .style("fill", "gray")
                .text(d => d.not_included_children);

        function multi_line_text(text, top_align) {
            if (text != null) {
                // Split label text onto separate lines by newline characters, if they exist
                const lines = text.split("\n");
                const parentX = d3.select(this).attr("x") || "0";  // Get parent text's x position
                const initialDy = top_align ? "0em" : (-1 * (lines.length - 1)) + "em";

                d3.select(this).text(null); // clear existing text
                d3.select(this).selectAll('tspan')
                    .data(lines)
                    .enter()
                    .append('tspan')
                    .text(d => d)
                    .attr('x', parentX)  // Use parent's x position
                    .attr('dy', (d, i) => ((i === 0) ? initialDy : "1em"));
            }
        }
        var node = node_group
            .append("path")
            .attr("transform", d => "translate(" + d.x + "," + d.y + ")")
            .attr("d", d3.symbol().type(d => eval(d.symbol)).size(d => d.size))
            .attr("fill", d => d.fill)
            .attr("stroke", d => d.stroke)
            .attr("stroke-width", d => d.stroke_width)
            .attr("id", d => String(divnum) + "_node" + d.id)
            .attr("class", d => "node flag" + d.ts_flags + (d.ts_flags & NODE_IS_SAMPLE ? " sample" : ""))
            .attr("parents", d => d.child_of.toString().replace(",", " "))
            .attr("children", d => d.parent_of.toString().replace(",", " "))
            .call(
                d3
                    .drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
            )
            .on('mouseover', function (d, i) {
                d3.select(this)
                    .style("cursor", "pointer")
            });

        function highlight_mut(mutation_id, site_id, fill) {
            /* other mutations at the same site on the tree */
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect").style("stroke", fill);
            /* highlight only this mutation in the bar */
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "block");
        }

        function dehighlight_mut(mutation_id, site_id) {
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect")
                .each(function(d) {
                    d3.select(this)
                        .style("stroke", d.stroke)
                        .style("fill", d.fill);
                    });
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "none");
        }

        function highlight_mut(mutation_id, site_id, fill) {
            /* other mutations at the same site on the tree */
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect").style("stroke", fill);
            /* highlight only this mutation in the bar */
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "block");
        }

        function dehighlight_mut(mutation_id, site_id) {
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect")
                .each(function(d) {
                    d3.select(this)
                        .style("stroke", d.stroke)
                        .style("fill", d.fill);
                    });
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "none");
        }

        var mut_symbol = svg
            .append("g")
            .attr("class", "mutations")
            .selectAll("rect")
            .data(graph.mutations)
            .enter()
            .append("g")
            .attr("class", d => {
                if (condense_mutations) {
                    return (
                        d.site_id.map(id => "s" + id).join(" ") + " " +
                        d.mutation_id.map(id => "m" + id).join(" ")
                    )
                } else {
                    return "s" + d.site_id + " " + "m" + d.mutation_id;
                }}
            )
            .attr("class", d => {
                if (condense_mutations) {
                    return (
                        d.site_id.map(id => "s" + id).join(" ") + " " +
                        d.mutation_id.map(id => "m" + id).join(" ")
                    )
                } else {
                    return "s" + d.site_id + " " + "m" + d.mutation_id;
                }}
            )
            .on("mouseover", function(event, d) {
                if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                    d3.select(this).style("cursor", "pointer");
                    /* highlight all mutations at the same site (easy to spot reversions etc) */
                    if (condense_mutations) {
                        d.mutation_id.forEach((id, i) => highlight_mut(id, d.site_id[i], d.fill));
                    } else {
                        highlight_mut(d.mutation_id, d.site_id, d.fill)
                    }
                    if (condense_mutations) {
                        d.mutation_id.forEach((id, i) => highlight_mut(id, d.site_id[i], d.fill));
                    } else {
                        highlight_mut(d.mutation_id, d.site_id, d.fill)
                    }
                    /* Show a tooltip with the mutation information */
                    var rect = d3.select(div_selector).node().getBoundingClientRect();
                    tip
                        .style("display", "block")
                        .html("<p style='margin: 0px;'>" + d.content + "</p>")
                        .style("border", d.fill + " solid 2px")
                        .style("left", (event.pageX - rect.x) + "px")
                        .style("top", (event.pageY - rect.y + 25) + "px")
                        .style("transform", "translateX(-50%)");
                }
            })
            .on("mouseout", function(event, d) {
                if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                    if (!eval(d.active)) {
                        d3.select(this).style("cursor", "default");
                        if (condense_mutations) {
                            d.mutation_id.forEach((id, i) => dehighlight_mut(id, d.site_id[i]));
                        } else {
                            dehighlight_mut(d.mutation_id, d.site_id);
                        }
                    }
                    if (!eval(d.active)) {
                        d3.select(this).style("cursor", "default");
                        if (condense_mutations) {
                            d.mutation_id.forEach((id, i) => dehighlight_mut(id, d.site_id[i]));
                        } else {
                            dehighlight_mut(d.mutation_id, d.site_id);
                        } 
                        tip.style("display", "none");
                    }
                }
            });

        if (label_mutations) {
            var mut_symbol_label = mut_symbol
                .append("text")
                //.attr("class", "label")
                .style("font-size", d => (d.size * 2 + "px"))
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .attr("fill", d => {
                    var box = document.createElement("div");
                    box.style.color = d.fill;
                    document.body.appendChild(box);
                    var rgb = parseRgbString(window.getComputedStyle(box).color);
                    document.body.removeChild(box);
                    var lightness = 0.2126*rgb["r"] + 0.7152*rgb["g"] + 0.0722*rgb["b"];
                    if (lightness > 0.5) {
                        return "#053e4e"
                    }
                    return "white"
                })
                .text(d => d.label)
                .each(function(d) {
                    // Store the text width on the data object
                    d.textWidth = this.getComputedTextLength();
                });
        }

        var mut_symbol_rect = mut_symbol
            .append("rect")
            .attr("class", "symbol")
            .attr("fill", d => d.fill)
            .attr("stroke", d => d.stroke)
            .attr("stroke-width", 2)
            // Set the rect width / height based on the calculated text width
            .attr("width", function(d) {
                if (label_mutations && d.textWidth) {
                    d.computedWidth = d.textWidth + 6; // Add left/right padding
                } else {
                    d.computedWidth = d.size * 3; // aspect ratio is 3 (3 times wider than tall)
                }
                return d.computedWidth;  
            })
            .attr("height", function(d) {
                if (label_mutations) {
                    d.computedHeight = (d.size * 2) + 4; // Font size + top/bottom padding
                }
                else {
                    d.computedHeight = d.size;
                }
                return d.computedHeight;
            })
            .lower();

        function rotate_tip(d) {
            /* NB: why is there an "eval" here? */
            if ((d.parent_of.length == 0) & (eval(rotate_tip_labels))) {
                return "translate(-4, 0) rotate(90)"
            }
            return null
        }

        var label = svg
            .append("g")
            .attr("class", "node-labels")
            .selectAll("text")
            .data(graph.nodes)
            .enter()
            //.filter(d => eval(d.include_label))
            .append("g");

        var label_text = label
            .attr("class", d => "label n" + d.id)
            .append("text")
            .each(function(d) {
                multi_line_text.call(this, d.label, (d.parent_of.length == 0));
            })
            //.each(d => multi_line_text.call(this, d.label, (d.parent_of.length == 0)))
            .attr("transform", rotate_tip);

        function determine_path_type(d) {
            path_type = ""
            var start_position_x = d.source.x;
            var start_position_y = d.source.y;
            var stop_position_x = d.target.x;
            var stop_position_y = d.target.y;
            var vnub = Math.min((stop_position_y-start_position_y)/2, 20);
            if ("y_axis.scale" == "time" | "y_axis.scale" == "log_time") {
                vnub = 0;
            }
            var alt_child = document.getElementById(String(divnum) + "_node" + d.alt_child);
            if (alt_child != null) {
                var alt_child_x = alt_child.getAttribute("cx");
                var alt_child_y = alt_child.getAttribute("cy");
            }
            if (d.source.ts_flags & NODE_IS_RE_EVENT) {
                path_type += "r0";
                start_position_y = d.source.y + vnub;
            } else {
                if (d.target.y < alt_child_y) {
                    if (d.target.x < d.source.x) {
                        if (d.target.x < d.source.x - 40) {
                            path_type += "tL";
                        } else {
                            path_type += "fL";
                        }
                        start_position_x = d.source.x - 20;
                    } else {
                        if (d.target.x > d.source.x + 40) {
                            path_type += "tR";
                        } else {
                            path_type += "fR";
                        }
                        start_position_x = d.source.x + 20;
                    }
                } else if (d.target.y > alt_child_y) {
                    if (alt_child_x < d.source.x) {
                        if (d.target.x < d.source.x + 40) {
                            path_type += "fR";
                        } else {
                            path_type += "tR";
                        }
                        start_position_x = d.source.x + 20;
                    } else {
                        if (d.target.x > d.source.x - 40) {
                            path_type += "fL";
                        } else {
                            path_type += "tL";
                        }
                        start_position_x = d.source.x - 20;
                    }
                } else {
                    if (d.target.x < alt_child_x) {
                        if (d.target.x < d.source.x - 40) {
                            path_type += "tL";
                        } else {
                            path_type += "fL";
                        }
                        start_position_x = d.source.x - 20;
                    } else if (d.target.x > alt_child_x) {
                        if (d.target.x > d.source.x + 40) {
                            path_type += "tR";
                        } else {
                            path_type += "fR";
                        }
                        start_position_x = d.source.x + 20;
                    } else {
                        if (d.index % 2 == 0) {
                            path_type += "fL";
                            start_position_x = d.source.x - 20;
                        } else {
                            path_type += "fR";
                            start_position_x = d.source.x + 20;
                        }
                    }
                }
            }
            var alt_parent = document.getElementById(String(divnum) + "_node" + d.alt_parent);
            if (alt_parent != null) {
                var alt_parent_x = alt_parent.getAttribute("cx");
                var alt_parent_y = alt_parent.getAttribute("cy");
            }
            if (d.target.ts_flags & NODE_IS_RE_EVENT) {
                if (d.source.y < alt_parent_y) {
                    if (alt_parent_x < d.target.x) {
                        if (d.source.x < d.target.x + 40) {
                            path_type += "fR";
                        } else {
                            path_type += "tR";
                        }
                        stop_position_x = d.target.x + 20;
                    } else {
                        if (d.source.x > d.target.x - 40) {
                            path_type += "fL";
                        } else {
                            path_type += "tL";
                        }
                        stop_position_x = d.target.x - 20;
                    }
                } else if (d.source.y > alt_parent_y) {
                    if (d.source.x < d.target.x) {
                        if (d.source.x < d.target.x - 40) {
                            path_type += "tL";
                        } else {
                            path_type += "fL";
                        }
                        stop_position_x = d.target.x - 20;
                    } else {
                        if (d.source.x > d.target.x + 40) {
                            path_type += "tR";
                        } else {
                            path_type += "fR";
                        }
                        stop_position_x = d.target.x + 20;
                    }
                } else {
                    if (d.index % 2 == 0) {
                        path_type += "fL";
                        stop_position_x = d.target.x - 20;
                    } else {
                        path_type += "fR";
                        stop_position_x = d.target.x + 20;
                    }
                }
            } else {
                path_type += "b0";
                stop_position_y = d.target.y - vnub;
            }
            if (path_type == "fLb0" ) {
                if (start_position_x >= stop_position_x) {
                    path_type = "tLb0";
                }
            } else if (path_type == "fRb0") {
                if (start_position_x <= stop_position_x) {
                    path_type = "tRb0";
                }
            } else if (path_type == "r0fL") {
                if (start_position_x <= stop_position_x) {
                    path_type = "r0tL";
                }
            } else if (path_type == "r0fR") {
                if (start_position_x >= stop_position_x) {
                    path_type = "r0tR";
                }
            } else if (path_type == "fLfL") {
                if (start_position_x <= stop_position_x) {
                    path_type = "fLtL";
                } else {
                    path_type = "tLfL";
                }
            } else if (path_type == "fRfR") {
                if (start_position_x >= stop_position_x) {
                    path_type = "fRtR";
                } else {
                    path_type = "tRfR";
                }
            }
            return [path_type, start_position_x, start_position_y, stop_position_x, stop_position_y];
        }

        function ortho_pathing(d, path_info, underlink=false) {      
            const path_type = path_info[0];
            const simple_path_type = Array.from(path_type)[0] + Array.from(path_type)[2];
            const start_position_x = path_info[1];
            const start_position_y = path_info[2];
            const stop_position_x = path_info[3];
            const stop_position_y = path_info[4];

            const after_paths = ["rf", "tb", "tf"];
            const before_paths = ["rt", "fb", "ft"];
            const step_paths = ["tt"];
            const mid_paths = ["rb", "ff"];

            if (underlink) {
                if (after_paths.includes(simple_path_type)) {
                    return stepAfter([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]);
                } else if (before_paths.includes(simple_path_type)) {
                    return stepBefore([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]);
                } else if (step_paths.includes(simple_path_type)) {
                    return step([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]);
                } else if (mid_paths.includes(simple_path_type)) {
                    return line([[start_position_x, start_position_y],[start_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[start_position_x, start_position_y + (stop_position_y - start_position_y)/2],[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2], [stop_position_x, stop_position_y]]);
                }
            } else {
                if (after_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + stepAfter([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                } else if (before_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + stepBefore([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                } else if (step_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + step([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                } else if (mid_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + line([[start_position_x, start_position_y],[start_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[start_position_x, start_position_y + (stop_position_y - start_position_y)/2],[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2], [stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                }
            }
        }

        function ticked() {
            node
                .attr("transform", function(d) {
                    if (eval(y_axis.include_labels)) {
                        return "translate(" + Math.max(150, Math.min(width-50, d.x)) + "," + d.y + ")";
                    } else {
                        return "translate(" + Math.max(50, Math.min(width-50, d.x)) + "," + d.y + ")";
                    }
                })
                .attr("cx", function(d) {
                    if ((edge_styles.type == "ortho") & (d.x_pos_reference != -1)) {
                        var ref = document.getElementById(String(divnum) + "_node" + d.x_pos_reference);
                        if (ref != null) {
                            d.fx = ref.getAttribute("cx");
                        }
                    }
                    if (eval(y_axis.include_labels)) {
                        return d.x = Math.max(150, Math.min(width-50, d.x));
                    } else {
                        return d.x = Math.max(50, Math.min(width-50, d.x));
                    }
                })
                .attr("cy", d => d.y);
            
            link_container.each(function(d) {
                var path_info = determine_path_type(d);
                var path = "";
                if (edge_styles.type == "ortho") {
                    path = ortho_pathing(d, path_info);
                    underlink_path = ortho_pathing(d, path_info, underlink=true);
                } else if (d.source.id == d.alt_parent) {
                    var leftOrRight = 20;
                    if (d.index % 2 == 0) {
                        leftOrRight = -20;
                    }
                    path = "M " + d.source.x + " " + d.source.y + " C " + (d.source.x + leftOrRight).toString() + " " +  (d.source.y - 10).toString() + ", " + (d.target.x + leftOrRight).toString() + " " + (d.target.y + 10).toString() + ", " + d.target.x + " " + d.target.y;
                } else {
                    path = line([[d.source.x, d.source.y], [d.target.x, d.target.y]]);
                }
                if ((edge_styles.type == "ortho") & eval(edge_styles.include_underlink)) {
                    var u = d3.select(this).select(".underlink");
                    u.attr("d", underlink_path);
                }
                var l = d3.select(this).select(".link");
                l.attr("path_type", path_info[0]);
                l.attr("d", path)
                l.attr("fill", "none");
            });

            mut_symbol_rect
                .attr("x", function(d) {
                    var parent = document.getElementById(String(divnum) + "_node" + d.source);
                    if (parent != null) {
                        var parent_x = parseFloat(parent.getAttribute("cx"));
                        var parent_y = parseFloat(parent.getAttribute("cy"));
                        var child = document.getElementById(String(divnum) + "_node" + d.target);
                        if (child != null) {
                            var child_x = parseFloat(child.getAttribute("cx"));
                            var child_y = parseFloat(child.getAttribute("cy"));
                            if (parent_x - child_x == 0) {
                                return parent_x - d.computedWidth/2;
                            } else {
                                var slope = (parent_y - child_y) / (parent_x - child_x);
                                var intercept = parent_y - slope * parent_x;
                                return ((d.y - intercept) / slope) - d.computedWidth/2;
                            }
                        } else {
                            return 0;
                        }
                    } else {
                        return 0;
                    }
                })
                .attr("y", d => d.y - d.computedHeight/2);

            mut_symbol
                .attr("transform", function(d) {
                    var parent = document.getElementById(String(divnum) + "_node" + d.source);
                    if (parent != null) {
                        var parent_x = parseFloat(parent.getAttribute("cx"));
                        var parent_y = parseFloat(parent.getAttribute("cy"));
                        var child = document.getElementById(String(divnum) + "_node" + d.target);
                        if (child != null) {
                            var child_x = parseFloat(child.getAttribute("cx"));
                            var child_y = parseFloat(child.getAttribute("cy"));
                            var slope = (parent_y - child_y) / (parent_x - child_x);
                            var intercept = parent_y - slope * parent_x;
                            var rect = this.children[0];
                            return "rotate(" + String(-Math.atan((child_x-parent_x)/(child_y-parent_y))*180/Math.PI) + ", " + String(parseFloat(rect.getAttribute("x"))+parseFloat(rect.getAttribute("width"))/2) + ", " + String(parseFloat(rect.getAttribute("y"))+parseFloat(rect.getAttribute("height"))/2) + ")";
                        } else {
                            return "rotate(0)";
                        }
                    } else {
                        return "rotate(0)";
                    }
                });
            
            if (label_mutations) {
                mut_symbol_label
                    .attr("transform", function(d) {
                        var y = d.y + 1;
                        var x = 0;
                        var parent = document.getElementById(String(divnum) + "_node" + d.source);
                        if (parent != null) {
                            var parent_x = parseFloat(parent.getAttribute("cx"));
                            var parent_y = parseFloat(parent.getAttribute("cy"));
                            var child = document.getElementById(String(divnum) + "_node" + d.target);
                            if (child != null) {
                                var child_x = parseFloat(child.getAttribute("cx"));
                                var child_y = parseFloat(child.getAttribute("cy"));
                                if (parent_x - child_x == 0) {
                                    x = parent_x;
                                } else {
                                    var slope = (parent_y - child_y) / (parent_x - child_x);
                                    var intercept = parent_y - slope * parent_x;
                                    x = ((d.y - intercept) / slope);
                                }
                            } else {
                                x = 0;
                            }
                        } else {
                            x = 0;
                        }
                        return "translate(" + String(x) + "," + String(y) + ")";
                    });
            }

            function determine_label_positioning(d) {
                if (d.ts_flags & NODE_IS_RE_EVENT || d.parent_of.length == 0 || d.child_of.length == 0) {
                    return "c";
                } else if (d.child_of.length == 1) {
                    var parent = document.getElementById(String(divnum) + "_node" + d.child_of[0])
                    if (parent != null) {
                        var parent_x = parent.getAttribute("cx");
                        if (parent_x > d.x+1) {
                            return "l";
                        } else {
                            return "r";
                        }
                    } else {
                        return "r";
                    }
                } else {
                    return "r";
                }
            };

            label
                .each(function(d) {
                    var l = d3.select(this);
                    var positioning = determine_label_positioning(d);
                    var x = d.x;
                    var anchor = "middle";
                    // Find offsets from CSS
                    const cstyle = getComputedStyle(this)
                    const symbolSize = Math.sqrt(d.size);
                    const cssOffset = cstyle.getPropertyValue('--offset');
                    // default should depend on the symbol size (which is square pixels) and the font size
                    const offset = cssOffset ? parseInt(cssOffset) : symbolSize/2 + parseFloat(cstyle.fontSize)/2;
                    const cssTipoffset = cstyle.getPropertyValue('--tipoffset');
                    // default of 25 if not set: perhaps should be related to the tip symbol size?
                    const tipoffset = cssTipoffset ? parseInt(cssTipoffset) : symbolSize/2 + parseFloat(cstyle.fontSize);
                    if (positioning == "l") {
                        x = d.x - offset;
                        anchor = "end";
                    } else if (positioning == "r") {
                        x = d.x + offset;
                        anchor = "start";
                    }
                    l.attr("text-anchor", anchor);
                    l.attr("transform", function(d) {
                        // adding slightly more spacing in the y-axis when positioning is middle (c)
                        var y = d.y - offset;
                        if (positioning == "c") {
                            y = y - 3;
                        }
                        if (d.parent_of.length == 0) {
                            y = d.y + tipoffset;
                            if (positioning == "c") {
                                y = y + 3;
                            }
                        }
                        // only bother showing up to 4 d.p.
                        return "translate(" + parseFloat(x.toFixed(4)) + "," + parseFloat(y.toFixed(4)) + ")";
                    })
                });

            missing_parents_paths
                .each(function(d) {
                    var l = d3.select(this);
                    l.style("stroke-width", "4px");
                    l.style("stroke-dasharray", "5");
                    l.style("stroke", "gray");
                    l.attr("d", line([[d.x, d.y], [d.x, d.y-30]]));
                });
            
            missing_parents_texts
                .each(function(d) {
                    var l = d3.select(this);
                    l.attr("text-anchor", "middle");
                    l.attr("x", d.x);
                    l.attr("y", d.y-30);
                });

            missing_children_paths
                .each(function(d) {
                    var l = d3.select(this);
                    l.style("stroke-width", "4px");
                    l.style("stroke-dasharray", "5");
                    l.style("stroke", "gray");
                    l.attr("d", line([[d.x, d.y], [d.x, d.y+30]]));
                });
            
            missing_children_texts
                .each(function(d) {
                    var l = d3.select(this);
                    l.attr("text-anchor", "middle");
                    l.attr("x", d.x);
                    l.attr("y", d.y+40);
                });
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d3.selectAll(div_selector + " .node").classed("ref", function(j) {
                if ((edge_styles.type == "ortho") & (j.id == d.x_pos_reference)) {
                    j.fx = d.x;
                }
            });
            svg.attr("class", "no-hover");
        }

        function dragged(event, d) {
            d.fx = event.x;
            d3.selectAll(div_selector + " .node").classed("ref", function(j) {
                if ((edge_styles.type == "ortho") & (j.id == d.x_pos_reference)) {
                    j.fx = event.x;
                }
            });
        }

        function dragended(event, d) {
            svg.attr("class", null);
        }

        if (tree_highlighting) {
            
            var th_group = svg.append("g").attr("class", "tree_highlighting");
            
            var breakpoint_regions = th_group
                .append("g")
                .attr("class", "breakpoints")
                .selectAll("g")
                .data(graph.breakpoints)
                .enter()
                .append("g")
                .attr("class", d => eval(d.included) ? "included" : null)
                .attr("start", d => d.start)
                .attr("stop", d => d.stop);

            breakpoint_regions
                .append("rect")
                .attr("x", d => d.x_pos)
                .attr("y", height-60)
                .attr("width", d => d.width)
                .attr("height", 40)
                .attr("stroke", "#FFFFFF")
                .attr("stroke-width", 1)
                .attr("fill", d => eval(d.included) ? d.fill : "gray");

            breakpoint_regions
                .append("text")
                .attr("x", d => d.x_pos)
                .attr("y", height-5)
                .attr("class", "label start")
                .style("display", "none")
                .text(d => String(d.start));

            breakpoint_regions
                .append("text")
                .attr("x", d => d.x_pos + d.width)
                .attr("y", height-5)
                .attr("class", "label stop")
                .style("display", "none")
                .text(d => String(d.stop));

            breakpoint_regions
                .on('mouseover', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        if (eval(d.included)) {
                            d3.select(this).selectAll("rect")
                                .style('fill', '#1eebb1')
                                .style("cursor", "pointer");
                            d3.select(this).selectAll("text")
                                .style('display', 'block');
                            d3.selectAll(div_selector + " .endpoints")
                                .style('display', 'none'); /* hide other labels to avoid clashes */
                            var highlight_links = d3.select(div_selector + " .links")
                                .selectAll("g")
                                    .filter(function(j) {
                                        return j.bounds.split(" ").some(function(region) {
                                            region = region.split("-");
                                            return (parseFloat(region[1]) > d.start) & (parseFloat(region[0]) < d.stop)
                                        });
                                    });
                            highlight_links.raise();
                            highlight_links
                                .select(".link")
                                .style("stroke", "#1eebb1");
                        }
                    }
                })
                .on('mouseout', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        if (eval(d.included)) {
                            d3.select(this).selectAll("rect")
                                .style('fill', d.fill)
                                .style("cursor", "default");
                            d3.select(this).selectAll("text")
                                .style('display', 'none');
                            d3.selectAll(div_selector + " .endpoints")
                                .style('display', 'block');
                            d3.selectAll(div_selector + " .link")
                                .style("stroke", d => d.stroke);
                        }
                    }
                });
            
            var endpoints = th_group.append("g").attr("class", "endpoints");
            
            endpoints
                .append("text")
                    .attr("class", "label")
                    .style("text-anchor", "start")
                    .text(graph.breakpoints[0].start)
                    .attr("x", graph.breakpoints[0].x_pos)
                    .attr("y", height-5);
            
            endpoints
                .append("text")
                    .attr("class", "label")
                    .style("text-anchor", "end")
                    .text(graph.breakpoints[graph.breakpoints.length-1].stop)
                    .attr("x", width)
                    .attr("y", height-5);

            var mutation_data = graph.mutations;
            if (condense_mutations) { /* explode the graph.mutations df into one row per mut */
                mutation_data = [];
                graph.mutations.forEach(function(d) {
                    d.mutation_id.forEach(function(x, i) {
                        mutation_data.push({
                            mutation_id: x,
                            site_id: d.site_id[i],
                            edge: d.edge,
                            fill: d.fill,
                            x_pos: d.x_pos[i], 
                            position: d.position[i]
                        });
                    });
                });
            };

            var mutation_data = graph.mutations;
            if (condense_mutations) { /* explode the graph.mutations df into one row per mut */
                mutation_data = [];
                graph.mutations.forEach(function(d) {
                    d.mutation_id.forEach(function(x, i) {
                        mutation_data.push({
                            mutation_id: x,
                            site_id: d.site_id[i],
                            edge: d.edge,
                            fill: d.fill,
                            x_pos: d.x_pos[i], 
                            position: d.position[i]
                        });
                    });
                });
            };

            var site_pos = th_group
                .append("g")
                .attr("class", "sites")
                .selectAll("line")
                .data(mutation_data)  /* NB: one per mutation to allow different line colors */
                .data(mutation_data)  /* NB: one per mutation to allow different line colors */
                .enter()
                .append("g")
                .attr("class", d => "s" + d.site_id + " " + "e" + d.edge + " " + "m" + d.mutation_id)
                .attr("class", d => "s" + d.site_id + " " + "e" + d.edge + " " + "m" + d.mutation_id)
                .attr("transform", d => "translate(" + d.x_pos + "," + (height-60) + ")")
                .style("display", "none");

            function createSiteLine(selection) {
                return selection
                    .append("line")
                    .attr("y1", -5)
                    .attr("y2", 40+5)
                    .style("stroke-width", 3)
                    .style("fill", "none");
            }
                  
            function createSiteText(selection) {
                return selection
                    .append("text")
                    .attr("y", -8)  /* above the tick */
                    .attr("class", "label");
            }
            
            site_pos
                .each(function(d) {
                    const select = d3.select(this);
                    createSiteLine(select)
                        .style("stroke", d.fill);
                    createSiteText(select)
                        .text(String(d.position));
                });
            
            /*
            var mut_text = mut_pos
                .append("text")
                .attr("text-anchor", function(d) {
                    if (d.x_pos > (width*9/10)) {
                        return "end";
                    } else if (d.x_pos < width*1/10) {
                        return "start";
                    } else {
                        return "middle";
                    }
                })
                .style("font-size", "10px")
                .style("font-family", "Arial")
                .attr("fill", d => d.fill)
                .attr("transform", d => "translate(" + String(d.x_pos) + "," + String(height-60-10) + ")");
        
            mut_text
                .text(function(d) {
                    if (label_mutations) {
                        return String(d.site_id) + ":" + String(d.position);
                    } else {
                        return d.label;
                    }
                });
            */
        }

        if (title != "None") {
            svg.append("text")
                .style("font-size", "20px")
                .attr("x", width / 2)
                .attr("text-anchor", "middle")
                .attr("y", 30)
                .each(function() { 
                    multi_line_text.call(this, title, true); 
                });
        }
    }

    draw_force_diagram()
}

/* NB: the code below fires up the visualizer: templates in this call
    can be used to pass in the appropriate data
*/

ensureRequire()
    .then(require => {
        require.config({ paths: {d3: 'https://d3js.org/d3.v7.min'}});
        require(["d3"], function(d3) {
            main_visualizer(d3, 7194715985, {"nodes": [{"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 0, "ts_flags": 1, "time": 0.0, "child_of": [11], "parent_of": [], "x_pos_reference": -1, "label": "0", "fx": 150.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 1, "ts_flags": 1, "time": 0.0, "child_of": [6], "parent_of": [], "x_pos_reference": -1, "label": "1", "fx": 290.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 2, "ts_flags": 1, "time": 0.0, "child_of": [11], "parent_of": [], "x_pos_reference": -1, "label": "2", "fx": 220.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 3, "ts_flags": 1, "time": 0.0, "child_of": [6], "parent_of": [], "x_pos_reference": -1, "label": "3", "fx": 360.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 4, "ts_flags": 1, "time": 0.0, "child_of": [10], "parent_of": [], "x_pos_reference": -1, "label": "4", "fx": 500.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 5, "ts_flags": 1, "time": 0.0, "child_of": [7], "parent_of": [], "x_pos_reference": -1, "label": "5", "fx": 430.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 6, "ts_flags": 0, "time": 56.0454802286223, "child_of": [9], "parent_of": [1, 3], "x_pos_reference": -1, "label": "6", "x": 325.0, "fy": 227.77777777777777, "y": 227.77777777777777}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 7, "ts_flags": 131072, "time": 59.45059299910596, "child_of": [9, 10], "parent_of": [5], "x_pos_reference": 5, "label": "7/8", "x": 325.0, "fy": 205.55555555555557, "y": 205.55555555555557}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 9, "ts_flags": 0, "time": 120.7850821708138, "child_of": [12], "parent_of": [6, 7], "x_pos_reference": -1, "label": "9", "x": 325.0, "fy": 183.33333333333334, "y": 183.33333333333334}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 10, "ts_flags": 0, "time": 142.86643656492956, "child_of": [12], "parent_of": [4, 7], "x_pos_reference": -1, "label": "10", "x": 325.0, "fy": 161.11111111111111, "y": 161.11111111111111}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 11, "ts_flags": 0, "time": 236.7237255340037, "child_of": [15], "parent_of": [0, 2], "x_pos_reference": -1, "label": "11", "x": 325.0, "fy": 138.88888888888889, "y": 138.88888888888889}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 12, "ts_flags": 0, "time": 272.05118690557765, "child_of": [13], "parent_of": [9, 10], "x_pos_reference": -1, "label": "12", "x": 325.0, "fy": 116.66666666666667, "y": 116.66666666666667}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 13, "ts_flags": 131072, "time": 588.0902773240502, "child_of": [15, 16], "parent_of": [12], "x_pos_reference": 12, "label": "13/14", "x": 325.0, "fy": 94.44444444444446, "y": 94.44444444444446}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 15, "ts_flags": 0, "time": 610.912738605865, "child_of": [16], "parent_of": [11, 13], "x_pos_reference": -1, "label": "15", "x": 325.0, "fy": 72.22222222222223, "y": 72.22222222222223}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 16, "ts_flags": 0, "time": 1382.4658244607965, "child_of": [], "parent_of": [13, 15], "x_pos_reference": -1, "label": "16", "x": 325.0, "fy": 50.0, "y": 50.0}], "links": [{"id": 0, "source": 6, "source_time": 56.0454802286223, "target": 1, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 3, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 1, "source": 6, "source_time": 56.0454802286223, "target": 3, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 1, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 2, "source": 7, "source_time": 59.45059299910596, "target": 5, "target_time": 0.0, "bounds": "0.0-6516.940179280937 6516.940179280937-10000.0", "alt_parent": -1, "alt_child": -1, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 3, "source": 9, "source_time": 120.7850821708138, "target": 6, "target_time": 56.0454802286223, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 7, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 4, "source": 9, "source_time": 120.7850821708138, "target": 7, "target_time": 59.45059299910596, "bounds": "6516.940179280937-10000.0", "alt_parent": 10, "alt_child": 6, "region_fraction": 0.34830598207190633, "stroke": "#053e4e"}, {"id": 5, "source": 10, "source_time": 142.86643656492956, "target": 4, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 7, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 6, "source": 10, "source_time": 142.86643656492956, "target": 7, "target_time": 59.45059299910596, "bounds": "0.0-6516.940179280937", "alt_parent": 9, "alt_child": 4, "region_fraction": 0.6516940179280937, "stroke": "#053e4e"}, {"id": 7, "source": 11, "source_time": 236.7237255340037, "target": 0, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 2, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 8, "source": 11, "source_time": 236.7237255340037, "target": 2, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 0, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 9, "source": 12, "source_time": 272.05118690557765, "target": 9, "target_time": 120.7850821708138, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 10, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 10, "source": 12, "source_time": 272.05118690557765, "target": 10, "target_time": 142.86643656492956, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 9, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 11, "source": 13, "source_time": 588.0902773240502, "target": 12, "target_time": 272.05118690557765, "bounds": "0.0-2601.014547981321 2601.014547981321-10000.0", "alt_parent": -1, "alt_child": -1, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 12, "source": 15, "source_time": 610.912738605865, "target": 11, "target_time": 236.7237255340037, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 13, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 13, "source": 15, "source_time": 610.912738605865, "target": 13, "target_time": 588.0902773240502, "bounds": "2601.014547981321-10000.0", "alt_parent": 16, "alt_child": 11, "region_fraction": 0.7398985452018679, "stroke": "#053e4e"}, {"id": 14, "source": 16, "source_time": 1382.4658244607965, "target": 13, "target_time": 588.0902773240502, "bounds": "0.0-2601.014547981321", "alt_parent": 15, "alt_child": 15, "region_fraction": 0.26010145479813207, "stroke": "#053e4e"}, {"id": 15, "source": 16, "source_time": 1382.4658244607965, "target": 15, "target_time": 610.912738605865, "bounds": "0.0-2601.014547981321", "alt_parent": -1, "alt_child": 13, "region_fraction": 0.26010145479813207, "stroke": "#053e4e"}], "mutations": [], "breakpoints": [{"id": 0, "start": 0.0, "stop": 2601.014547981321, "x_pos_01": 0.0, "width_01": 0.26010145479813207, "fill": "#053e4e", "x_pos": 100.0, "width": 117.04565465915942, "included": "true"}, {"id": 1, "start": 2601.014547981321, "stop": 6516.940179280937, "x_pos_01": 0.26010145479813207, "width_01": 0.3915925631299616, "fill": "#053e4e", "x_pos": 217.04565465915942, "width": 176.21665340848273, "included": "true"}, {"id": 2, "start": 6516.940179280937, "stop": 10000.0, "x_pos_01": 0.6516940179280937, "width_01": 0.34830598207190633, "fill": "#053e4e", "x_pos": 393.26230806764215, "width": 156.73769193235785, "included": "true"}], "evenly_distributed_positions": [150.0, 220.0, 290.0, 360.0, 430.0, 500.0]}, 550, 375, {"title": "Time ago (generations)", "units": "generations", "include_labels": "true", "ticks": [250.0, 227.77777777777777, 205.55555555555557, 183.33333333333334, 161.11111111111111, 138.88888888888889, 116.66666666666667, 94.44444444444446, 72.22222222222223, 50.0], "text": [0, 56, 59, 121, 143, 237, 272, 588, 611, 1382], "max_min": [250.0, 50.0], "scale": "rank"}, {"type": "ortho", "variable_width": false, "include_underlink": true}, false, false, true, null, false, "full", null, "{\"data\": {\"nodes\": [{\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 0, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [11], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"0\", \"fx\": 150.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 1, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [6], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"1\", \"fx\": 290.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 2, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [11], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"2\", \"fx\": 220.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 3, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [6], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"3\", \"fx\": 360.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 4, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [10], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"4\", \"fx\": 500.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 5, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [7], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"5\", \"fx\": 430.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 6, \"ts_flags\": 0, \"time\": 56.0454802286223, \"child_of\": [9], \"parent_of\": [1, 3], \"x_pos_reference\": -1, \"label\": \"6\", \"x\": 325.0, \"fy\": 227.77777777777777, \"y\": 227.77777777777777}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 7, \"ts_flags\": 131072, \"time\": 59.45059299910596, \"child_of\": [9, 10], \"parent_of\": [5], \"x_pos_reference\": 5, \"label\": \"7/8\", \"x\": 325.0, \"fy\": 205.55555555555557, \"y\": 205.55555555555557}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 9, \"ts_flags\": 0, \"time\": 120.7850821708138, \"child_of\": [12], \"parent_of\": [6, 7], \"x_pos_reference\": -1, \"label\": \"9\", \"x\": 325.0, \"fy\": 183.33333333333334, \"y\": 183.33333333333334}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 10, \"ts_flags\": 0, \"time\": 142.86643656492956, \"child_of\": [12], \"parent_of\": [4, 7], \"x_pos_reference\": -1, \"label\": \"10\", \"x\": 325.0, \"fy\": 161.11111111111111, \"y\": 161.11111111111111}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 11, \"ts_flags\": 0, \"time\": 236.7237255340037, \"child_of\": [15], \"parent_of\": [0, 2], \"x_pos_reference\": -1, \"label\": \"11\", \"x\": 325.0, \"fy\": 138.88888888888889, \"y\": 138.88888888888889}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 12, \"ts_flags\": 0, \"time\": 272.05118690557765, \"child_of\": [13], \"parent_of\": [9, 10], \"x_pos_reference\": -1, \"label\": \"12\", \"x\": 325.0, \"fy\": 116.66666666666667, \"y\": 116.66666666666667}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 13, \"ts_flags\": 131072, \"time\": 588.0902773240502, \"child_of\": [15, 16], \"parent_of\": [12], \"x_pos_reference\": 12, \"label\": \"13/14\", \"x\": 325.0, \"fy\": 94.44444444444446, \"y\": 94.44444444444446}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 15, \"ts_flags\": 0, \"time\": 610.912738605865, \"child_of\": [16], \"parent_of\": [11, 13], \"x_pos_reference\": -1, \"label\": \"15\", \"x\": 325.0, \"fy\": 72.22222222222223, \"y\": 72.22222222222223}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 16, \"ts_flags\": 0, \"time\": 1382.4658244607965, \"child_of\": [], \"parent_of\": [13, 15], \"x_pos_reference\": -1, \"label\": \"16\", \"x\": 325.0, \"fy\": 50.0, \"y\": 50.0}], \"links\": [{\"id\": 0, \"source\": 6, \"source_time\": 56.0454802286223, \"target\": 1, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 3, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 1, \"source\": 6, \"source_time\": 56.0454802286223, \"target\": 3, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 1, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 2, \"source\": 7, \"source_time\": 59.45059299910596, \"target\": 5, \"target_time\": 0.0, \"bounds\": \"0.0-6516.940179280937 6516.940179280937-10000.0\", \"alt_parent\": -1, \"alt_child\": -1, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 3, \"source\": 9, \"source_time\": 120.7850821708138, \"target\": 6, \"target_time\": 56.0454802286223, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 7, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 4, \"source\": 9, \"source_time\": 120.7850821708138, \"target\": 7, \"target_time\": 59.45059299910596, \"bounds\": \"6516.940179280937-10000.0\", \"alt_parent\": 10, \"alt_child\": 6, \"region_fraction\": 0.34830598207190633, \"stroke\": \"#053e4e\"}, {\"id\": 5, \"source\": 10, \"source_time\": 142.86643656492956, \"target\": 4, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 7, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 6, \"source\": 10, \"source_time\": 142.86643656492956, \"target\": 7, \"target_time\": 59.45059299910596, \"bounds\": \"0.0-6516.940179280937\", \"alt_parent\": 9, \"alt_child\": 4, \"region_fraction\": 0.6516940179280937, \"stroke\": \"#053e4e\"}, {\"id\": 7, \"source\": 11, \"source_time\": 236.7237255340037, \"target\": 0, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 2, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 8, \"source\": 11, \"source_time\": 236.7237255340037, \"target\": 2, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 0, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 9, \"source\": 12, \"source_time\": 272.05118690557765, \"target\": 9, \"target_time\": 120.7850821708138, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 10, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 10, \"source\": 12, \"source_time\": 272.05118690557765, \"target\": 10, \"target_time\": 142.86643656492956, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 9, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 11, \"source\": 13, \"source_time\": 588.0902773240502, \"target\": 12, \"target_time\": 272.05118690557765, \"bounds\": \"0.0-2601.014547981321 2601.014547981321-10000.0\", \"alt_parent\": -1, \"alt_child\": -1, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 12, \"source\": 15, \"source_time\": 610.912738605865, \"target\": 11, \"target_time\": 236.7237255340037, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 13, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 13, \"source\": 15, \"source_time\": 610.912738605865, \"target\": 13, \"target_time\": 588.0902773240502, \"bounds\": \"2601.014547981321-10000.0\", \"alt_parent\": 16, \"alt_child\": 11, \"region_fraction\": 0.7398985452018679, \"stroke\": \"#053e4e\"}, {\"id\": 14, \"source\": 16, \"source_time\": 1382.4658244607965, \"target\": 13, \"target_time\": 588.0902773240502, \"bounds\": \"0.0-2601.014547981321\", \"alt_parent\": 15, \"alt_child\": 15, \"region_fraction\": 0.26010145479813207, \"stroke\": \"#053e4e\"}, {\"id\": 15, \"source\": 16, \"source_time\": 1382.4658244607965, \"target\": 15, \"target_time\": 610.912738605865, \"bounds\": \"0.0-2601.014547981321\", \"alt_parent\": -1, \"alt_child\": 13, \"region_fraction\": 0.26010145479813207, \"stroke\": \"#053e4e\"}], \"mutations\": [], \"breakpoints\": [{\"id\": 0, \"start\": 0.0, \"stop\": 2601.014547981321, \"x_pos_01\": 0.0, \"width_01\": 0.26010145479813207, \"fill\": \"#053e4e\", \"x_pos\": 100.0, \"width\": 117.04565465915942, \"included\": \"true\"}, {\"id\": 1, \"start\": 2601.014547981321, \"stop\": 6516.940179280937, \"x_pos_01\": 0.26010145479813207, \"width_01\": 0.3915925631299616, \"fill\": \"#053e4e\", \"x_pos\": 217.04565465915942, \"width\": 176.21665340848273, \"included\": \"true\"}, {\"id\": 2, \"start\": 6516.940179280937, \"stop\": 10000.0, \"x_pos_01\": 0.6516940179280937, \"width_01\": 0.34830598207190633, \"fill\": \"#053e4e\", \"x_pos\": 393.26230806764215, \"width\": 156.73769193235785, \"included\": \"true\"}], \"evenly_distributed_positions\": [150.0, 220.0, 290.0, 360.0, 430.0, 500.0]}, \"width\": 550, \"height\": 375, \"y_axis\": {\"title\": \"Time ago (generations)\", \"units\": \"generations\", \"include_labels\": \"true\", \"ticks\": [250.0, 227.77777777777777, 205.55555555555557, 183.33333333333334, 161.11111111111111, 138.88888888888889, 116.66666666666667, 94.44444444444446, 72.22222222222223, 50.0], \"text\": [0, 56, 59, 121, 143, 237, 272, 588, 611, 1382], \"max_min\": [250.0, 50.0], \"scale\": \"rank\"}, \"edges\": {\"type\": \"ortho\", \"variable_width\": false, \"include_underlink\": true}, \"condense_mutations\": false, \"label_mutations\": false, \"tree_highlighting\": true, \"rotate_tip_labels\": false, \"plot_type\": \"full\", \"default_node_style\": {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4}, \"title\": null, \"preamble\": null, \"save_filename\": \"tskit_arg_visualizer\"}", "tskit_arg_visualizer")
        });
    })
    .catch(err => console.error('Failed to load require.js:', err));

</script></div></div>
</div>
</section>
<section id="local-trees-and-arity">
<h3>Local trees and arity<a class="headerlink" href="#local-trees-and-arity" title="Link to this heading">#</a></h3>
<p>Below is a plot of the equivalent local trees in the ARG above,
colouring recombination nodes in red and common
ancestor nodes (unlabelled) in blue.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the recombination nodes in red, with a horizontal line at the time of occurrence,</span>
<span class="c1"># and only label nodes that are samples or recombination nodes.</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ts_arg</span><span class="o">.</span><span class="n">samples</span><span class="p">())</span>
<span class="n">re_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">ts_arg</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">nd</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">msprime</span><span class="o">.</span><span class="n">NODE_IS_RE_EVENT</span><span class="p">)</span>
<span class="n">ca_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ts_arg</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">))</span> <span class="o">-</span> <span class="n">re_nodes</span> <span class="o">-</span> <span class="n">samples</span>
<span class="n">re_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">ts_arg</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">nd</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">msprime</span><span class="o">.</span><span class="n">NODE_IS_RE_EVENT</span><span class="p">]</span>
<span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;.y-axis .grid {stroke: #ff000033} .mut .sym {stroke: goldenrod}&quot;</span>
<span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">re_nodes</span><span class="p">:</span>
    <span class="n">style</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;.n</span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="s2"> &gt; .sym </span><span class="se">{{</span><span class="s2">fill: red</span><span class="se">}}</span><span class="s2">&quot;</span>
<span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">ca_nodes</span><span class="p">:</span>
    <span class="n">style</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;.n</span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="s2"> &gt; .sym </span><span class="se">{{</span><span class="s2">fill: blue</span><span class="se">}}</span><span class="s2">&quot;</span>
<span class="n">ts_arg</span><span class="o">.</span><span class="n">draw_svg</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="n">y_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">y_ticks</span><span class="o">=</span><span class="n">re_times</span><span class="p">,</span>
    <span class="n">y_gridlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
    <span class="n">mutation_labels</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">node_labels</span><span class="o">=</span><span class="p">{</span><span class="n">u</span><span class="p">:</span> <span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">samples</span> <span class="o">|</span> <span class="n">re_nodes</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/b52024328f3851ded3ce9d0be0498e8c4cf76e006fdb545554e51d15cee4d215.svg" src="_images/b52024328f3851ded3ce9d0be0498e8c4cf76e006fdb545554e51d15cee4d215.svg" />
</div>
</div>
<p>The number of children descending from a node in a local tree can be termed the
“local arity” of that node. It is clear from the plot above that red nodes always
have a local arity of 1, and blue nodes sometimes do. This may seem an unusual
state of affairs: tree representations often focus on branch-points, and ignore nodes
with a single child. Indeed, it is possible to <a class="reference internal" href="#sec-args-simplification"><span class="std std-ref">simplify</span></a> the
ARG above, resulting in a graph whose local trees only contain branch points or tips
(i.e. local arity is never 1). Such a graph is <a class="reference internal" href="#sec-args-disadvantages"><span class="std std-ref">more compact</span></a>
than the full ARG, but it omits some information about the timings and
topological operations associated with recombination
events and some common ancestor events. This information, as captured by the local
unary nodes, is useful for</p>
<ol class="arabic simple">
<li><p>Retaining precise information about the time and lineages involved in recombination.
This is required e.g. to ensure we can always work out the tree editing (or
<a class="reference internal" href="terminology_and_concepts.html#sec-concepts-sprs"><span class="std std-ref">subtree-prune-and-regraft (SPR)</span></a>) moves
required to change one local tree into another as you move along the genome.</p></li>
<li><p>Calculating the likelihood of an full ARG under a specific model of evolution
(most commonly, the neutral coalescent with recombination, or CwR, as modelled e.g. by
<a class="reference external" href="https://doi.org/10.1016/0040-5809(83)90013-8">Hudson (1983)</a>)</p></li>
</ol>
<section id="sprs-and-recombination">
<span id="sec-args-sprs"></span><h4>SPRs and recombination<a class="headerlink" href="#sprs-and-recombination" title="Link to this heading">#</a></h4>
<p>The location of the recombination nodes in the trees above imply that the
<em>recombination events</em> happened ~588 and ~59 generations ago. The older one,
at 588 generations, involved node
13 (to the left of position 2601.01) and node 14 (to the right). As well as narrowing
down the recombination event to a specific point in time, the position of these two
nodes tells us that the SPR to convert the first into the second tree
involves pruning the branch above samples 1, 3, 4, and 5 and regrafting it onto the
branch above samples 0 and 2, rather than the other way around. Note that this
particular recombination does not change the <em>topology</em> of the tree, but simply the
branch lengths.</p>
<p>The recombination event 59 generations ago involved nodes 7 and 8, with the crossover
ocurring at position 6516.94. The SPR operation which converts the middle tree into the
last one involves pruning the branch above sample node 5 and regrafting it onto the
branch above the common ancestor of 1 and 3. In this case, the recombination has led to
a change in topology, such that the closest relative of 5 is node 4 from positions 0
to 6516.94, but 1 and 3 from positions 6516.94 to 10,000.</p>
</section>
</section>
<section id="calculating-likelihoods">
<span id="sec-args-likelihoods"></span><h3>Calculating likelihoods<a class="headerlink" href="#calculating-likelihoods" title="Link to this heading">#</a></h3>
<p>Because our ARG above was generated under the standard Hudson model (e.g. neutral
evolution in a large population with unique recombination breakpoints along a continuous
genome), we can calculate its likelihood under that model, for a given recombination
rate and population size, using the <a class="reference external" href="https://tskit.dev/msprime/docs/stable/api.html#msprime.log_arg_likelihood" title="(in Project name not set)"><code class="docutils literal notranslate"><span class="pre">msprime.log_arg_likelihood()</span></code></a> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Log likelihood of the genealogy under the Hudson model:&quot;</span><span class="p">,</span>
    <span class="n">msprime</span><span class="o">.</span><span class="n">log_arg_likelihood</span><span class="p">(</span>
        <span class="n">ts_arg</span><span class="p">,</span>
        <span class="n">recombination_rate</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;recombination_rate&quot;</span><span class="p">],</span>
        <span class="n">Ne</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;population_size&quot;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Log likelihood of the genealogy under the Hudson model: -89.68606886284756
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This likelihood calculation is tied to the specific <code class="docutils literal notranslate"><span class="pre">tskit</span></code> representation of the ARG that
is output by the <code class="docutils literal notranslate"><span class="pre">msprime</span></code> simulator. In particular, it expects each recombination event to
correspond to two recombination nodes, which allows so-called “diamond” events to be
represented, in which both parents at a recombination event trace directly back to the
same common ancestor.</p>
</div>
</section>
</section>
<section id="simplification">
<span id="sec-args-simplification"></span><h2>Simplification<a class="headerlink" href="#simplification" title="Link to this heading">#</a></h2>
<p>If we fully <a class="reference internal" href="simplification.html#sec-simplification"><span class="std std-ref">simplify</span></a> the tree above, all remaining nodes
(apart from the samples) will have a local arity greater than one.
This loses information about the timings of recombination and non-coalescent
common ancestry, but it still keeps the local tree structure intact:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts_arg</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
<span class="n">ts</span><span class="o">.</span><span class="n">draw_svg</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="n">y_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">node_labels</span><span class="o">=</span><span class="p">{</span><span class="n">u</span><span class="p">:</span> <span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">samples</span><span class="p">()},</span>
    <span class="n">mutation_labels</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;.mut .sym {stroke: goldenrod}&quot;</span><span class="p">,</span>
    <span class="n">y_ticks</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="o">*</span><span class="mi">500</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/445336e191a172125ccfb8f4af2c70a335ea0dd2b63846e50146cc3f04705ac2.svg" src="_images/445336e191a172125ccfb8f4af2c70a335ea0dd2b63846e50146cc3f04705ac2.svg" />
</div>
</div>
<p>Note that all recombination nodes have been lost from this graph; the effects of recombination
are instead reflected in more recent coalescent nodes that are recombinant decendants of the
original recombination nodes. This results in graph nodes which simultanousely have
multiple children and multiple parents. Graphs with such nodes are unsuited to
the “ortho” style of
graph plotting. Instead, we can plot the tree sequence graph using diagonal lines:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d3graph</span> <span class="o">=</span> <span class="n">tskit_arg_visualizer</span><span class="o">.</span><span class="n">D3ARG</span><span class="o">.</span><span class="n">from_ts</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
<span class="n">d3graph</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">sample_order</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>.d3arg {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: white;
    padding: 20px 20px 60px 20px;
}

.d3arg:hover .dashboard {
    visibility: visible;
}

.d3arg .dashboard {
    display: flex;
    visibility: hidden;
}

.d3arg .dashboard .dashbutton {
    position: relative;
    font-size: 30px;
    border: 0px;
    background-color: white;
    width: 30px;
    height: 30px;
}

.d3arg .dashboard .dashbutton .tip {
    width: 150px;
    font-size: 12px;
    background-color: lightgrey;
    color: #053e4e;
    text-align: center;
    padding: 5px 0px;
    position: absolute;
    z-index: 1;
    top: 100%;
    left: 50%; 
    margin-left: -60px;
    visibility: hidden;
}

.d3arg .dashboard .dashbutton:hover .desc {
    visibility: visible;
}

.d3arg .dashboard path {
    fill: grey;
}

.d3arg .dashboard .dashbutton:hover path {
    fill: #053e4e;
}

.d3arg .dashboard .activecolor:active path {
    fill: #1eebb1;
}

.d3arg .savemethods, .d3arg .labelmethods {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: row;
    flex-wrap: wrap;
}

.d3arg .savemethods button, .d3arg .labelmethods button {
    background-color: lightgrey;
    color: #053e4e;
    font-size: 12px;
    width: auto;
    border: none;
}

.d3arg .savemethods button:hover, .d3arg .labelmethods button:hover {
    color: #1eebb1;
}

.d3arg .labelmethods button.node-labels-default {
    text-decoration: underline;
}

.d3arg .yaxis path {
    stroke: #053e4e;
    stroke-width: 3px;
}

.d3arg .yaxis line {
    stroke: #053e4e;
    stroke-width: 3px;
}

.d3arg .yaxis text {
    fill: #053e4e;
    stroke: 1px;
}

.d3arg .hiddennode {
    fill: lightgrey;
    stroke: lightgrey;
    stroke-width: 4px;
}

.d3arg .underlink {
    stroke: #ffffff;
    stroke-width: 12px;
    fill: none;
}

.d3arg .hiddenlink {
    stroke: lightgrey;
    stroke-width: 4px;
    fill: none;
}

.d3arg .labels {
    text-anchor: middle;
}

.d3arg .label {
    fill: #053e4e;
    font-family: Arial;
    font-size: 12px;
}

.d3arg .label.start {
    text-anchor: start;
}

.d3arg .label.stop {
    text-anchor: end;
}

.d3arg .hiddenlabel {
    fill: lightgrey;
    font-family: Arial;
    font-size: 12px;
}

.d3arg svg {
    display: block;
}

.d3arg button {
    display: block;
    cursor: pointer;
}

.d3arg .saving {
    display: flex;
    flex-direction: row;
}

.d3arg .saving .message {
    display: none;
}

.d3arg .tooltip {
    position: absolute;
    max-width: 500px;
    padding: 10px;
    background-color: white;
    color: black;
    text-align: center;
    z-index: 9999;
}

.d3arg .sites text {
    text-anchor: middle;
}</style><div id="arg_1538751721" class="d3arg" style="min-width:590.0px; min-height:455.0px;"></div><script>function parseRgbString(rgbString) {
  const match = rgbString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
  if (match) {
    const r = parseInt(match[1]);
    const g = parseInt(match[2]);
    const b = parseInt(match[3]);
    const a = match[4] ? parseFloat(match[4]) : 1; // Default alpha to 1 if not present
    return { r, g, b, a };
  }
  return null; // Or throw an error for invalid format
}

function ensureRequire() {
    // Needed e.g. in Jupyter notebooks: if require is already available, return resolved promise
    if (typeof require !== 'undefined') {
        return Promise.resolve(require);
    }

    // Otherwise, dynamically load require.js
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js';
        script.onload = () => resolve(require);
        script.onerror = reject;
        document.head.appendChild(script);
    });
};

function main_visualizer(
    d3,
    divnum,
    graph,
    width,
    height,
    y_axis,
    edge_styles,
    condense_mutations,
    label_mutations,
    tree_highlighting,
    title,
    rotate_tip_labels,
    plot_type,
    preamble,
    source,
    filename_for_saving,
) {
    /*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
    
    function download (url, name, opts) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', url)
        xhr.responseType = 'blob'
        xhr.onload = function () {
            saveAs(xhr.response, name, opts)
        }
        xhr.onerror = function () {
            console.error('could not download file')
        }
        xhr.send()
    }
    
    function corsEnabled (url) {
        var xhr = new XMLHttpRequest()
        // use sync to avoid popup blocker
        xhr.open('HEAD', url, false)
        try {
            xhr.send()
        } catch (e) {}
        return xhr.status >= 200 && xhr.status <= 299
    }
    
    // 'a.click()' doesn't work for all browsers (#465)
    function click (node) {
        try {
            node.dispatchEvent(new MouseEvent('click'))
        } catch (e) {
            var evt = document.createEvent('MouseEvents')
            evt.initMouseEvent('click', true, true, window, 0, 0, 0, 80,
                                20, false, false, false, false, 0, null)
            node.dispatchEvent(evt)
        }
    }
    
    function saveAs (blob, name, opts) {
        var URL = URL || webkitURL
        // Namespace is used to prevent conflict w/ Chrome Poper Blocker extension (Issue #561)
        var a = document.createElementNS('http://www.w3.org/1999/xhtml', 'a')
        name = name || blob.name || 'download'

        a.download = name
        a.rel = 'noopener' // tabnabbing

        // TODO: detect chrome extensions & packaged apps
        // a.target = '_blank'

        if (typeof blob === 'string') {
            // Support regular links
            a.href = blob
            if (a.origin !== location.origin) {
            corsEnabled(a.href)
                ? download(blob, name, opts)
                : click(a, a.target = '_blank')
            } else {
            click(a)
            }
        } else {
            // Support blobs
            a.href = URL.createObjectURL(blob)
            setTimeout(function () { URL.revokeObjectURL(a.href) }, 4E4) // 40s
            setTimeout(function () { click(a) }, 0)
        }
    }

    const NODE_IS_SAMPLE = 1;
    const NODE_IS_RE_EVENT = 131072;
    var line = d3.line();
    var step = d3.line().curve(d3.curveStep);
    var stepAfter = d3.line().curve(d3.curveStepAfter);
    var stepBefore = d3.line().curve(d3.curveStepBefore);


    // https://gist.github.com/Rokotyan/0556f8facbaf344507cdc45dc3622177
    // Below are the functions that handle actual exporting:
    // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
    function getSVGString( svgNode ) {
        svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
        var cssStyleText = getCSSStyles();
        appendCSS( cssStyleText, svgNode );
        var serializer = new XMLSerializer();
        var svgString = serializer.serializeToString(svgNode);
        svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
        svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix
        return svgString;

        function getCSSStyles() {
            // Extract CSS Rules
            var extractedCSSText = "";
            for (var i = 0; i < document.styleSheets.length; i++) { // this could be improved as it loops through all stylings on page
                var s = document.styleSheets[i];
                try {
                    if(!s.cssRules) continue;
                } catch( e ) {
                    if(e.name !== 'SecurityError') throw e; // for Firefox
                    continue;
                }
                var cssRules = s.cssRules;
                for (var r = 0; r < cssRules.length; r++) {
                    extractedCSSText += cssRules[r].cssText.replace(".d3arg ", ""); // removing reference to d3arg
                }
            }
            return extractedCSSText;

        }

        function appendCSS( cssText, element ) {
            var styleElement = document.createElement("style");
            styleElement.setAttribute("type","text/css"); 
            styleElement.innerHTML = cssText;
            var refNode = element.hasChildNodes() ? element.children[0] : null;
            element.insertBefore( styleElement, refNode );
        }
    }


    function svgString2Image( svgString, width, height, format, callback ) {
        var format = format ? format : 'png';
        var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL
        var canvas = document.createElement("canvas");
        var context = canvas.getContext("2d");
        canvas.width = width;
        canvas.height = height;
        var image = new Image();
        image.onload = function() {
            context.clearRect ( 0, 0, width, height);
            context.drawImage(image, 0, 0, width, height);
            canvas.toBlob( function(blob) {
                var filesize = Math.round( blob.length/1024 ) + ' KB';
                if ( callback ) callback( blob, filesize );
            });
        };
        image.src = imgsrc;
    }

    function draw_force_diagram() {
        var evenly_distributed_positions = graph.evenly_distributed_positions;
        var div_selector = "#arg_" + String(divnum);
        if (preamble) {
            d3.select(div_selector).html(preamble);
        }
        var tip = d3.select(div_selector).append("div")
            .attr("class", "tooltip")
            .style("display", "none");

        var dashboard = d3.select(div_selector).append("div").attr("class", "dashboard");
        
        var saving = dashboard.append("button").attr("class", "dashbutton");
        saving.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .attr("viewBox", "0 0 512 512")
            .append("path")
            .attr("d", "M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z");
        var saving_methods = saving.append("span").attr("class", "tip desc");
        var methods = saving_methods.append("div").text("Download As:").append("div").attr("class", "savemethods")

        methods.append("button").text("JSON")
            .on("click", function() {
                d3.selectAll(div_selector + " .node").classed("fix", function(d) {
                    d.fx = d.x;
                });
                src = JSON.parse(source);
                src.data.nodes = graph.nodes;
                var textBlob = new Blob([JSON.stringify(src)], {type: "text/plain"});
                saveAs(textBlob, filename_for_saving + ".json");
            });
        methods.append("button").text("SVG")
            .on('click', function(){
                var svgString = getSVGString(svg.node());
                var svgBlob = new Blob([svgString], {type:"image/svg+xml;charset=utf-8"});
                saveAs(svgBlob, filename_for_saving);
            });
        methods.append("button").text("PNG")
            .on('click', function(){
                var svgString = getSVGString(svg.node());
                svgString2Image(svgString, 2*width, 2*height, 'png', save); // passes Blob and filesize String to the callback
            
                function save(dataBlob){
                    saveAs(dataBlob, filename_for_saving); // FileSaver.js function
                }
            });
        
        /*
        methods.append("button").text("HTML")
            .on("click", function(){
                d3.selectAll(div_selector + " .node").classed("fix", function(d) {
                    d.fx = d.x;
                });
                var html = document.querySelector("html").outerHTML;
                var arg_div = document.getElementById(div_selector).innerHTML;
                console.log(arg_div);
                html = html.replace(arg_div, "");
                html = html.replace(source.match(/'nodes': .*'links'/), "'nodes': " + JSON.stringify(graph.nodes) + ", 'links'")
                saveAs(new Blob([html], {type:"text/plain;charset=utf-8"}), "tskit_arg_visualizer.html");
            })
        */

        var reheat = dashboard.append("button").attr("class", "dashbutton activecolor")
            .on("click", function(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();       
                var order = d3.selectAll(div_selector + " .sample").data().sort((a, b) => d3.ascending(a.x, b.x)).map(a => a.id);;
                d3.selectAll(div_selector + " .node").classed("unfix", function(d) {
                    if ((d.ts_flags & NODE_IS_SAMPLE) & (d.x_pos_reference == -1)) {
                        delete d.fx;
                    } else {
                        d.fx = evenly_distributed_positions[order.indexOf(d.id)];
                    }
                });
            });
        reheat.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .attr("viewBox", "0 0 384 512")
            .append("path")
            .attr("d", "M153.6 29.9l16-21.3C173.6 3.2 180 0 186.7 0C198.4 0 208 9.6 208 21.3V43.5c0 13.1 5.4 25.7 14.9 34.7L307.6 159C356.4 205.6 384 270.2 384 337.7C384 434 306 512 209.7 512H192C86 512 0 426 0 320v-3.8c0-48.8 19.4-95.6 53.9-130.1l3.5-3.5c4.2-4.2 10-6.6 16-6.6C85.9 176 96 186.1 96 198.6V288c0 35.3 28.7 64 64 64s64-28.7 64-64v-3.9c0-18-7.2-35.3-19.9-48l-38.6-38.6c-24-24-37.5-56.7-37.5-90.7c0-27.7 9-54.8 25.6-76.9z");
        reheat.append("span").attr("class", "tip desc").text("Reheat Simulation");
        
        if (plot_type == "full") {
            var evenly_distribute = dashboard.append("button").attr("class", "dashbutton activecolor")
                .on("click", function() {
                    var order = d3.selectAll(div_selector + " .sample").data().sort((a, b) => d3.ascending(a.x, b.x)).map(a => a.id);;
                    d3.selectAll(div_selector + " .sample").classed("distribute", function(d) {
                        d.fx = evenly_distributed_positions[order.indexOf(d.id)];
                    });
                });
            evenly_distribute.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                .attr("xmlns", "http://www.w3.org/2000/svg")
                .attr("viewBox", "0 0 512 512")
                .append("path")
                .attr("d", "M504.3 273.6c4.9-4.5 7.7-10.9 7.7-17.6s-2.8-13-7.7-17.6l-112-104c-7-6.5-17.2-8.2-25.9-4.4s-14.4 12.5-14.4 22l0 56-192 0 0-56c0-9.5-5.7-18.2-14.4-22s-18.9-2.1-25.9 4.4l-112 104C2.8 243 0 249.3 0 256s2.8 13 7.7 17.6l112 104c7 6.5 17.2 8.2 25.9 4.4s14.4-12.5 14.4-22l0-56 192 0 0 56c0 9.5 5.7 18.2 14.4 22s18.9 2.1 25.9-4.4l112-104z")
            evenly_distribute.append("span").attr("class", "tip desc").text("Space Samples");
        }

        var labelling = dashboard.append("button").attr("class", "dashbutton");
        labelling.append("svg") //<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .attr("viewBox", "0 0 512 512")
            .append("path")
            .attr("d", "M0 80L0 229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0L418.7 317.3c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7L48 32C21.5 32 0 53.5 0 80zm112 32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z");
        var labelling_methods = labelling.append("span").attr("class", "tip desc");
        var methods = labelling_methods.append("div").text("Node Labels:").append("div").attr("class", "labelmethods")
        
        function switch_node_label(selected) {
            label_text.each(function(d) {
                d3.select(this).selectAll("*").remove();
                if (selected == "default") {
                    multi_line_text.call(this, d.label, (d.parent_of.length == 0));
                } else if (selected == "id") {
                    multi_line_text.call(this, "#" + String(d.id));
                } else {
                    multi_line_text.call(this, "");
                }
            })
        }
        
        methods.append("button").attr("class", "node-labels-default").text("DEFAULT")
            .on("click", function() {
                switch_node_label("default");
                // Underline the current selection (could use different highlighting method here)
                d3.selectAll(div_selector + " .labelmethods button").style("text-decoration", "none");
                d3.select(this).style("text-decoration", "underline");
            });
        methods.append("button").attr("class", "node-labels-id").text("#ID")
            .on('click', function(){
                switch_node_label("id");
                // Underline the current selection (could use different highlighting method here)
                d3.selectAll(div_selector + " .labelmethods button").style("text-decoration", "none");
                d3.select(this).style("text-decoration", "underline");
            });
        methods.append("button").attr("class", "node-labels-none").text("NONE")
            .on('click', function(){
                switch_node_label("none");
                // Underline the current selection (could use different highlighting method here)
                d3.selectAll(div_selector + " .labelmethods button").style("text-decoration", "none");
                d3.select(this).style("text-decoration", "underline");
            });


        var svg = d3.select(div_selector).append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("background-color", "white");

        var result = y_axis.ticks.map(function (x) { 
            return parseInt(x, 10); 
        });

        if (eval(y_axis.include_labels)) {
            var bottom = height - 50;
            if (tree_highlighting) {
                bottom = height - 125;
            }
            var top = 50;
            if (title != "None") {
                top = 100
            }
            var yscale = d3.scaleLinear() 
                .domain([y_axis.max_min[0], y_axis.max_min[1]]) 
                .range([y_axis.max_min[0], y_axis.max_min[1]]); 

            var y_axis_text = y_axis.text;

            var d3_y_axis = d3.axisRight().scale(yscale)
                .tickValues(result)
                .tickFormat((d, i) => y_axis_text[i]); 

            var y_axis_labels = svg
                .append("g")
                .attr("class", "yaxis")
                .attr("transform", "translate(25,0)")
                .call(d3_y_axis);
            
            if (y_axis.title != "None") {
                y_axis_labels.append("text")
                .attr("x", -15)
                .attr("y", (y_axis.max_min[0]+y_axis.max_min[1])/2)
                .attr("fill", "black")
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .attr("class", "label")
                .attr("transform", "rotate(-90, -15, " + (y_axis.max_min[0]+y_axis.max_min[1])/2 + ")")
                .text(y_axis.title);
            }
        }

        var simulation = d3
            .forceSimulation(graph.nodes)
            .force("link", d3.forceLink()
                .id(d => d.id)
                .links(graph.links)
            )
            //.force("center", d3.forceCenter(275,250).strength(-10))
            .force("charge", d3.forceManyBody().strength(-100))
            .on("tick", ticked);

        var link_container = svg
            .append("g")
            .attr("class", "links")
            .selectAll("path")
            .data(graph.links)
            .enter()
            .append("g")
            .attr("bounds", d => d.bounds);

        if ((edge_styles.type == "ortho") & eval(edge_styles.include_underlink)) {
            var underlink = link_container
                .append("path")
                .attr("class", "underlink");
        }

        var link = link_container
            .append("path")
            .attr("class", "link")
            .attr("stroke", d => d.stroke)
            .attr("stroke-width", "4px");
        
        if (eval(edge_styles.variable_width)) {
            link
                .style("stroke-width", d => d.region_fraction * 7 + 1);
        }

        if (tree_highlighting) {
            d3.selectAll(div_selector + " .link")
                .on('mouseover', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        d3.select(this)
                            .style('stroke', '#1eebb1')
                            .style("cursor", "pointer");
                        d3.selectAll(div_selector + " .sites .e" + d.id).style("display", "block");
                        d3.selectAll(div_selector + " .endpoints")
                            .style('display', 'none'); /* hide other labels to avoid clashes */
                        const bars = d3.select(div_selector + " .breakpoints").selectAll(".included");
                        bars /* colour in all bars covered by these bounds */
                            .filter(function(j) {
                                return d.bounds.split(" ").some(function(region) {
                                    region = region.split("-");
                                    return (parseFloat(region[0]) <= j.start) & (parseFloat(region[1]) >= j.stop)
                                });
                            })
                            .selectAll("rect").style('fill', '#1eebb1');
                        bars /* show the leftmost position label */
                            .filter(function(j) {
                                return d.bounds.split(" ").some(function(region) {
                                    region = region.split("-");
                                    return (parseFloat(region[0]) == j.start)
                                });
                            })
                            .selectAll("text.start").style('display', 'block');
                        bars /* show the rightmost position label */
                            .filter(function(j) {
                                return d.bounds.split(" ").some(function(region) {
                                    region = region.split("-");
                                    return (parseFloat(region[1]) == j.stop)
                                });
                            })
                            .selectAll("text.stop").style('display', 'block');
                    }
                })
                .on('mouseout', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        d3.select(this)
                            .style('stroke', d.stroke)
                            .style("cursor", "default");
                        const bars = d3.select(div_selector + " .breakpoints").selectAll(".included");
                        bars.selectAll("rect").style("fill", d.fill);
                        bars.selectAll("text").style("display", "none");
                        d3.selectAll(div_selector + " .endpoints")
                            .style('display', 'block');
                        d3.selectAll(div_selector + " .sites .e" + d.id).style("display", "none");
                    }
                });
        }

        var node_group = svg
            .append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter()
            .append("g");

        var missing_edges = node_group
            .filter(d => (d.not_included_parents>0) | (d.not_included_children>0))
            .append("g")
            .attr("class", "missing");

        var missing_parents = missing_edges
            .filter(d => d.not_included_parents>0)
            .append("g")
            .attr("class", "parents")
            .append("g");
        var missing_parents_paths = missing_parents.append("path");
        var missing_parents_texts = missing_parents
            .append("text")
                .attr("class", "label")
                .style("fill", "gray")
                .text(d => d.not_included_parents);

        var missing_children = missing_edges
            .filter(d => d.not_included_children>0)
            .append("g")
            .attr("class", "children")
            .append("g");
        var missing_children_paths = missing_children.append("path");
        var missing_children_texts = missing_children
            .append("text")
                .attr("class", "label")
                .style("fill", "gray")
                .text(d => d.not_included_children);

        function multi_line_text(text, top_align) {
            if (text != null) {
                // Split label text onto separate lines by newline characters, if they exist
                const lines = text.split("\n");
                const parentX = d3.select(this).attr("x") || "0";  // Get parent text's x position
                const initialDy = top_align ? "0em" : (-1 * (lines.length - 1)) + "em";

                d3.select(this).text(null); // clear existing text
                d3.select(this).selectAll('tspan')
                    .data(lines)
                    .enter()
                    .append('tspan')
                    .text(d => d)
                    .attr('x', parentX)  // Use parent's x position
                    .attr('dy', (d, i) => ((i === 0) ? initialDy : "1em"));
            }
        }
        var node = node_group
            .append("path")
            .attr("transform", d => "translate(" + d.x + "," + d.y + ")")
            .attr("d", d3.symbol().type(d => eval(d.symbol)).size(d => d.size))
            .attr("fill", d => d.fill)
            .attr("stroke", d => d.stroke)
            .attr("stroke-width", d => d.stroke_width)
            .attr("id", d => String(divnum) + "_node" + d.id)
            .attr("class", d => "node flag" + d.ts_flags + (d.ts_flags & NODE_IS_SAMPLE ? " sample" : ""))
            .attr("parents", d => d.child_of.toString().replace(",", " "))
            .attr("children", d => d.parent_of.toString().replace(",", " "))
            .call(
                d3
                    .drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
            )
            .on('mouseover', function (d, i) {
                d3.select(this)
                    .style("cursor", "pointer")
            });

        function highlight_mut(mutation_id, site_id, fill) {
            /* other mutations at the same site on the tree */
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect").style("stroke", fill);
            /* highlight only this mutation in the bar */
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "block");
        }

        function dehighlight_mut(mutation_id, site_id) {
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect")
                .each(function(d) {
                    d3.select(this)
                        .style("stroke", d.stroke)
                        .style("fill", d.fill);
                    });
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "none");
        }

        function highlight_mut(mutation_id, site_id, fill) {
            /* other mutations at the same site on the tree */
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect").style("stroke", fill);
            /* highlight only this mutation in the bar */
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "block");
        }

        function dehighlight_mut(mutation_id, site_id) {
            d3.selectAll(div_selector + " .mutations .s" + site_id + " rect")
                .each(function(d) {
                    d3.select(this)
                        .style("stroke", d.stroke)
                        .style("fill", d.fill);
                    });
            d3.select(div_selector + " .sites .m" + mutation_id).style("display", "none");
        }

        var mut_symbol = svg
            .append("g")
            .attr("class", "mutations")
            .selectAll("rect")
            .data(graph.mutations)
            .enter()
            .append("g")
            .attr("class", d => {
                if (condense_mutations) {
                    return (
                        d.site_id.map(id => "s" + id).join(" ") + " " +
                        d.mutation_id.map(id => "m" + id).join(" ")
                    )
                } else {
                    return "s" + d.site_id + " " + "m" + d.mutation_id;
                }}
            )
            .attr("class", d => {
                if (condense_mutations) {
                    return (
                        d.site_id.map(id => "s" + id).join(" ") + " " +
                        d.mutation_id.map(id => "m" + id).join(" ")
                    )
                } else {
                    return "s" + d.site_id + " " + "m" + d.mutation_id;
                }}
            )
            .on("mouseover", function(event, d) {
                if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                    d3.select(this).style("cursor", "pointer");
                    /* highlight all mutations at the same site (easy to spot reversions etc) */
                    if (condense_mutations) {
                        d.mutation_id.forEach((id, i) => highlight_mut(id, d.site_id[i], d.fill));
                    } else {
                        highlight_mut(d.mutation_id, d.site_id, d.fill)
                    }
                    if (condense_mutations) {
                        d.mutation_id.forEach((id, i) => highlight_mut(id, d.site_id[i], d.fill));
                    } else {
                        highlight_mut(d.mutation_id, d.site_id, d.fill)
                    }
                    /* Show a tooltip with the mutation information */
                    var rect = d3.select(div_selector).node().getBoundingClientRect();
                    tip
                        .style("display", "block")
                        .html("<p style='margin: 0px;'>" + d.content + "</p>")
                        .style("border", d.fill + " solid 2px")
                        .style("left", (event.pageX - rect.x) + "px")
                        .style("top", (event.pageY - rect.y + 25) + "px")
                        .style("transform", "translateX(-50%)");
                }
            })
            .on("mouseout", function(event, d) {
                if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                    if (!eval(d.active)) {
                        d3.select(this).style("cursor", "default");
                        if (condense_mutations) {
                            d.mutation_id.forEach((id, i) => dehighlight_mut(id, d.site_id[i]));
                        } else {
                            dehighlight_mut(d.mutation_id, d.site_id);
                        }
                    }
                    if (!eval(d.active)) {
                        d3.select(this).style("cursor", "default");
                        if (condense_mutations) {
                            d.mutation_id.forEach((id, i) => dehighlight_mut(id, d.site_id[i]));
                        } else {
                            dehighlight_mut(d.mutation_id, d.site_id);
                        } 
                        tip.style("display", "none");
                    }
                }
            });

        if (label_mutations) {
            var mut_symbol_label = mut_symbol
                .append("text")
                //.attr("class", "label")
                .style("font-size", d => (d.size * 2 + "px"))
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .attr("fill", d => {
                    var box = document.createElement("div");
                    box.style.color = d.fill;
                    document.body.appendChild(box);
                    var rgb = parseRgbString(window.getComputedStyle(box).color);
                    document.body.removeChild(box);
                    var lightness = 0.2126*rgb["r"] + 0.7152*rgb["g"] + 0.0722*rgb["b"];
                    if (lightness > 0.5) {
                        return "#053e4e"
                    }
                    return "white"
                })
                .text(d => d.label)
                .each(function(d) {
                    // Store the text width on the data object
                    d.textWidth = this.getComputedTextLength();
                });
        }

        var mut_symbol_rect = mut_symbol
            .append("rect")
            .attr("class", "symbol")
            .attr("fill", d => d.fill)
            .attr("stroke", d => d.stroke)
            .attr("stroke-width", 2)
            // Set the rect width / height based on the calculated text width
            .attr("width", function(d) {
                if (label_mutations && d.textWidth) {
                    d.computedWidth = d.textWidth + 6; // Add left/right padding
                } else {
                    d.computedWidth = d.size * 3; // aspect ratio is 3 (3 times wider than tall)
                }
                return d.computedWidth;  
            })
            .attr("height", function(d) {
                if (label_mutations) {
                    d.computedHeight = (d.size * 2) + 4; // Font size + top/bottom padding
                }
                else {
                    d.computedHeight = d.size;
                }
                return d.computedHeight;
            })
            .lower();

        function rotate_tip(d) {
            /* NB: why is there an "eval" here? */
            if ((d.parent_of.length == 0) & (eval(rotate_tip_labels))) {
                return "translate(-4, 0) rotate(90)"
            }
            return null
        }

        var label = svg
            .append("g")
            .attr("class", "node-labels")
            .selectAll("text")
            .data(graph.nodes)
            .enter()
            //.filter(d => eval(d.include_label))
            .append("g");

        var label_text = label
            .attr("class", d => "label n" + d.id)
            .append("text")
            .each(function(d) {
                multi_line_text.call(this, d.label, (d.parent_of.length == 0));
            })
            //.each(d => multi_line_text.call(this, d.label, (d.parent_of.length == 0)))
            .attr("transform", rotate_tip);

        function determine_path_type(d) {
            path_type = ""
            var start_position_x = d.source.x;
            var start_position_y = d.source.y;
            var stop_position_x = d.target.x;
            var stop_position_y = d.target.y;
            var vnub = Math.min((stop_position_y-start_position_y)/2, 20);
            if ("y_axis.scale" == "time" | "y_axis.scale" == "log_time") {
                vnub = 0;
            }
            var alt_child = document.getElementById(String(divnum) + "_node" + d.alt_child);
            if (alt_child != null) {
                var alt_child_x = alt_child.getAttribute("cx");
                var alt_child_y = alt_child.getAttribute("cy");
            }
            if (d.source.ts_flags & NODE_IS_RE_EVENT) {
                path_type += "r0";
                start_position_y = d.source.y + vnub;
            } else {
                if (d.target.y < alt_child_y) {
                    if (d.target.x < d.source.x) {
                        if (d.target.x < d.source.x - 40) {
                            path_type += "tL";
                        } else {
                            path_type += "fL";
                        }
                        start_position_x = d.source.x - 20;
                    } else {
                        if (d.target.x > d.source.x + 40) {
                            path_type += "tR";
                        } else {
                            path_type += "fR";
                        }
                        start_position_x = d.source.x + 20;
                    }
                } else if (d.target.y > alt_child_y) {
                    if (alt_child_x < d.source.x) {
                        if (d.target.x < d.source.x + 40) {
                            path_type += "fR";
                        } else {
                            path_type += "tR";
                        }
                        start_position_x = d.source.x + 20;
                    } else {
                        if (d.target.x > d.source.x - 40) {
                            path_type += "fL";
                        } else {
                            path_type += "tL";
                        }
                        start_position_x = d.source.x - 20;
                    }
                } else {
                    if (d.target.x < alt_child_x) {
                        if (d.target.x < d.source.x - 40) {
                            path_type += "tL";
                        } else {
                            path_type += "fL";
                        }
                        start_position_x = d.source.x - 20;
                    } else if (d.target.x > alt_child_x) {
                        if (d.target.x > d.source.x + 40) {
                            path_type += "tR";
                        } else {
                            path_type += "fR";
                        }
                        start_position_x = d.source.x + 20;
                    } else {
                        if (d.index % 2 == 0) {
                            path_type += "fL";
                            start_position_x = d.source.x - 20;
                        } else {
                            path_type += "fR";
                            start_position_x = d.source.x + 20;
                        }
                    }
                }
            }
            var alt_parent = document.getElementById(String(divnum) + "_node" + d.alt_parent);
            if (alt_parent != null) {
                var alt_parent_x = alt_parent.getAttribute("cx");
                var alt_parent_y = alt_parent.getAttribute("cy");
            }
            if (d.target.ts_flags & NODE_IS_RE_EVENT) {
                if (d.source.y < alt_parent_y) {
                    if (alt_parent_x < d.target.x) {
                        if (d.source.x < d.target.x + 40) {
                            path_type += "fR";
                        } else {
                            path_type += "tR";
                        }
                        stop_position_x = d.target.x + 20;
                    } else {
                        if (d.source.x > d.target.x - 40) {
                            path_type += "fL";
                        } else {
                            path_type += "tL";
                        }
                        stop_position_x = d.target.x - 20;
                    }
                } else if (d.source.y > alt_parent_y) {
                    if (d.source.x < d.target.x) {
                        if (d.source.x < d.target.x - 40) {
                            path_type += "tL";
                        } else {
                            path_type += "fL";
                        }
                        stop_position_x = d.target.x - 20;
                    } else {
                        if (d.source.x > d.target.x + 40) {
                            path_type += "tR";
                        } else {
                            path_type += "fR";
                        }
                        stop_position_x = d.target.x + 20;
                    }
                } else {
                    if (d.index % 2 == 0) {
                        path_type += "fL";
                        stop_position_x = d.target.x - 20;
                    } else {
                        path_type += "fR";
                        stop_position_x = d.target.x + 20;
                    }
                }
            } else {
                path_type += "b0";
                stop_position_y = d.target.y - vnub;
            }
            if (path_type == "fLb0" ) {
                if (start_position_x >= stop_position_x) {
                    path_type = "tLb0";
                }
            } else if (path_type == "fRb0") {
                if (start_position_x <= stop_position_x) {
                    path_type = "tRb0";
                }
            } else if (path_type == "r0fL") {
                if (start_position_x <= stop_position_x) {
                    path_type = "r0tL";
                }
            } else if (path_type == "r0fR") {
                if (start_position_x >= stop_position_x) {
                    path_type = "r0tR";
                }
            } else if (path_type == "fLfL") {
                if (start_position_x <= stop_position_x) {
                    path_type = "fLtL";
                } else {
                    path_type = "tLfL";
                }
            } else if (path_type == "fRfR") {
                if (start_position_x >= stop_position_x) {
                    path_type = "fRtR";
                } else {
                    path_type = "tRfR";
                }
            }
            return [path_type, start_position_x, start_position_y, stop_position_x, stop_position_y];
        }

        function ortho_pathing(d, path_info, underlink=false) {      
            const path_type = path_info[0];
            const simple_path_type = Array.from(path_type)[0] + Array.from(path_type)[2];
            const start_position_x = path_info[1];
            const start_position_y = path_info[2];
            const stop_position_x = path_info[3];
            const stop_position_y = path_info[4];

            const after_paths = ["rf", "tb", "tf"];
            const before_paths = ["rt", "fb", "ft"];
            const step_paths = ["tt"];
            const mid_paths = ["rb", "ff"];

            if (underlink) {
                if (after_paths.includes(simple_path_type)) {
                    return stepAfter([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]);
                } else if (before_paths.includes(simple_path_type)) {
                    return stepBefore([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]);
                } else if (step_paths.includes(simple_path_type)) {
                    return step([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]);
                } else if (mid_paths.includes(simple_path_type)) {
                    return line([[start_position_x, start_position_y],[start_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[start_position_x, start_position_y + (stop_position_y - start_position_y)/2],[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2], [stop_position_x, stop_position_y]]);
                }
            } else {
                if (after_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + stepAfter([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                } else if (before_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + stepBefore([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                } else if (step_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + step([[start_position_x, start_position_y],[stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                } else if (mid_paths.includes(simple_path_type)) {
                    return line([[d.source.x, d.source.y],[start_position_x, start_position_y]]) + line([[start_position_x, start_position_y],[start_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[start_position_x, start_position_y + (stop_position_y - start_position_y)/2],[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2]]) + line([[stop_position_x, start_position_y + (stop_position_y - start_position_y)/2], [stop_position_x, stop_position_y]]) + line([[stop_position_x, stop_position_y], [d.target.x, d.target.y]]);
                }
            }
        }

        function ticked() {
            node
                .attr("transform", function(d) {
                    if (eval(y_axis.include_labels)) {
                        return "translate(" + Math.max(150, Math.min(width-50, d.x)) + "," + d.y + ")";
                    } else {
                        return "translate(" + Math.max(50, Math.min(width-50, d.x)) + "," + d.y + ")";
                    }
                })
                .attr("cx", function(d) {
                    if ((edge_styles.type == "ortho") & (d.x_pos_reference != -1)) {
                        var ref = document.getElementById(String(divnum) + "_node" + d.x_pos_reference);
                        if (ref != null) {
                            d.fx = ref.getAttribute("cx");
                        }
                    }
                    if (eval(y_axis.include_labels)) {
                        return d.x = Math.max(150, Math.min(width-50, d.x));
                    } else {
                        return d.x = Math.max(50, Math.min(width-50, d.x));
                    }
                })
                .attr("cy", d => d.y);
            
            link_container.each(function(d) {
                var path_info = determine_path_type(d);
                var path = "";
                if (edge_styles.type == "ortho") {
                    path = ortho_pathing(d, path_info);
                    underlink_path = ortho_pathing(d, path_info, underlink=true);
                } else if (d.source.id == d.alt_parent) {
                    var leftOrRight = 20;
                    if (d.index % 2 == 0) {
                        leftOrRight = -20;
                    }
                    path = "M " + d.source.x + " " + d.source.y + " C " + (d.source.x + leftOrRight).toString() + " " +  (d.source.y - 10).toString() + ", " + (d.target.x + leftOrRight).toString() + " " + (d.target.y + 10).toString() + ", " + d.target.x + " " + d.target.y;
                } else {
                    path = line([[d.source.x, d.source.y], [d.target.x, d.target.y]]);
                }
                if ((edge_styles.type == "ortho") & eval(edge_styles.include_underlink)) {
                    var u = d3.select(this).select(".underlink");
                    u.attr("d", underlink_path);
                }
                var l = d3.select(this).select(".link");
                l.attr("path_type", path_info[0]);
                l.attr("d", path)
                l.attr("fill", "none");
            });

            mut_symbol_rect
                .attr("x", function(d) {
                    var parent = document.getElementById(String(divnum) + "_node" + d.source);
                    if (parent != null) {
                        var parent_x = parseFloat(parent.getAttribute("cx"));
                        var parent_y = parseFloat(parent.getAttribute("cy"));
                        var child = document.getElementById(String(divnum) + "_node" + d.target);
                        if (child != null) {
                            var child_x = parseFloat(child.getAttribute("cx"));
                            var child_y = parseFloat(child.getAttribute("cy"));
                            if (parent_x - child_x == 0) {
                                return parent_x - d.computedWidth/2;
                            } else {
                                var slope = (parent_y - child_y) / (parent_x - child_x);
                                var intercept = parent_y - slope * parent_x;
                                return ((d.y - intercept) / slope) - d.computedWidth/2;
                            }
                        } else {
                            return 0;
                        }
                    } else {
                        return 0;
                    }
                })
                .attr("y", d => d.y - d.computedHeight/2);

            mut_symbol
                .attr("transform", function(d) {
                    var parent = document.getElementById(String(divnum) + "_node" + d.source);
                    if (parent != null) {
                        var parent_x = parseFloat(parent.getAttribute("cx"));
                        var parent_y = parseFloat(parent.getAttribute("cy"));
                        var child = document.getElementById(String(divnum) + "_node" + d.target);
                        if (child != null) {
                            var child_x = parseFloat(child.getAttribute("cx"));
                            var child_y = parseFloat(child.getAttribute("cy"));
                            var slope = (parent_y - child_y) / (parent_x - child_x);
                            var intercept = parent_y - slope * parent_x;
                            var rect = this.children[0];
                            return "rotate(" + String(-Math.atan((child_x-parent_x)/(child_y-parent_y))*180/Math.PI) + ", " + String(parseFloat(rect.getAttribute("x"))+parseFloat(rect.getAttribute("width"))/2) + ", " + String(parseFloat(rect.getAttribute("y"))+parseFloat(rect.getAttribute("height"))/2) + ")";
                        } else {
                            return "rotate(0)";
                        }
                    } else {
                        return "rotate(0)";
                    }
                });
            
            if (label_mutations) {
                mut_symbol_label
                    .attr("transform", function(d) {
                        var y = d.y + 1;
                        var x = 0;
                        var parent = document.getElementById(String(divnum) + "_node" + d.source);
                        if (parent != null) {
                            var parent_x = parseFloat(parent.getAttribute("cx"));
                            var parent_y = parseFloat(parent.getAttribute("cy"));
                            var child = document.getElementById(String(divnum) + "_node" + d.target);
                            if (child != null) {
                                var child_x = parseFloat(child.getAttribute("cx"));
                                var child_y = parseFloat(child.getAttribute("cy"));
                                if (parent_x - child_x == 0) {
                                    x = parent_x;
                                } else {
                                    var slope = (parent_y - child_y) / (parent_x - child_x);
                                    var intercept = parent_y - slope * parent_x;
                                    x = ((d.y - intercept) / slope);
                                }
                            } else {
                                x = 0;
                            }
                        } else {
                            x = 0;
                        }
                        return "translate(" + String(x) + "," + String(y) + ")";
                    });
            }

            function determine_label_positioning(d) {
                if (d.ts_flags & NODE_IS_RE_EVENT || d.parent_of.length == 0 || d.child_of.length == 0) {
                    return "c";
                } else if (d.child_of.length == 1) {
                    var parent = document.getElementById(String(divnum) + "_node" + d.child_of[0])
                    if (parent != null) {
                        var parent_x = parent.getAttribute("cx");
                        if (parent_x > d.x+1) {
                            return "l";
                        } else {
                            return "r";
                        }
                    } else {
                        return "r";
                    }
                } else {
                    return "r";
                }
            };

            label
                .each(function(d) {
                    var l = d3.select(this);
                    var positioning = determine_label_positioning(d);
                    var x = d.x;
                    var anchor = "middle";
                    // Find offsets from CSS
                    const cstyle = getComputedStyle(this)
                    const symbolSize = Math.sqrt(d.size);
                    const cssOffset = cstyle.getPropertyValue('--offset');
                    // default should depend on the symbol size (which is square pixels) and the font size
                    const offset = cssOffset ? parseInt(cssOffset) : symbolSize/2 + parseFloat(cstyle.fontSize)/2;
                    const cssTipoffset = cstyle.getPropertyValue('--tipoffset');
                    // default of 25 if not set: perhaps should be related to the tip symbol size?
                    const tipoffset = cssTipoffset ? parseInt(cssTipoffset) : symbolSize/2 + parseFloat(cstyle.fontSize);
                    if (positioning == "l") {
                        x = d.x - offset;
                        anchor = "end";
                    } else if (positioning == "r") {
                        x = d.x + offset;
                        anchor = "start";
                    }
                    l.attr("text-anchor", anchor);
                    l.attr("transform", function(d) {
                        // adding slightly more spacing in the y-axis when positioning is middle (c)
                        var y = d.y - offset;
                        if (positioning == "c") {
                            y = y - 3;
                        }
                        if (d.parent_of.length == 0) {
                            y = d.y + tipoffset;
                            if (positioning == "c") {
                                y = y + 3;
                            }
                        }
                        // only bother showing up to 4 d.p.
                        return "translate(" + parseFloat(x.toFixed(4)) + "," + parseFloat(y.toFixed(4)) + ")";
                    })
                });

            missing_parents_paths
                .each(function(d) {
                    var l = d3.select(this);
                    l.style("stroke-width", "4px");
                    l.style("stroke-dasharray", "5");
                    l.style("stroke", "gray");
                    l.attr("d", line([[d.x, d.y], [d.x, d.y-30]]));
                });
            
            missing_parents_texts
                .each(function(d) {
                    var l = d3.select(this);
                    l.attr("text-anchor", "middle");
                    l.attr("x", d.x);
                    l.attr("y", d.y-30);
                });

            missing_children_paths
                .each(function(d) {
                    var l = d3.select(this);
                    l.style("stroke-width", "4px");
                    l.style("stroke-dasharray", "5");
                    l.style("stroke", "gray");
                    l.attr("d", line([[d.x, d.y], [d.x, d.y+30]]));
                });
            
            missing_children_texts
                .each(function(d) {
                    var l = d3.select(this);
                    l.attr("text-anchor", "middle");
                    l.attr("x", d.x);
                    l.attr("y", d.y+40);
                });
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d3.selectAll(div_selector + " .node").classed("ref", function(j) {
                if ((edge_styles.type == "ortho") & (j.id == d.x_pos_reference)) {
                    j.fx = d.x;
                }
            });
            svg.attr("class", "no-hover");
        }

        function dragged(event, d) {
            d.fx = event.x;
            d3.selectAll(div_selector + " .node").classed("ref", function(j) {
                if ((edge_styles.type == "ortho") & (j.id == d.x_pos_reference)) {
                    j.fx = event.x;
                }
            });
        }

        function dragended(event, d) {
            svg.attr("class", null);
        }

        if (tree_highlighting) {
            
            var th_group = svg.append("g").attr("class", "tree_highlighting");
            
            var breakpoint_regions = th_group
                .append("g")
                .attr("class", "breakpoints")
                .selectAll("g")
                .data(graph.breakpoints)
                .enter()
                .append("g")
                .attr("class", d => eval(d.included) ? "included" : null)
                .attr("start", d => d.start)
                .attr("stop", d => d.stop);

            breakpoint_regions
                .append("rect")
                .attr("x", d => d.x_pos)
                .attr("y", height-60)
                .attr("width", d => d.width)
                .attr("height", 40)
                .attr("stroke", "#FFFFFF")
                .attr("stroke-width", 1)
                .attr("fill", d => eval(d.included) ? d.fill : "gray");

            breakpoint_regions
                .append("text")
                .attr("x", d => d.x_pos)
                .attr("y", height-5)
                .attr("class", "label start")
                .style("display", "none")
                .text(d => String(d.start));

            breakpoint_regions
                .append("text")
                .attr("x", d => d.x_pos + d.width)
                .attr("y", height-5)
                .attr("class", "label stop")
                .style("display", "none")
                .text(d => String(d.stop));

            breakpoint_regions
                .on('mouseover', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        if (eval(d.included)) {
                            d3.select(this).selectAll("rect")
                                .style('fill', '#1eebb1')
                                .style("cursor", "pointer");
                            d3.select(this).selectAll("text")
                                .style('display', 'block');
                            d3.selectAll(div_selector + " .endpoints")
                                .style('display', 'none'); /* hide other labels to avoid clashes */
                            var highlight_links = d3.select(div_selector + " .links")
                                .selectAll("g")
                                    .filter(function(j) {
                                        return j.bounds.split(" ").some(function(region) {
                                            region = region.split("-");
                                            return (parseFloat(region[1]) > d.start) & (parseFloat(region[0]) < d.stop)
                                        });
                                    });
                            highlight_links.raise();
                            highlight_links
                                .select(".link")
                                .style("stroke", "#1eebb1");
                        }
                    }
                })
                .on('mouseout', function (event, d) {
                    if (!d3.select(div_selector + ">svg").classed("no-hover")) {
                        if (eval(d.included)) {
                            d3.select(this).selectAll("rect")
                                .style('fill', d.fill)
                                .style("cursor", "default");
                            d3.select(this).selectAll("text")
                                .style('display', 'none');
                            d3.selectAll(div_selector + " .endpoints")
                                .style('display', 'block');
                            d3.selectAll(div_selector + " .link")
                                .style("stroke", d => d.stroke);
                        }
                    }
                });
            
            var endpoints = th_group.append("g").attr("class", "endpoints");
            
            endpoints
                .append("text")
                    .attr("class", "label")
                    .style("text-anchor", "start")
                    .text(graph.breakpoints[0].start)
                    .attr("x", graph.breakpoints[0].x_pos)
                    .attr("y", height-5);
            
            endpoints
                .append("text")
                    .attr("class", "label")
                    .style("text-anchor", "end")
                    .text(graph.breakpoints[graph.breakpoints.length-1].stop)
                    .attr("x", width)
                    .attr("y", height-5);

            var mutation_data = graph.mutations;
            if (condense_mutations) { /* explode the graph.mutations df into one row per mut */
                mutation_data = [];
                graph.mutations.forEach(function(d) {
                    d.mutation_id.forEach(function(x, i) {
                        mutation_data.push({
                            mutation_id: x,
                            site_id: d.site_id[i],
                            edge: d.edge,
                            fill: d.fill,
                            x_pos: d.x_pos[i], 
                            position: d.position[i]
                        });
                    });
                });
            };

            var mutation_data = graph.mutations;
            if (condense_mutations) { /* explode the graph.mutations df into one row per mut */
                mutation_data = [];
                graph.mutations.forEach(function(d) {
                    d.mutation_id.forEach(function(x, i) {
                        mutation_data.push({
                            mutation_id: x,
                            site_id: d.site_id[i],
                            edge: d.edge,
                            fill: d.fill,
                            x_pos: d.x_pos[i], 
                            position: d.position[i]
                        });
                    });
                });
            };

            var site_pos = th_group
                .append("g")
                .attr("class", "sites")
                .selectAll("line")
                .data(mutation_data)  /* NB: one per mutation to allow different line colors */
                .data(mutation_data)  /* NB: one per mutation to allow different line colors */
                .enter()
                .append("g")
                .attr("class", d => "s" + d.site_id + " " + "e" + d.edge + " " + "m" + d.mutation_id)
                .attr("class", d => "s" + d.site_id + " " + "e" + d.edge + " " + "m" + d.mutation_id)
                .attr("transform", d => "translate(" + d.x_pos + "," + (height-60) + ")")
                .style("display", "none");

            function createSiteLine(selection) {
                return selection
                    .append("line")
                    .attr("y1", -5)
                    .attr("y2", 40+5)
                    .style("stroke-width", 3)
                    .style("fill", "none");
            }
                  
            function createSiteText(selection) {
                return selection
                    .append("text")
                    .attr("y", -8)  /* above the tick */
                    .attr("class", "label");
            }
            
            site_pos
                .each(function(d) {
                    const select = d3.select(this);
                    createSiteLine(select)
                        .style("stroke", d.fill);
                    createSiteText(select)
                        .text(String(d.position));
                });
            
            /*
            var mut_text = mut_pos
                .append("text")
                .attr("text-anchor", function(d) {
                    if (d.x_pos > (width*9/10)) {
                        return "end";
                    } else if (d.x_pos < width*1/10) {
                        return "start";
                    } else {
                        return "middle";
                    }
                })
                .style("font-size", "10px")
                .style("font-family", "Arial")
                .attr("fill", d => d.fill)
                .attr("transform", d => "translate(" + String(d.x_pos) + "," + String(height-60-10) + ")");
        
            mut_text
                .text(function(d) {
                    if (label_mutations) {
                        return String(d.site_id) + ":" + String(d.position);
                    } else {
                        return d.label;
                    }
                });
            */
        }

        if (title != "None") {
            svg.append("text")
                .style("font-size", "20px")
                .attr("x", width / 2)
                .attr("text-anchor", "middle")
                .attr("y", 30)
                .each(function() { 
                    multi_line_text.call(this, title, true); 
                });
        }
    }

    draw_force_diagram()
}

/* NB: the code below fires up the visualizer: templates in this call
    can be used to pass in the appropriate data
*/

ensureRequire()
    .then(require => {
        require.config({ paths: {d3: 'https://d3js.org/d3.v7.min'}});
        require(["d3"], function(d3) {
            main_visualizer(d3, 1538751721, {"nodes": [{"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 0, "ts_flags": 1, "time": 0.0, "child_of": [9], "parent_of": [], "x_pos_reference": -1, "label": "0", "fx": 150.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 1, "ts_flags": 1, "time": 0.0, "child_of": [6], "parent_of": [], "x_pos_reference": -1, "label": "1", "fx": 290.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 2, "ts_flags": 1, "time": 0.0, "child_of": [9], "parent_of": [], "x_pos_reference": -1, "label": "2", "fx": 220.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 3, "ts_flags": 1, "time": 0.0, "child_of": [6], "parent_of": [], "x_pos_reference": -1, "label": "3", "fx": 360.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 4, "ts_flags": 1, "time": 0.0, "child_of": [8, 10], "parent_of": [], "x_pos_reference": -1, "label": "4", "fx": 500.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 5, "ts_flags": 1, "time": 0.0, "child_of": [7, 8], "parent_of": [], "x_pos_reference": -1, "label": "5", "fx": 430.0, "fy": 250.0, "y": 250.0}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 6, "ts_flags": 0, "time": 56.0454802286223, "child_of": [7, 10], "parent_of": [1, 3], "x_pos_reference": -1, "label": "6", "x": 325.0, "fy": 221.42857142857144, "y": 221.42857142857144}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 7, "ts_flags": 0, "time": 120.7850821708138, "child_of": [10], "parent_of": [5, 6], "x_pos_reference": -1, "label": "7", "x": 325.0, "fy": 192.85714285714286, "y": 192.85714285714286}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 8, "ts_flags": 0, "time": 142.86643656492956, "child_of": [10], "parent_of": [4, 5], "x_pos_reference": -1, "label": "8", "x": 325.0, "fy": 164.28571428571428, "y": 164.28571428571428}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 9, "ts_flags": 0, "time": 236.7237255340037, "child_of": [11, 12], "parent_of": [0, 2], "x_pos_reference": -1, "label": "9", "x": 325.0, "fy": 135.71428571428572, "y": 135.71428571428572}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 10, "ts_flags": 0, "time": 272.05118690557765, "child_of": [11, 12], "parent_of": [4, 6, 7, 8], "x_pos_reference": -1, "label": "10", "x": 325.0, "fy": 107.14285714285717, "y": 107.14285714285717}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 11, "ts_flags": 0, "time": 610.912738605865, "child_of": [], "parent_of": [9, 10], "x_pos_reference": -1, "label": "11", "x": 325.0, "fy": 78.57142857142858, "y": 78.57142857142858}, {"size": 150, "symbol": "d3.symbolCircle", "fill": "#1eebb1", "stroke": "#053e4e", "stroke_width": 4, "id": 12, "ts_flags": 0, "time": 1382.4658244607965, "child_of": [], "parent_of": [9, 10], "x_pos_reference": -1, "label": "12", "x": 325.0, "fy": 50.0, "y": 50.0}], "links": [{"id": 0, "source": 6, "source_time": 56.0454802286223, "target": 1, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 3, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 1, "source": 6, "source_time": 56.0454802286223, "target": 3, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 1, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 2, "source": 7, "source_time": 120.7850821708138, "target": 5, "target_time": 0.0, "bounds": "6516.940179280937-10000.0", "alt_parent": -1, "alt_child": 6, "region_fraction": 0.34830598207190633, "stroke": "#053e4e"}, {"id": 3, "source": 7, "source_time": 120.7850821708138, "target": 6, "target_time": 56.0454802286223, "bounds": "6516.940179280937-10000.0", "alt_parent": -1, "alt_child": 5, "region_fraction": 0.34830598207190633, "stroke": "#053e4e"}, {"id": 4, "source": 8, "source_time": 142.86643656492956, "target": 4, "target_time": 0.0, "bounds": "0.0-6516.940179280937", "alt_parent": -1, "alt_child": 5, "region_fraction": 0.6516940179280937, "stroke": "#053e4e"}, {"id": 5, "source": 8, "source_time": 142.86643656492956, "target": 5, "target_time": 0.0, "bounds": "0.0-6516.940179280937", "alt_parent": -1, "alt_child": 4, "region_fraction": 0.6516940179280937, "stroke": "#053e4e"}, {"id": 6, "source": 9, "source_time": 236.7237255340037, "target": 0, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 2, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 7, "source": 9, "source_time": 236.7237255340037, "target": 2, "target_time": 0.0, "bounds": "0.0-10000.0", "alt_parent": -1, "alt_child": 0, "region_fraction": 1.0, "stroke": "#053e4e"}, {"id": 8, "source": 10, "source_time": 272.05118690557765, "target": 4, "target_time": 0.0, "bounds": "6516.940179280937-10000.0", "alt_parent": -1, "alt_child": 6, "region_fraction": 0.34830598207190633, "stroke": "#053e4e"}, {"id": 9, "source": 10, "source_time": 272.05118690557765, "target": 6, "target_time": 56.0454802286223, "bounds": "0.0-6516.940179280937", "alt_parent": -1, "alt_child": 4, "region_fraction": 0.6516940179280937, "stroke": "#053e4e"}, {"id": 10, "source": 10, "source_time": 272.05118690557765, "target": 7, "target_time": 120.7850821708138, "bounds": "6516.940179280937-10000.0", "alt_parent": -1, "alt_child": 4, "region_fraction": 0.34830598207190633, "stroke": "#053e4e"}, {"id": 11, "source": 10, "source_time": 272.05118690557765, "target": 8, "target_time": 142.86643656492956, "bounds": "0.0-6516.940179280937", "alt_parent": -1, "alt_child": 4, "region_fraction": 0.6516940179280937, "stroke": "#053e4e"}, {"id": 12, "source": 11, "source_time": 610.912738605865, "target": 9, "target_time": 236.7237255340037, "bounds": "2601.014547981321-10000.0", "alt_parent": -1, "alt_child": 10, "region_fraction": 0.7398985452018679, "stroke": "#053e4e"}, {"id": 13, "source": 11, "source_time": 610.912738605865, "target": 10, "target_time": 272.05118690557765, "bounds": "2601.014547981321-10000.0", "alt_parent": -1, "alt_child": 9, "region_fraction": 0.7398985452018679, "stroke": "#053e4e"}, {"id": 14, "source": 12, "source_time": 1382.4658244607965, "target": 9, "target_time": 236.7237255340037, "bounds": "0.0-2601.014547981321", "alt_parent": -1, "alt_child": 10, "region_fraction": 0.26010145479813207, "stroke": "#053e4e"}, {"id": 15, "source": 12, "source_time": 1382.4658244607965, "target": 10, "target_time": 272.05118690557765, "bounds": "0.0-2601.014547981321", "alt_parent": -1, "alt_child": 9, "region_fraction": 0.26010145479813207, "stroke": "#053e4e"}], "mutations": [], "breakpoints": [{"id": 0, "start": 0.0, "stop": 2601.014547981321, "x_pos_01": 0.0, "width_01": 0.26010145479813207, "fill": "#053e4e", "x_pos": 100.0, "width": 117.04565465915942, "included": "true"}, {"id": 1, "start": 2601.014547981321, "stop": 6516.940179280937, "x_pos_01": 0.26010145479813207, "width_01": 0.3915925631299616, "fill": "#053e4e", "x_pos": 217.04565465915942, "width": 176.21665340848273, "included": "true"}, {"id": 2, "start": 6516.940179280937, "stop": 10000.0, "x_pos_01": 0.6516940179280937, "width_01": 0.34830598207190633, "fill": "#053e4e", "x_pos": 393.26230806764215, "width": 156.73769193235785, "included": "true"}], "evenly_distributed_positions": [150.0, 220.0, 290.0, 360.0, 430.0, 500.0]}, 550, 375, {"title": "Time ago (generations)", "units": "generations", "include_labels": "true", "ticks": [250.0, 221.42857142857144, 192.85714285714286, 164.28571428571428, 135.71428571428572, 107.14285714285717, 78.57142857142858, 50.0], "text": [0, 56, 121, 143, 237, 272, 611, 1382], "max_min": [250.0, 50.0], "scale": "rank"}, {"type": "line", "variable_width": false, "include_underlink": true}, false, false, true, null, false, "full", null, "{\"data\": {\"nodes\": [{\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 0, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [9], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"0\", \"fx\": 150.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 1, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [6], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"1\", \"fx\": 290.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 2, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [9], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"2\", \"fx\": 220.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 3, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [6], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"3\", \"fx\": 360.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 4, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [8, 10], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"4\", \"fx\": 500.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 5, \"ts_flags\": 1, \"time\": 0.0, \"child_of\": [7, 8], \"parent_of\": [], \"x_pos_reference\": -1, \"label\": \"5\", \"fx\": 430.0, \"fy\": 250.0, \"y\": 250.0}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 6, \"ts_flags\": 0, \"time\": 56.0454802286223, \"child_of\": [7, 10], \"parent_of\": [1, 3], \"x_pos_reference\": -1, \"label\": \"6\", \"x\": 325.0, \"fy\": 221.42857142857144, \"y\": 221.42857142857144}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 7, \"ts_flags\": 0, \"time\": 120.7850821708138, \"child_of\": [10], \"parent_of\": [5, 6], \"x_pos_reference\": -1, \"label\": \"7\", \"x\": 325.0, \"fy\": 192.85714285714286, \"y\": 192.85714285714286}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 8, \"ts_flags\": 0, \"time\": 142.86643656492956, \"child_of\": [10], \"parent_of\": [4, 5], \"x_pos_reference\": -1, \"label\": \"8\", \"x\": 325.0, \"fy\": 164.28571428571428, \"y\": 164.28571428571428}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 9, \"ts_flags\": 0, \"time\": 236.7237255340037, \"child_of\": [11, 12], \"parent_of\": [0, 2], \"x_pos_reference\": -1, \"label\": \"9\", \"x\": 325.0, \"fy\": 135.71428571428572, \"y\": 135.71428571428572}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 10, \"ts_flags\": 0, \"time\": 272.05118690557765, \"child_of\": [11, 12], \"parent_of\": [4, 6, 7, 8], \"x_pos_reference\": -1, \"label\": \"10\", \"x\": 325.0, \"fy\": 107.14285714285717, \"y\": 107.14285714285717}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 11, \"ts_flags\": 0, \"time\": 610.912738605865, \"child_of\": [], \"parent_of\": [9, 10], \"x_pos_reference\": -1, \"label\": \"11\", \"x\": 325.0, \"fy\": 78.57142857142858, \"y\": 78.57142857142858}, {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4, \"id\": 12, \"ts_flags\": 0, \"time\": 1382.4658244607965, \"child_of\": [], \"parent_of\": [9, 10], \"x_pos_reference\": -1, \"label\": \"12\", \"x\": 325.0, \"fy\": 50.0, \"y\": 50.0}], \"links\": [{\"id\": 0, \"source\": 6, \"source_time\": 56.0454802286223, \"target\": 1, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 3, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 1, \"source\": 6, \"source_time\": 56.0454802286223, \"target\": 3, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 1, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 2, \"source\": 7, \"source_time\": 120.7850821708138, \"target\": 5, \"target_time\": 0.0, \"bounds\": \"6516.940179280937-10000.0\", \"alt_parent\": -1, \"alt_child\": 6, \"region_fraction\": 0.34830598207190633, \"stroke\": \"#053e4e\"}, {\"id\": 3, \"source\": 7, \"source_time\": 120.7850821708138, \"target\": 6, \"target_time\": 56.0454802286223, \"bounds\": \"6516.940179280937-10000.0\", \"alt_parent\": -1, \"alt_child\": 5, \"region_fraction\": 0.34830598207190633, \"stroke\": \"#053e4e\"}, {\"id\": 4, \"source\": 8, \"source_time\": 142.86643656492956, \"target\": 4, \"target_time\": 0.0, \"bounds\": \"0.0-6516.940179280937\", \"alt_parent\": -1, \"alt_child\": 5, \"region_fraction\": 0.6516940179280937, \"stroke\": \"#053e4e\"}, {\"id\": 5, \"source\": 8, \"source_time\": 142.86643656492956, \"target\": 5, \"target_time\": 0.0, \"bounds\": \"0.0-6516.940179280937\", \"alt_parent\": -1, \"alt_child\": 4, \"region_fraction\": 0.6516940179280937, \"stroke\": \"#053e4e\"}, {\"id\": 6, \"source\": 9, \"source_time\": 236.7237255340037, \"target\": 0, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 2, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 7, \"source\": 9, \"source_time\": 236.7237255340037, \"target\": 2, \"target_time\": 0.0, \"bounds\": \"0.0-10000.0\", \"alt_parent\": -1, \"alt_child\": 0, \"region_fraction\": 1.0, \"stroke\": \"#053e4e\"}, {\"id\": 8, \"source\": 10, \"source_time\": 272.05118690557765, \"target\": 4, \"target_time\": 0.0, \"bounds\": \"6516.940179280937-10000.0\", \"alt_parent\": -1, \"alt_child\": 6, \"region_fraction\": 0.34830598207190633, \"stroke\": \"#053e4e\"}, {\"id\": 9, \"source\": 10, \"source_time\": 272.05118690557765, \"target\": 6, \"target_time\": 56.0454802286223, \"bounds\": \"0.0-6516.940179280937\", \"alt_parent\": -1, \"alt_child\": 4, \"region_fraction\": 0.6516940179280937, \"stroke\": \"#053e4e\"}, {\"id\": 10, \"source\": 10, \"source_time\": 272.05118690557765, \"target\": 7, \"target_time\": 120.7850821708138, \"bounds\": \"6516.940179280937-10000.0\", \"alt_parent\": -1, \"alt_child\": 4, \"region_fraction\": 0.34830598207190633, \"stroke\": \"#053e4e\"}, {\"id\": 11, \"source\": 10, \"source_time\": 272.05118690557765, \"target\": 8, \"target_time\": 142.86643656492956, \"bounds\": \"0.0-6516.940179280937\", \"alt_parent\": -1, \"alt_child\": 4, \"region_fraction\": 0.6516940179280937, \"stroke\": \"#053e4e\"}, {\"id\": 12, \"source\": 11, \"source_time\": 610.912738605865, \"target\": 9, \"target_time\": 236.7237255340037, \"bounds\": \"2601.014547981321-10000.0\", \"alt_parent\": -1, \"alt_child\": 10, \"region_fraction\": 0.7398985452018679, \"stroke\": \"#053e4e\"}, {\"id\": 13, \"source\": 11, \"source_time\": 610.912738605865, \"target\": 10, \"target_time\": 272.05118690557765, \"bounds\": \"2601.014547981321-10000.0\", \"alt_parent\": -1, \"alt_child\": 9, \"region_fraction\": 0.7398985452018679, \"stroke\": \"#053e4e\"}, {\"id\": 14, \"source\": 12, \"source_time\": 1382.4658244607965, \"target\": 9, \"target_time\": 236.7237255340037, \"bounds\": \"0.0-2601.014547981321\", \"alt_parent\": -1, \"alt_child\": 10, \"region_fraction\": 0.26010145479813207, \"stroke\": \"#053e4e\"}, {\"id\": 15, \"source\": 12, \"source_time\": 1382.4658244607965, \"target\": 10, \"target_time\": 272.05118690557765, \"bounds\": \"0.0-2601.014547981321\", \"alt_parent\": -1, \"alt_child\": 9, \"region_fraction\": 0.26010145479813207, \"stroke\": \"#053e4e\"}], \"mutations\": [], \"breakpoints\": [{\"id\": 0, \"start\": 0.0, \"stop\": 2601.014547981321, \"x_pos_01\": 0.0, \"width_01\": 0.26010145479813207, \"fill\": \"#053e4e\", \"x_pos\": 100.0, \"width\": 117.04565465915942, \"included\": \"true\"}, {\"id\": 1, \"start\": 2601.014547981321, \"stop\": 6516.940179280937, \"x_pos_01\": 0.26010145479813207, \"width_01\": 0.3915925631299616, \"fill\": \"#053e4e\", \"x_pos\": 217.04565465915942, \"width\": 176.21665340848273, \"included\": \"true\"}, {\"id\": 2, \"start\": 6516.940179280937, \"stop\": 10000.0, \"x_pos_01\": 0.6516940179280937, \"width_01\": 0.34830598207190633, \"fill\": \"#053e4e\", \"x_pos\": 393.26230806764215, \"width\": 156.73769193235785, \"included\": \"true\"}], \"evenly_distributed_positions\": [150.0, 220.0, 290.0, 360.0, 430.0, 500.0]}, \"width\": 550, \"height\": 375, \"y_axis\": {\"title\": \"Time ago (generations)\", \"units\": \"generations\", \"include_labels\": \"true\", \"ticks\": [250.0, 221.42857142857144, 192.85714285714286, 164.28571428571428, 135.71428571428572, 107.14285714285717, 78.57142857142858, 50.0], \"text\": [0, 56, 121, 143, 237, 272, 611, 1382], \"max_min\": [250.0, 50.0], \"scale\": \"rank\"}, \"edges\": {\"type\": \"line\", \"variable_width\": false, \"include_underlink\": true}, \"condense_mutations\": false, \"label_mutations\": false, \"tree_highlighting\": true, \"rotate_tip_labels\": false, \"plot_type\": \"full\", \"default_node_style\": {\"size\": 150, \"symbol\": \"d3.symbolCircle\", \"fill\": \"#1eebb1\", \"stroke\": \"#053e4e\", \"stroke_width\": 4}, \"title\": null, \"preamble\": null, \"save_filename\": \"tskit_arg_visualizer\"}", "tskit_arg_visualizer")
        });
    })
    .catch(err => console.error('Failed to load require.js:', err));

</script></div></div>
</div>
<p>These “simplified” graphs are what are produced as the default <code class="docutils literal notranslate"><span class="pre">msprime</span></code> output. The
exact SPR moves from tree to tree may no longer be obvious, and the ARG likelihood
cannot be calculated from a tree sequence of this form.</p>
<p>Note that we can still calculate the <em>mutation likelihood</em>
(i.e. the likelihood of the observed pattern of mutations, given the genealogy) because
the topology and branch lengths of the local trees remain unchanged after simplification:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Log likelihood of mutations given the genealogy:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &quot;full&quot; ARG:&#39;</span><span class="p">,</span>  <span class="n">msprime</span><span class="o">.</span><span class="n">log_mutation_likelihood</span><span class="p">(</span><span class="n">ts_arg</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="o">=</span><span class="n">mu</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; simplified:&quot;</span><span class="p">,</span> <span class="n">msprime</span><span class="o">.</span><span class="n">log_mutation_likelihood</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="o">=</span><span class="n">mu</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Log likelihood of mutations given the genealogy:
 &quot;full&quot; ARG: -33.204860594400216
 simplified: -33.204860594400216
</pre></div>
</div>
</div>
</div>
</section>
<section id="disadvantages-of-full-args">
<span id="sec-args-disadvantages"></span><h2>Disadvantages of Full ARGs<a class="headerlink" href="#disadvantages-of-full-args" title="Link to this heading">#</a></h2>
<p>There are two main reasons why you might <em>not</em> want to store a full ARG, but instead use
a simplified version. Firstly if you are inferring ARGs from real data (rather than simulating
them), it may not be possible or even desirable to infer recombination events. Often
there are many possible recombination events which are compatible with a given
set of recombined genome sequences.</p>
<p>Secondly, even if you <em>are</em> simulating genetic ancestry, storing full ARG requires many extra nodes.
In fact, as the sequence length increases, the non-coalescent nodes come
to dominate the tree sequence.
We can calculate the percentage of non-coalescent nodes by comparing a full ARG with
its simplified version:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">large_sim_parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">large_sim_parameters</span><span class="p">[</span><span class="s2">&quot;sequence_length&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1000</span>
<span class="n">large_ts_arg</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">sim_ancestry</span><span class="p">(</span>
    <span class="o">**</span><span class="n">large_sim_parameters</span><span class="p">,</span>
    <span class="n">discrete_genome</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># not technically needed, as we aren&#39;t calculating likelihoods</span>
    <span class="n">coalescing_segments_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">additional_nodes</span><span class="o">=</span><span class="n">msprime</span><span class="o">.</span><span class="n">NodeType</span><span class="o">.</span><span class="n">COMMON_ANCESTOR</span> <span class="o">|</span> <span class="n">msprime</span><span class="o">.</span><span class="n">NodeType</span><span class="o">.</span><span class="n">RECOMBINANT</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">large_ts</span> <span class="o">=</span> <span class="n">large_ts_arg</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Non-coalescent nodes take up &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">large_ts</span><span class="o">.</span><span class="n">num_nodes</span><span class="o">/</span><span class="n">large_ts_arg</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;of this </span><span class="si">{</span><span class="n">large_ts</span><span class="o">.</span><span class="n">sequence_length</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> megabase </span><span class="si">{</span><span class="n">large_ts</span><span class="o">.</span><span class="n">num_samples</span><span class="si">}</span><span class="s2">-tip ARG&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Non-coalescent nodes take up 99.32% of this 10 megabase 6-tip ARG
</pre></div>
</div>
</div>
</div>
<p>This is one of the primary reasons that nodes which are never associated with coalescent
events are excluded by default in simulation software such as
<a class="reference external" href="https://tskit.dev/software/msprime.html">msprime</a> and
<a class="reference external" href="https://tskit.dev/software/SLiM.html">SLiM</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As well as ancestrally relevant nodes, the original (mathematical) ARG formulation by
<a class="reference external" href="https://www.jstor.org/stable/4355649">Griffiths (1991)</a> includes recombination
nodes that are not ancestral to the samples. This leads to a graph with an
vastly larger number of nodes than even the ARGs simulated here, and using such
structures for simulation or inference is therefore infeasible.</p>
</div>
</section>
<section id="arg-formats-and-tskit">
<h2>ARG formats and <code class="docutils literal notranslate"><span class="pre">tskit</span></code><a class="headerlink" href="#arg-formats-and-tskit" title="Link to this heading">#</a></h2>
<p>It is worth noting a subtle and somewhat philosophical
difference between some classical ARG formulations, and the ARG formulation
used in <code class="docutils literal notranslate"><span class="pre">tskit</span></code>. Classically, nodes in an ARG are taken to represent <em>events</em>
(specifically, “common ancestor”, “recombination”, and “sampling” events),
and genomic regions of inheritance are encoded by storing a specific breakpoint location on
each recombination node. In contrast, <a class="reference external" href="https://tskit.dev/tskit/docs/stable/glossary.html#sec-data-model-definitions-node" title="(in Project name not set)"><span class="xref std std-ref">nodes</span></a> in a <code class="docutils literal notranslate"><span class="pre">tskit</span></code>
ARG correspond to <em>genomes</em>. More crucially, inherited regions are defined by intervals
stored on <em>edges</em> (via the <a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.Edge.left" title="(in Project name not set)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">left</span></code></a> and  <a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.Edge.right" title="(in Project name not set)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">right</span></code></a> properties),
rather than on nodes. Here, for example, is the edge table from our ARG:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_arg</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">edges</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <div>
            <style scoped="">
                .tskit-table tbody tr th:only-of-type {vertical-align: middle;}
                .tskit-table tbody tr th {vertical-align: top;}
                .tskit-table tbody td {text-align: right;padding: 0.5em 0.5em;}
                .tskit-table tbody th {padding: 0.5em 0.5em;}
            </style>
            <table border="1" class="tskit-table">
                <thead>
                    <tr>
                        <th>id</th><th>left</th><th>right</th><th>parent</th><th>child</th><th>metadata</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>0</td><td>0.00000000</td><td>10,000.00000000</td><td>6</td><td>1</td><td></td></tr>
<tr><td>1</td><td>0.00000000</td><td>10,000.00000000</td><td>6</td><td>3</td><td></td></tr>
<tr><td>2</td><td>0.00000000</td><td>6,516.94017928</td><td>7</td><td>5</td><td></td></tr>
<tr><td>3</td><td>6,516.94017928</td><td>10,000.00000000</td><td>8</td><td>5</td><td></td></tr>
<tr><td>4</td><td>0.00000000</td><td>10,000.00000000</td><td>9</td><td>6</td><td></td></tr>
<tr><td>5</td><td>6,516.94017928</td><td>10,000.00000000</td><td>9</td><td>8</td><td></td></tr>
<tr><td>6</td><td>0.00000000</td><td>10,000.00000000</td><td>10</td><td>4</td><td></td></tr>
<tr><td>7</td><td>0.00000000</td><td>6,516.94017928</td><td>10</td><td>7</td><td></td></tr>
<tr><td>8</td><td>0.00000000</td><td>10,000.00000000</td><td>11</td><td>0</td><td></td></tr>
<tr><td>9</td><td>0.00000000</td><td>10,000.00000000</td><td>11</td><td>2</td><td></td></tr>
<tr><td>10</td><td>0.00000000</td><td>10,000.00000000</td><td>12</td><td>9</td><td></td></tr>
<tr><td>11</td><td>0.00000000</td><td>10,000.00000000</td><td>12</td><td>10</td><td></td></tr>
<tr><td>12</td><td>0.00000000</td><td>2,601.01454798</td><td>13</td><td>12</td><td></td></tr>
<tr><td>13</td><td>2,601.01454798</td><td>10,000.00000000</td><td>14</td><td>12</td><td></td></tr>
<tr><td>14</td><td>0.00000000</td><td>10,000.00000000</td><td>15</td><td>11</td><td></td></tr>
<tr><td>15</td><td>2,601.01454798</td><td>10,000.00000000</td><td>15</td><td>14</td><td></td></tr>
<tr><td>16</td><td>0.00000000</td><td>2,601.01454798</td><td>16</td><td>13</td><td></td></tr>
<tr><td>17</td><td>0.00000000</td><td>2,601.01454798</td><td>16</td><td>15</td><td></td></tr>

                </tbody>
            </table>
        </div>
    </div></div>
</div>
<p>Technically therefore, ARGs stored by <code class="docutils literal notranslate"><span class="pre">tskit</span></code> are edge-annotated
“genome ARGs”, or <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2023.11.03.565466v1">gARGs</a>.
This flexible format can describe both simulated genetic ancestries (including
those involving <a class="reference external" href="https://tskit.dev/msprime/docs/stable/ancestry.html#sec-ancestry-gene-conversion" title="(in Project name not set)"><span>Gene conversion</span></a>), and e.g. real-world
genetic ancestries, such as
<a class="reference external" href="https://www.biorxiv.org/content/10.1101/2023.06.08.544212v1">inferrred recombining viral genealogies</a>.
The focus on genomes rather than events is also what makes
simplification possible, and means <code class="docutils literal notranslate"><span class="pre">tskit</span></code> can encode ancestry without having
to pin down exactly when specific ancestral events took place.</p>
</section>
<section id="working-with-args-in-tskit">
<h2>Working with ARGs in <code class="docutils literal notranslate"><span class="pre">tskit</span></code><a class="headerlink" href="#working-with-args-in-tskit" title="Link to this heading">#</a></h2>
<p>All tree sequences, including, but not limited to full ARGs, can be treated as
directed (acyclic) graphs. Although many tree sequence operations operate from left to
right along the genome, some are more naturally though of as passing from node
to node via the edges, regardless of the genomic position of the edge. This section
describes some of these fundamental graph operations.</p>
<section id="graph-traversal">
<h3>Graph traversal<a class="headerlink" href="#graph-traversal" title="Link to this heading">#</a></h3>
<p>The standard edge iterator, <a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.TreeSequence.edge_diffs" title="(in Project name not set)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TreeSequence.edge_diffs()</span></code></a>, goes from left to
right along the genome, matching the <a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.TreeSequence.trees" title="(in Project name not set)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TreeSequence.trees()</span></code></a> iterator. Although
this will visit all the edges in the graph, these will <em>not</em> necessarily be grouped
by the node ID either of the edge parent or the edge child. To do this, an alternative
traversal (from top-to-bottom or bottom-to-top of the tree sequence) is required.</p>
<p>To traverse the graph by node ID, the <a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.TreeSequence.nodes" title="(in Project name not set)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TreeSequence.nodes()</span></code></a> iterator can be
used. In particular, because parents are required to be strictly older than their
children, iterating through nodes using <code class="docutils literal notranslate"><span class="pre">order=&quot;timeasc&quot;</span></code> will ensure that children
are always visited before their parents (similar to a breadth-first or “level order”
search). However, using <a class="reference external" href="https://tskit.dev/tskit/docs/stable/python-api.html#tskit.TreeSequence.nodes" title="(in Project name not set)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TreeSequence.nodes()</span></code></a> is inefficient if you also
want to access the <em>edges</em> associated with each node.</p>
<p>The examples below show how to efficiently visit the all the edges in a
tree sequence, grouped by the nodes to which they are connected, while
also ensuring that children are visited before parents (or vice versa).</p>
<section id="traversing-parent-nodes">
<h4>Traversing parent nodes<a class="headerlink" href="#traversing-parent-nodes" title="Link to this heading">#</a></h4>
<p>The most efficient graph traversal method visits all the parent nodes in the
tree sequence, grouping edges for which that node is a parent. This is simple
because edges in a tree sequence are <a class="reference external" href="https://tskit.dev/tskit/docs/stable/data-model.html#sec-edge-requirements" title="(in Project name not set)"><span class="xref std std-ref">ordered</span></a>
firstly by the time of the parent node, then by node ID.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edges_by_parent_timeasc</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">edges</span><span class="p">(),</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">edges</span> <span class="ow">in</span> <span class="n">edges_by_parent_timeasc</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span><span class="o">.</span><span class="n">time</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="o">.</span><span class="n">child</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">parent_id</span><span class="si">}</span><span class="s2"> at time </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> has these child node IDs: </span><span class="si">{</span><span class="n">children</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Node 6 at time 56.0454802286223 has these child node IDs: {1, 3}
Node 7 at time 120.7850821708138 has these child node IDs: {5, 6}
Node 8 at time 142.86643656492956 has these child node IDs: {4, 5}
Node 9 at time 236.7237255340037 has these child node IDs: {0, 2}
Node 10 at time 272.05118690557765 has these child node IDs: {8, 4, 6, 7}
Node 11 at time 610.912738605865 has these child node IDs: {9, 10}
Node 12 at time 1382.4658244607965 has these child node IDs: {9, 10}
</pre></div>
</div>
</div>
</div>
<p>This visits children before parents. To visit parents before children, you can
simply use <code class="docutils literal notranslate"><span class="pre">reversed(ts.edges())</span></code> rather than <code class="docutils literal notranslate"><span class="pre">ts.edges()</span></code> within the
<code class="docutils literal notranslate"><span class="pre">groupby</span></code> function. Note that terminal nodes (i.e. which are either isolated
or leaf nodes in all local trees) are not visited by this function: therefore
the method above will omit all the terminal sample nodes.</p>
</section>
<section id="traversing-child-nodes">
<h4>Traversing child nodes<a class="headerlink" href="#traversing-child-nodes" title="Link to this heading">#</a></h4>
<p>Sometimes you may wish to iterate over all the edges for which a node is a
child (rather than a parent). This can be done by sorting the edges by
child node time (then child node id). This is a little slower, but can be
done relatively efficiently as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edges_by_child_timeasc</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="c1"># edges sorted by child node time, then child node id using np.lexsort</span>
    <span class="n">it</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">ts</span><span class="o">.</span><span class="n">edges_child</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">nodes_time</span><span class="p">[</span><span class="n">ts</span><span class="o">.</span><span class="n">edges_child</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">child_id</span><span class="p">,</span> <span class="n">edges</span> <span class="ow">in</span> <span class="n">edges_by_child_timeasc</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">child_id</span><span class="p">)</span><span class="o">.</span><span class="n">time</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">child_id</span><span class="si">}</span><span class="s2"> at time </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> has these parent node IDs: </span><span class="si">{</span><span class="n">parents</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Node 0 at time 0.0 has these parent node IDs: {9}
Node 1 at time 0.0 has these parent node IDs: {6}
Node 2 at time 0.0 has these parent node IDs: {9}
Node 3 at time 0.0 has these parent node IDs: {6}
Node 4 at time 0.0 has these parent node IDs: {8, 10}
Node 5 at time 0.0 has these parent node IDs: {8, 7}
Node 6 at time 56.0454802286223 has these parent node IDs: {10, 7}
Node 7 at time 120.7850821708138 has these parent node IDs: {10}
Node 8 at time 142.86643656492956 has these parent node IDs: {10}
Node 9 at time 236.7237255340037 has these parent node IDs: {11, 12}
Node 10 at time 272.05118690557765 has these parent node IDs: {11, 12}
</pre></div>
</div>
</div>
</div>
<p>To visit parents before children, the <code class="docutils literal notranslate"><span class="pre">lexsort</span></code> can take the negated
<code class="docutils literal notranslate"><span class="pre">-ts.nodes_time</span></code> rather than simply using <code class="docutils literal notranslate"><span class="pre">ts.nodes_time</span></code>. Note that nodes
which are never children of an edge are not visited by this algorithm. Such
nodes are either <a class="reference external" href="https://tskit.dev/tskit/docs/stable/data-model.html#sec-data-model-tree-isolated-nodes" title="(in Project name not set)"><span class="xref std std-ref">isolated</span></a> or a
<a class="reference external" href="https://tskit.dev/tskit/docs/stable/data-model.html#sec-data-model-tree-roots" title="(in Project name not set)"><span class="xref std std-ref">root</span></a> in each local tree.</p>
</section>
</section>
<section id="other-graph-analysis">
<span id="sec-args-other-analysis"></span><h3>Other graph analysis<a class="headerlink" href="#other-graph-analysis" title="Link to this heading">#</a></h3>
<p>For graph-theory based analysis, it can be helpful to convert a tree sequence
to a <a class="reference external" href="https://networkx.org/">networkx</a> graph. This can be done using the
following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tskit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_networkx_graph</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">interval_lists</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make an nx graph from a tree sequence. If `intervals_lists` is True, then</span>
<span class="sd">    each graph edge will have an ``intervals`` attribute containing a *list*</span>
<span class="sd">    of tskit.Intervals per parent/child combination. Otherwise each graph edge</span>
<span class="sd">    will correspond to a tskit edge, with a ``left`` and ``right`` attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">D</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">edges_parent</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">edges_child</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">edges_left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">edges_right</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_pandas_edgelist</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">D</span><span class="p">),</span> <span class="n">edge_attr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interval_lists</span><span class="p">:</span>
        <span class="n">GG</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>  <span class="c1"># Mave a new graph with one edge that can contai</span>
        <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">adjacency</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">child</span><span class="p">,</span> <span class="n">edict</span> <span class="ow">in</span> <span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ilist</span> <span class="o">=</span> <span class="p">[</span><span class="n">tskit</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">edict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="n">GG</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">intervals</span><span class="o">=</span><span class="n">ilist</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">GG</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;flags&#39;</span><span class="p">:</span><span class="n">n</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">time</span><span class="p">}</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">nodes</span><span class="p">()})</span>
    <span class="k">return</span> <span class="n">G</span>

<span class="n">arg</span> <span class="o">=</span> <span class="n">to_networkx_graph</span><span class="p">(</span><span class="n">ts_arg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>It is then possible to use the full range of networkx functions to analyse the graph:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_directed_acyclic_graph</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># All ARGs should be DAGs</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All descendants of node 10 are&quot;</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>All descendants of node 10 are {4, 5, 7}
</pre></div>
</div>
</div>
</div>
<p>Networkx also has some built-in drawing functions: below is one of the simplest ones
(for other possibilities, see the <a class="reference internal" href="viz.html#sec-tskit-viz"><span class="std std-ref">Visualization</span></a> tutorial).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_generations</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">reverse</span><span class="p">())):</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">arg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">multipartite_layout</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">subset_key</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>

<span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/21af355d7d270be5c8928661bffd5db0b2b532332bfa2853e669cfdab88c5526.png" src="_images/21af355d7d270be5c8928661bffd5db0b2b532332bfa2853e669cfdab88c5526.png" />
</div>
</div>
</section>
</section>
<section id="other-software">
<h2>Other software<a class="headerlink" href="#other-software" title="Link to this heading">#</a></h2>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Show how ARGweaver output can be converted to tskit form.</p>
</div>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<p>Show how KwARG output can be converted to tskit form.</p>
</div>
<div class="admonition-todo admonition" id="id3">
<p class="admonition-title">Todo</p>
<p>Implement conversion between the <em>msprime</em> 2 RE node version and the more conventional 1 RE node version. See https://github.com/tskit-dev/msprime/issues/1942 for extensive discussion on the advantages / disadvantages of using 2 nodes vs 1 node-with-metadata.</p>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="metadata.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Working with Metadata</p>
      </div>
    </a>
    <a class="right-next"
       href="simulation_overview.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tree sequences and simulation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#full-args">Full ARGs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#local-trees-and-arity">Local trees and arity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sprs-and-recombination">SPRs and recombination</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-likelihoods">Calculating likelihoods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simplification">Simplification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#disadvantages-of-full-args">Disadvantages of Full ARGs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arg-formats-and-tskit">ARG formats and <code class="docutils literal notranslate"><span class="pre">tskit</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-args-in-tskit">Working with ARGs in <code class="docutils literal notranslate"><span class="pre">tskit</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#graph-traversal">Graph traversal</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#traversing-parent-nodes">Traversing parent nodes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#traversing-child-nodes">Traversing child nodes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-graph-analysis">Other graph analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-software">Other software</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tskit Developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>