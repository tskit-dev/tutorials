
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Introgression &#8212; Tree Sequence Tutorials</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/tskit-book-theme.css?digest=4e121f05f62280197eeb3e8760a1903920f0778f" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/scripts/tskit-book-theme.js?digest=9a6366feaade5ec470560844be9ff19788eb9b85"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Building a forward simulator" href="forward_sims.html" />
    <link rel="prev" title="Instantaneous Bottlenecks" href="bottlenecks.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/tskit_logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Tree Sequence Tutorials</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="what_is.html">
   What is a tree sequence?
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tree sequence basics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="terminology_and_concepts.html">
   Terminology &amp; concepts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="getting_started.html">
   Getting started with
   <strong class="program">
    tskit
   </strong>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Statistics and Analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="analysing_tree_sequences.html">
   <em>
    Analysing tree sequences
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="analysing_trees.html">
   Analysing trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="counting_topologies.html">
   <em>
    Counting topologies
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parallelization.html">
   <em>
    Parallelization
   </em>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Further tskit tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="tables_and_editing.html">
   Tables and editing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="simplification.html">
   <em>
    Simplification
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="viz.html">
   Visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="metadata.html">
   Working with Metadata
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="args.html">
   <em>
    ARGs as tree sequences
   </em>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Simulation
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="simulation_overview.html">
   Tree sequences and simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="no_mutations.html">
   Do you really need mutations?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="completing_forward_sims.html">
   Completing forwards simulations
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="advanced_msprime.html">
   Advanced
   <strong class="program">
    msprime
   </strong>
   topics
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="demography.html">
     Demography
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="bottlenecks.html">
     Instantaneous Bottlenecks
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Introgression
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="forward_sims.html">
   <em>
    Building a forward simulator
   </em>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other languages
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="tskitr.html">
   Tskit and R
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Development
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="tutorial_development.html">
   <em>
    Developing new tutorials
   </em>
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/tskit-dev/tutorials"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/tskit-dev/tutorials/issues/new?title=Issue%20on%20page%20%2Fintrogression.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/introgression.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="_sources/introgression.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#locating-mutations">
   Locating mutations
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Introgression</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#locating-mutations">
   Locating mutations
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="introgression">
<span id="sec-msprime-introgression"></span><h1>Introgression<a class="headerlink" href="#introgression" title="Permalink to this headline">#</a></h1>
<p><strong>Jerome Kelleher and Konrad Lohse</strong></p>
<p>There has been great interest in understanding the contributions past populations have made to the genetic diversity of current populations via <a class="reference external" href="https://en.wikipedia.org/wiki/Genetic_admixture">admixture</a>. In particular, the availability of whole genome sequence data from archaic hominins (<a class="reference external" href="http://doi.org/10.1126/science.1188021">Green et al., 2010</a>) has allowed geneticists to identify admixture tracks (<a class="reference external" href="http://doi.org/10.1016/j.cub.2016.03.037">Sankararaman, 2016</a>). In the simplest case, admixture tracts can be defined heuristically as regions of the genome that show excessive similarity between a putative source and a recipient population (usually quantified relative to some non-admixed reference population, see <a class="reference external" href="http://doi.org/10.1093/molbev/msr048">Durand et al., 2011</a>). Because recombination breaks down admixture tracts, their length distribution gives a clock for calibrating admixture and this information has been used to date the admixure contributions Neanderthals and other archaic hominins have made to non-African modern human populations (<a class="reference external" href="http://doi.org/10.1016/j.cub.2016.03.037">Sankararamanm 2016</a>)</p>
<p>Crucially, the power to identify admixture depends on the relative time between the admixture event and the earlier divergence between source and recipient population: the shorter this interval, the harder it is to detect admixture. This is because samples from the source and recipient poulations are increasingly likely to share local ancestry regardless of recent admixture. In other words, it becomes increasingly difficult to distinguish admixture from <a class="reference external" href="https://en.wikipedia.org/wiki/Incomplete_lineage_sorting">incomplete lineage sorting</a> (ILS).</p>
<p>In the following section we use <strong class="program">msprime</strong> simulations to ask what fraction of admixture tracts are identifiable as such.</p>
<p>To illustrate this, we simulate genetic ancestry under a very simple toy history of divergence and admixture which is loosely motivated by the demographic history of modern humans and Neanderthals. As suggested in <a class="reference internal" href="no_mutations.html#sec-tskit-no-mutations"><span class="std std-ref">other tutorial material</span></a>, we will first examine properties of the resulting tree sequence directly, rather than use it to simulate mutations. We assume a minimal sample of a single (haploid) genome from a modern human population in Africa and Eurasia as well as an ancient Neanderthal sample.</p>
<p>In the resulting tree sequence we want to distinguish three categories of segments: i) tracts actually involved in Neanderthal admixture, ii) the subset of those tracts in which the Eurasian and Neanderthal lineages we have sampled coalesce within the Neanderthal population and iii) segments at which the Eurasian and Neanderthal lineages are more closely related to each other than either are to the African lineage. The last category is interesting because it is the only one that can be unambiguously detected in data (via derived mutations that are shared by Neanderthals and Eurasians). However, while it must include all of ii), it also contains an additional set of short tracts that are due to ILS.</p>
<p>First we set up a highly simplified demographic history of human+Neanderthal demography and simulate a single chromosome of 20Mb in length:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">msprime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">run_simulation</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">time_units</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">25</span>  <span class="c1"># Conversion factor for kya to generations</span>
    <span class="n">demography</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">Demography</span><span class="p">()</span>
    <span class="c1"># The same size for all populations; highly unrealistic!</span>
    <span class="n">Ne</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span>
    <span class="n">demography</span><span class="o">.</span><span class="n">add_population</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Africa&quot;</span><span class="p">,</span> <span class="n">initial_size</span><span class="o">=</span><span class="n">Ne</span><span class="p">)</span>
    <span class="n">demography</span><span class="o">.</span><span class="n">add_population</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Eurasia&quot;</span><span class="p">,</span> <span class="n">initial_size</span><span class="o">=</span><span class="n">Ne</span><span class="p">)</span>
    <span class="n">demography</span><span class="o">.</span><span class="n">add_population</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Neanderthal&quot;</span><span class="p">,</span> <span class="n">initial_size</span><span class="o">=</span><span class="n">Ne</span><span class="p">)</span>

    <span class="c1"># 2% introgression 50 kya</span>
    <span class="n">demography</span><span class="o">.</span><span class="n">add_mass_migration</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="mi">50</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;Eurasia&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;Neanderthal&#39;</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="c1"># Eurasian &#39;merges&#39; backwards in time into Africa population, 70 kya</span>
    <span class="n">demography</span><span class="o">.</span><span class="n">add_mass_migration</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="mi">70</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;Eurasia&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;Africa&#39;</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Neanderthal &#39;merges&#39; backwards in time into African population, 300 kya</span>
    <span class="n">demography</span><span class="o">.</span><span class="n">add_mass_migration</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="mi">300</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;Neanderthal&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;Africa&#39;</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">sim_ancestry</span><span class="p">(</span>
        <span class="n">recombination_rate</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span>  
        <span class="n">samples</span><span class="o">=</span><span class="p">[</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">SampleSet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ploidy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="s1">&#39;Africa&#39;</span><span class="p">),</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">SampleSet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ploidy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="s1">&#39;Eurasia&#39;</span><span class="p">),</span>
            <span class="c1"># Neanderthal sample taken 30 kya</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">SampleSet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ploidy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="s1">&#39;Neanderthal&#39;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">demography</span> <span class="o">=</span> <span class="n">demography</span><span class="p">,</span>
        <span class="n">record_migrations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Needed for tracking segments.</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation of </span><span class="si">{</span><span class="n">sequence_length</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="si">}</span><span class="s2">Mb run, using record_migrations=True&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;NB: time diff from Neanderthal split to admixture event is&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">300</span> <span class="o">*</span> <span class="n">time_units</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">time_units</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> gens&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="p">(</span><span class="mi">300</span> <span class="o">*</span> <span class="n">time_units</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">Ne</span><span class="si">}</span><span class="s2"> coalescence units)&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simulation of 20.0Mb run, using record_migrations=True
NB: time diff from Neanderthal split to admixture event is 10000 gens (0.5 coalescence units)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">record_migrations</span></code> option allows us to track segments of ancestral material that migrate from the Eurasian population into the Neanderthal population (backwards in time). We can then examine the length distributions of these segments and compare them with the length of the segments that also go on to coalesce within the Neanderthal population.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_migrating_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">neanderthal_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">populations</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Neanderthal&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">migrating_tracts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Get all tracts that migrated into the neanderthal population</span>
    <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">migrations</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">migration</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="n">neanderthal_id</span><span class="p">:</span>
            <span class="n">migrating_tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">migration</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">migrating_tracts</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">get_coalescing_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">neanderthal_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">populations</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Neanderthal&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coalescing_tracts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">trees</span><span class="p">():</span>
        <span class="c1"># 1 is the Eurasian sample and 2 is the Neanderthal</span>
        <span class="n">mrca_pop</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">mrca</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">population</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mrca_pop</span> <span class="o">==</span> <span class="n">neanderthal_id</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Start a new tract</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="n">left</span>      
        <span class="k">elif</span> <span class="n">mrca_pop</span> <span class="o">!=</span> <span class="n">neanderthal_id</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># End the last tract</span>
            <span class="n">coalescing_tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coalescing_tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coalescing_tracts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_eur_nea_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">tracts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">trees</span><span class="p">():</span>
        <span class="c1"># 1 is the Eurasian sample and 2 is the Neanderthal</span>
        <span class="n">mrca</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">mrca</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mrca</span> <span class="o">!=</span> <span class="n">tree</span><span class="o">.</span><span class="n">root</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Start a new tract</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="n">left</span>      
        <span class="k">elif</span> <span class="n">mrca</span> <span class="o">==</span> <span class="n">tree</span><span class="o">.</span><span class="n">root</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># End the last tract</span>
            <span class="n">tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tracts</span><span class="p">)</span>

                                    
<span class="n">migrating</span> <span class="o">=</span> <span class="n">get_migrating_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<span class="n">within_nea</span> <span class="o">=</span> <span class="n">get_coalescing_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<span class="n">eur_nea</span> <span class="o">=</span> <span class="n">get_eur_nea_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We build three different lists. The first is the set of tracts that exist in the Eurasian genome because they have come from Neanderthals via admixture at time <span class="math notranslate nohighlight">\(T_{ad}\)</span> (be careful here: in <a class="reference external" href="https://tskit.dev/msprime/docs/stable/demography.html#sec-demography-direction-of-time" title="(in Python)"><span class="xref std std-ref">reverse time terminology</span></a>, we denote the “source” population as Eurasian and the “destination” population as Neanderthals). This is done simply by finding all migration records in which the “destination” population name is <code class="docutils literal notranslate"><span class="pre">Neanderthal</span></code>. The second list (which must contain a subset of the segments in the first list) is the ancestral segments that went on to coalesce within the Neanderthal population. The third list contains all segments in which the Eurasian and Neanderthal sample coalesce before their ancestor coalesces with the African sample. The third list includes both Eurasian segments of Neanderthal origin and segments that did not migrate but coalesce further back in time than the Neanderthal-Human population split at <span class="math notranslate nohighlight">\(T_{split}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">migrating_l</span> <span class="o">=</span> <span class="n">migrating</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">migrating</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">migrating_l</span><span class="p">)</span><span class="si">}</span><span class="s2"> migrating tracts of total length </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">migrating_l</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">migrating_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">migrating_l</span><span class="p">)</span>
<span class="n">within_nea_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">within_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">within_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">nea_eur_closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">migrating_total</span><span class="p">,</span> <span class="n">within_nea_total</span><span class="p">,</span> <span class="n">nea_eur_closest</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total lengths:&quot;</span><span class="p">,</span> <span class="n">totals</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proportions:&quot;</span><span class="p">,</span> <span class="n">totals</span><span class="o">/</span><span class="n">ts</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 5 migrating tracts of total length 373730.0
Total lengths: [ 373730.  165617. 4475561.]
Proportions: [0.0186865  0.00828085 0.22377805]
</pre></div>
</div>
</div>
</div>
<p>The total length of admixed segments is about 1.9% of the chromosome, which accords with our migration fraction of <span class="math notranslate nohighlight">\(f=0.02\)</span> (although since this is only made up of 5 tracts, we might expect considerable random variation in this percentage). We expect a proportion <span class="math notranslate nohighlight">\(1-e^{-(T_{split}-T_{ad})}\)</span> of admixed lineages to coalesce, where <span class="math notranslate nohighlight">\(T_{split}\)</span> and <span class="math notranslate nohighlight">\(T_{ad}\)</span> are measured in coalescence units of <span class="math notranslate nohighlight">\(2 N_e\)</span> generations. We have assumed a split time of 300kya, an admixture time of 50kya and a generation time of 25 years. Given these time parameters and <span class="math notranslate nohighlight">\(N_e =10000\)</span>, <span class="math notranslate nohighlight">\(T_{split}-T_{ad} = 1/2\)</span>, so we expect <span class="math notranslate nohighlight">\(1 -(e^{-1/2})=0.39\)</span> of admixed sequence to coalesce in the Neanderthal population. The actual observed proportion is 165617/373730 = 0.44, which isn’t far off. However, the fraction of the genome which shows the Eurasian and the Neanderthal as each others closest relatives is much higher (over 20%): most of this must therefore be ILS.</p>
<p>How about the <em>lengths</em> of the tracts? We can plot these out in histogram form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1000</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span>
    <span class="n">migrating_l</span> <span class="o">*</span> <span class="n">kb</span><span class="p">,</span>   
    <span class="p">(</span><span class="n">within_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">within_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">kb</span><span class="p">,</span>    
    <span class="p">(</span><span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">kb</span><span class="p">,],</span>
    <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Migrating&quot;</span><span class="p">,</span> <span class="s2">&quot;Within NEA&quot;</span><span class="p">,</span> <span class="s2">&quot;EUR-NEA closest&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Tract length (KB)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/introgression_7_0.png" src="_images/introgression_7_0.png" />
</div>
</div>
<p>Note that this is just a single replicate: we would need more replicates (or a larger chromosome) to draw firm conclusions from the patterns. Nevertheless, a few things stand out. Firstly, confirming our assessment of the relative proportions of the three types, the green bars (tracts at which Neanderthals and non-African humans are most closely related to each other) far outweigh the blue (admixed tracts). In other words, ILS accounts for the vast majority of the tracts plotted in green. Secondly, although there are relatively few admixure tracts they are are on average much longer. By definition ILS tracts must be old and are therefore likely to be short; indeed most of the green tracts are very short indeed (note that the Y axis is on a log scale). Finally, although the orange tracts are a strict subset of the blue, there are places where there are orange bars without blue equivalents. That suggests that the long blue admixture tracts may contain some regions that coalesce within Neanderthals and some that don’t. We can look at (say) the longest of the blue tracts to see how it intersects with the other tracts we’ve calculated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">longest_tract</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">migrating_l</span><span class="p">)</span>
<span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">migrating</span><span class="p">[</span><span class="n">longest_tract</span><span class="p">,:]</span>
<span class="n">within_long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">within_nea</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">within_nea</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">within_nea</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">within_nea</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">eur_nea_long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">eur_nea</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">eur_nea</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">eur_nea</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">eur_nea</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Migrating&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">within_long</span><span class="p">),</span> <span class="n">within_nea</span><span class="p">[</span><span class="n">within_long</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">within_nea</span><span class="p">[</span><span class="n">within_long</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Within NEA&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">eur_nea_long</span><span class="p">),</span> <span class="n">eur_nea</span><span class="p">[</span><span class="n">eur_nea_long</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">eur_nea</span><span class="p">[</span><span class="n">eur_nea_long</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;EUR-NEA closest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ancestry breakdown within the longest (</span><span class="si">{</span><span class="p">(</span><span class="n">upper</span><span class="o">-</span><span class="n">lower</span><span class="p">)</span><span class="o">/</span><span class="mi">1_000</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">kb) admixture tract&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Genomic position&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/introgression_9_0.png" src="_images/introgression_9_0.png" />
</div>
</div>
<p>As we go back in time, the single 178kb admixture tract (in blue) breaks down, with some regions
coalescing in the Neanderthal population (orange) and some not. Although quite a lot of the tract supports
grouping Eurasians with Neanderthals (green), substantial chunks of the admixed (blue)
tract do not map onto the green tracts, and therefore must support one of the two
other topologies (African+Neanderthal or African+Eurasian). These must be due to ILS.</p>
<p>The green signal, which is a measure of the local tree topology and which is the primary
signal that can be extracted from mutational data, is therefore not a very reliable guide to
which regions of the genome have passed through the admixed route. In other words,
admixed tracts are likely to be hard to detect simply from the distribution of mutations.</p>
<section id="locating-mutations">
<h2>Locating mutations<a class="headerlink" href="#locating-mutations" title="Permalink to this headline">#</a></h2>
<p>We might be interested in finding the population in which mutations arose. For this, we first need to impose some mutations on the tree sequence using <a class="reference external" href="https://tskit.dev/msprime/docs/stable/api.html#msprime.sim_mutations" title="(in Python)"><code class="xref py py-func docutils literal notranslate"><span class="pre">msprime.sim_mutations()</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">sim_mutations</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>  <span class="c1"># rate in /bp/gen</span>
</pre></div>
</div>
</div>
</div>
<p>Now we work out which population the mutation occurred in, from the times of the mutation and the migration events. The following function takes a simple approach, first gathering the migrations for each node into a list then sequentially examining each migration that affects the mutation’s node and intersects with the site position. Because we know that the migration records are sorted in increasing time order, we can simply apply the effects of each migration while the migration record’s time is less than the time of the mutation. At the end of this process, we then return the computed mapping of mutation IDs to the populations in which they arose.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_mutation_population</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">node_migrations</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">migrations</span><span class="p">():</span>
        <span class="n">node_migrations</span><span class="p">[</span><span class="n">migration</span><span class="o">.</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span>
    <span class="n">mutation_population</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">num_mutations</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">trees</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">sites</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">mutation</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">mutations</span><span class="p">:</span>                
                <span class="n">mutation_population</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">population</span><span class="p">(</span><span class="n">mutation</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">mig</span> <span class="ow">in</span> <span class="n">node_migrations</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">node</span><span class="p">]:</span>
                    <span class="c1"># Stepping through all migations will be inefficient for large </span>
                    <span class="c1"># simulations. Should use an interval tree (e.g. </span>
                    <span class="c1"># https://pypi.python.org/pypi/intervaltree) to find all </span>
                    <span class="c1"># intervals intersecting with site.position.</span>
                    <span class="k">if</span> <span class="n">mig</span><span class="o">.</span><span class="n">left</span> <span class="o">&lt;=</span> <span class="n">site</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="n">mig</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
                        <span class="c1"># Note that we assume that we see the migration records in </span>
                        <span class="c1"># increasing order of time!</span>
                        <span class="k">if</span> <span class="n">mig</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">mutation</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">mutation_population</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="n">mig</span><span class="o">.</span><span class="n">source</span>
                            <span class="n">mutation_population</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mig</span><span class="o">.</span><span class="n">dest</span>
    <span class="k">return</span> <span class="n">mutation_population</span>

<span class="n">mutation_population</span> <span class="o">=</span> <span class="n">get_mutation_population</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can plot a fraction of the tree sequence (say the first 25kb) using <a class="reference internal" href="viz.html#sec-tskit-viz-styling"><span class="std std-ref">styling</span></a> to colour both mutations and nodes by their population:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_units</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">25</span>  <span class="c1"># Conversion factor for kya to generations</span>

<span class="n">colour_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">}</span>
<span class="n">css</span> <span class="o">=</span> <span class="s2">&quot;.y-axis .tick .grid {stroke: #CCCCCC} .y-axis .tick .lab {font-size: 85%}&quot;</span>
<span class="n">css</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;.node.p</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> &gt; .sym </span><span class="se">{{</span><span class="s2">fill: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colour_map</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
<span class="n">css</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="sa">f</span><span class="s2">&quot;.mut.m</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> .sym </span><span class="se">{{</span><span class="s2">stroke: </span><span class="si">{</span><span class="n">colour_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="s2"> &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;.mut.m</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> .lab </span><span class="se">{{</span><span class="s2">fill: </span><span class="si">{</span><span class="n">colour_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="s2"> &quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mutation_population</span><span class="p">)])</span>
<span class="n">y_ticks</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span> <span class="s2">&quot;30&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">:</span> <span class="s2">&quot;Introgress&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">:</span> <span class="s2">&quot;Eur origin&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">:</span> <span class="s2">&quot;Nea origin&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">:</span> <span class="s2">&quot;1000&quot;</span><span class="p">}</span>
<span class="n">y_ticks</span> <span class="o">=</span> <span class="p">{</span><span class="n">y</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">:</span> <span class="n">lab</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">y_ticks</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">ts</span><span class="o">.</span><span class="n">draw_svg</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="n">x_lim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25_000</span><span class="p">),</span>
    <span class="n">time_scale</span><span class="o">=</span><span class="s2">&quot;log_time&quot;</span><span class="p">,</span>
    <span class="n">node_labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Af&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Eu&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Ne&quot;</span><span class="p">},</span>
    <span class="n">y_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;Time (kya)&quot;</span><span class="p">,</span>
    <span class="n">x_label</span><span class="o">=</span><span class="s2">&quot;Genomic position (bp)&quot;</span><span class="p">,</span>
    <span class="n">y_ticks</span><span class="o">=</span><span class="n">y_ticks</span><span class="p">,</span>
    <span class="n">y_gridlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="n">css</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/introgression_15_0.svg" src="_images/introgression_15_0.svg" /></div>
</div>
<p>The depth of the trees indicates that most coalescences occur well before the origin of
Neanderthals, and are thus instances of ILS. Moreover, most mutations on the trees are
red, indicating they occurred in the African population, although a few are blue
(Eurasian origin) or green (Neanderthal origin). A more comprehensive approach might
simply count the number of (say) mutations originating in Neanderthals:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;% of muts from Neanderthals: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mutation_population</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">ts</span><span class="o">.</span><span class="n">num_mutations</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>% of muts from Neanderthals: 12.90%
</pre></div>
</div>
</div>
</div>
<p>This seems high because it includes all the mutations that original in Neanderthals that are
<em>only</em> found in the Neanderthal genome (and not e.g. in the Eurasian sample). In real datasets
these are usually removed, to leave only those mutations that have been introgressed from Neanderthals
into modern humans. The percentage of introgressed Neanderthal mutations seen in modern
humans is much smaller:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  NOTE: we shouldn&#39;t need to mess with metadata to save mutation information once we can</span>
<span class="c1">#  simplify a tree sequence with migrations, see https://github.com/tskit-dev/tskit/issues/20</span>
<span class="kn">import</span> <span class="nn">tskit</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dump_tables</span><span class="p">()</span>
<span class="n">tables</span><span class="o">.</span><span class="n">mutations</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">tables</span><span class="o">.</span><span class="n">mutations</span><span class="o">.</span><span class="n">metadata_schema</span> <span class="o">=</span> <span class="n">tskit</span><span class="o">.</span><span class="n">MetadataSchema</span><span class="p">({</span><span class="s2">&quot;codec&quot;</span><span class="p">:</span><span class="s2">&quot;json&quot;</span><span class="p">})</span>
<span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mutation_population</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">mutations</span><span class="p">):</span>
    <span class="n">tables</span><span class="o">.</span><span class="n">mutations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pop&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)}))</span>   
<span class="n">tables</span><span class="o">.</span><span class="n">migrations</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">tables</span><span class="o">.</span><span class="n">simplify</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">extant_ts</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">tree_sequence</span><span class="p">()</span>
<span class="n">num_introgressed_muts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">extant_ts</span><span class="o">.</span><span class="n">mutations</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;pop&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;% Neanderthal muts in moderns: </span><span class="si">{</span><span class="n">num_introgressed_muts</span><span class="o">/</span><span class="n">extant_ts</span><span class="o">.</span><span class="n">num_mutations</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>% Neanderthal muts in moderns: 0.28%
</pre></div>
</div>
</div>
</div>
<p>So in this model, of the mutations in the ~2% of the Neanderthal genome contained in extant
Eurasians, the vast majority happened in the ancestral African population.
Only about 1 in 7 actually mutated in Neanderthals themselves.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="bottlenecks.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Instantaneous Bottlenecks</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="forward_sims.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><em>Building a forward simulator</em></p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Tskit Developers<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>