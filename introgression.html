
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Introgression &#8212; Tskit Tutorials</title>
    
  <link rel="stylesheet" href="_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Completing forwards simulations" href="completing-forward-sims.html" />
    <link rel="prev" title="Bottlenecks" href="bottlenecks.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">Tskit Tutorials</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Using tskit
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="getting_started.html">
   Getting started with tskit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="viz.html">
   Visualisation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_structures.html">
   Data structures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="no_mutations.html">
   Do you really need mutations?
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Backward time simulations
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="demography.html">
   Demography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bottlenecks.html">
   Bottlenecks
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Introgression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="completing-forward-sims.html">
   Completing forwards simulations
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Forward time simulations
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="forward_sims.html">
   Forward simulations
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Development
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="development.html">
   Development
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="_sources/introgression.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/introgression.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/tsk-dev/tutorials"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/tsk-dev/tutorials/issues/new?title=Issue%20on%20page%20%2Fintrogression.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/tsk-dev/tutorials/main?urlpath=tree/introgression.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#locating-mutations">
   Locating mutations
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="introgression">
<h1>Introgression<a class="headerlink" href="#introgression" title="Permalink to this headline">¶</a></h1>
<p><strong>Jerome Kelleher and Konrad Lohse</strong></p>
<p>There has been great interest in understanding the contributions past populations have made to the genetic diversity of current populations via admixture. In particular, the availability of whole genome sequence data from archaic hominins (Green et al 2010) has allowed geneticists to identify admixture tracks (Sankararaman 2016). In the simplest case, admixture tracts can be defined heuristically as regions of the genome that show excessive similarity between a putative source and a recipient population (usually quantified relative to some non-admixted reference population, ref Durand et al 2010). Because recombination breaks down admixture tracts, their length distribution gives a clock for calibrating admixture and this information been used to date the admixure contributions Neanderthals and other archaic hominins have made to non-African humans (Sankararaman 2016) and to recontruct the admixture history between different modern human populations (ref).</p>
<p>Crucially, the power to identify admixture depends on the relative time bewteen the admixture event and the earlier divergence between source and the recipient population: the shorter this interval, the harder it becomes to detect admixture. This is because ancestral material is increasingly likely to trace its ancestry back to the common ancestral population regardless of whether it has been involved in any recent admixture or not. In other words, it becomes increasingly difficult to distinguish between admixtjure from Incomplete lineage sorting (ILS).</p>
<p>In the following section we use msprime simulations to ask what fraction of admixture tracts are identifyable as such.</p>
<p>To illustrate this, we simulate ancestral recombination graphs (ARGs) under a simple toy history of divergence and admixture which is loosely motivated by the demographic history of modern humans and Neandertals. As in previous sections, we will first examine properties of the ARG directly rather than use it to simulate mutations. We assume a minimal sample of a single (haploid) genome from a modern human population in African and Eurasia as well as an ancient Neandertal sample.</p>
<p>Considering a rooted ARG, we want to distinguish three categories of segments: i) tracts actually involved in Neandertal admixture, ii) the subset of those tracts that coalesces in the Neandertal population and iii) segments at which Eurasians are more closely related to Neandertals than either are to Africans. This latter category must include all of ii) but also an additional set of short tracts that are due to incomplete lineage sorting (ILS). The last category is interesting because it is the only one that can be unambiguously detected in data (via derived mutations that are shared by Neandertals and Eurasians).</p>
<p>First we set up a highly simplified demographic history of human neandertal demography and simulate a single chromosome of 20Mb length:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">msprime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">SVG</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Population IDs: Africa, Eurasia, Neanderthal</span>
<span class="n">AFR</span><span class="p">,</span> <span class="n">EUR</span><span class="p">,</span> <span class="n">NEA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
    
<span class="k">def</span> <span class="nf">run_simulation</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   
    <span class="n">time_units</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">25</span>  <span class="c1"># Conversion factor for kya to generations</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
        <span class="n">Ne</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># The same for all populations; highly unrealistic!</span>
        <span class="n">recombination_rate</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
        <span class="n">length</span><span class="o">=</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span>  
        <span class="n">samples</span><span class="o">=</span><span class="p">[</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">AFR</span><span class="p">),</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">EUR</span><span class="p">),</span>
            <span class="c1"># Neanderthal sample taken 30 kya</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">NEA</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">population_configurations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">PopulationConfiguration</span><span class="p">(),</span> <span class="c1"># Africa</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">PopulationConfiguration</span><span class="p">(),</span> <span class="c1"># Eurasia</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">PopulationConfiguration</span><span class="p">(),</span> <span class="c1"># Neanderthal</span>
        <span class="p">],</span>
        <span class="n">demographic_events</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">MassMigration</span><span class="p">(</span>
                <span class="c1"># 2% introgression 50 kya</span>
                <span class="n">time</span><span class="o">=</span><span class="mi">50</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">EUR</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">NEA</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="mf">0.02</span><span class="p">),</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">MassMigration</span><span class="p">(</span>
                <span class="c1"># Eurasian &amp; Africa populations merge 70 kya</span>
                <span class="n">time</span><span class="o">=</span><span class="mi">70</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span> 
                <span class="n">source</span><span class="o">=</span><span class="n">EUR</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">AFR</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">msprime</span><span class="o">.</span><span class="n">MassMigration</span><span class="p">(</span>
                <span class="c1"># Neanderthal and African populations merge 300 kya</span>
                <span class="n">time</span><span class="o">=</span><span class="mi">300</span> <span class="o">*</span> <span class="n">time_units</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">NEA</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="n">AFR</span><span class="p">,</span> <span class="n">proportion</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">record_migrations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Needed for tracking segments.</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here we run our simulation in the usual way, but including the <code class="docutils literal notranslate"><span class="pre">record_migrations</span></code> option. This allows us to track segments of ancestral material that migrate from the European population into the Neanderthal population (backwards in time). We can then examine the length distributions of these segments and compare them with the length of the segments that also go on to coalesce within the Neanderthal population.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_migrating_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">migrating_tracts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Get all tracts that migrated into the neanderthal population</span>
    <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">migrations</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">migration</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="n">NEA</span><span class="p">:</span>
            <span class="n">migrating_tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">migration</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">migrating_tracts</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">get_coalescing_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">coalescing_tracts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">trees</span><span class="p">():</span>    
        <span class="c1"># 1 is the Eurasian sample and 2 is the Neanderthal</span>
        <span class="n">mrca_pop</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">population</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">mrca</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mrca_pop</span> <span class="o">==</span> <span class="n">NEA</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Start a new tract</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="n">left</span>      
        <span class="k">elif</span> <span class="n">mrca_pop</span> <span class="o">!=</span> <span class="n">NEA</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># End the last tract</span>
            <span class="n">coalescing_tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coalescing_tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coalescing_tracts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_eur_nea_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">tracts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">trees</span><span class="p">():</span>    
        <span class="c1"># 1 is the Eurasian sample and 2 is the Neanderthal</span>
        <span class="n">mrca</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">mrca</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mrca</span> <span class="o">!=</span> <span class="n">tree</span><span class="o">.</span><span class="n">root</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Start a new tract</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="n">left</span>      
        <span class="k">elif</span> <span class="n">mrca</span> <span class="o">!=</span> <span class="n">tree</span><span class="o">.</span><span class="n">root</span> <span class="ow">and</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># End the last tract</span>
            <span class="n">tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
            <span class="n">tract_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">tract_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tracts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tract_left</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tracts</span><span class="p">)</span>

                                    
<span class="n">migrating</span> <span class="o">=</span> <span class="n">get_migrating_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<span class="n">within_nea</span> <span class="o">=</span> <span class="n">get_coalescing_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<span class="n">eur_nea</span> <span class="o">=</span> <span class="n">get_eur_nea_tracts</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We build three different lists. The first is the set of tracts that have migrated from the Eurasian population into the Neanderthal population, and is done simply by finding all migration records in which the destination population is equal to NEA. The second list (which must contain a subset of the segments in the first list) is the ancestral segments that went on to coalesce within the Neanderthal population. The third list contains all segments in which the Eurasian and Neanderthal sample coalesce before their ancestor coalesces with the African sample. The third list includes both Eurasian segments that migrated to the Neanderthal population and segments that did not migrate and did not coalesce until after the Neanderthal-Human population split 300kya.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nea_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">migrating_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">migrating</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">migrating</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">within_nea_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">within_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">within_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">([</span><span class="n">nea_total</span><span class="p">,</span> <span class="n">migrating_total</span><span class="p">,</span> <span class="n">within_nea_total</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10077464.05508275, 316645.8476603916, 164413.62338078953]
</pre></div>
</div>
</div>
</div>
<p>Although <span class="math notranslate nohighlight">\(f=0.02\)</span> the total length of admixted segments is 5% of the chromosome. Presumably this excess is just due to coalescence variance? We expect a proportion <span class="math notranslate nohighlight">\(1-e^{-(T_{split}-T_{ad})}\)</span> of admixted lineages to coalesce. Given our time parameters <span class="math notranslate nohighlight">\(T_{split}-T_{ad})= 1/2\)</span> (in units of <span class="math notranslate nohighlight">\(2 N_e\)</span> generations), so we expect <span class="math notranslate nohighlight">\(1 -(e^-\frac{1}{2})=0.39\)</span> of admixted sequence to have a coalesce in the neandertal population. Why is the observed fraction just 0.029?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1000</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span>
    <span class="p">(</span><span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">eur_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">kb</span><span class="p">,</span>
    <span class="p">(</span><span class="n">migrating</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">migrating</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">kb</span><span class="p">,</span>   
    <span class="p">(</span><span class="n">within_nea</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">within_nea</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">kb</span><span class="p">,],</span>    
    <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Migrating&quot;</span><span class="p">,</span> <span class="s2">&quot;EUR-NEA&quot;</span><span class="p">,</span> <span class="s2">&quot;Within NEA&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Tract length (KB)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/introgression_9_0.png" src="_images/introgression_9_0.png" />
</div>
</div>
<p>Plotting these tract lengths for a single replicate shows that, as expected, admixture tracts are large initially (blue). We can also see that there is extensive ILS which has two effects: First, only a subset  of the admixted material has ancestry in the Neandertal population, it would to check whether this fits the total lengths}). Second there many more tracts at which Neandertals and non-African humans are more closely related to each other due to incomplete lineage sorting (ILS) than there are admixture tracts. Finally ILS tracts because they are old by definition  are substantially shorter than admixture tracts.</p>
<div class="section" id="locating-mutations">
<h2>Locating mutations<a class="headerlink" href="#locating-mutations" title="Permalink to this headline">¶</a></h2>
<p>We are interested in finding the population in which mutations arose. Because mutations are just associated with a specific tree node in msprime, we must simulate some extra information in order to make this question answerable. This is quite straightforward to do, since we can generate a time for each mutation uniformly along a branch and therefore unambiguously locate it time (and, therefore, space).</p>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>We don’t need to simulate times any more</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_mutation_times</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">mutation_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">num_mutations</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">trees</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">mutation</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">mutations</span><span class="p">():</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">mutation</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">mutation</span><span class="o">.</span><span class="n">node</span><span class="p">))</span>
            <span class="n">mutation_time</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mutation_time</span>

<span class="n">pop_configs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">msprime</span><span class="o">.</span><span class="n">PopulationConfiguration</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">msprime</span><span class="o">.</span><span class="n">PopulationConfiguration</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">msprime</span><span class="o">.</span><span class="n">PopulationConfiguration</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">M</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
<span class="n">ts</span>  <span class="o">=</span> <span class="n">msprime</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
    <span class="n">population_configurations</span><span class="o">=</span><span class="n">pop_configs</span><span class="p">,</span> <span class="n">migration_matrix</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
    <span class="n">record_migrations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">mutation_time</span> <span class="o">=</span> <span class="n">simulate_mutation_times</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have run our simulation and assigned times to each mutation, we can then assign populations to each of these mutations. The following function takes a simple approach, but first gathering the migrations for each node into a list. Then, for every mutation, we sequentially examine each migration that affects the mutation’s node and intersects with the site position. Because we know that the migration records are sorted in increasing time order, we can simply apply the effects of each migration while the migration record’s time is less than the time of the mutation. At the end of this process, we then return the computed mapping of mutation IDs to the populations in which they arose.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_mutation_population</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">mutation_time</span><span class="p">):</span>
    <span class="n">node_migrations</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">migrations</span><span class="p">():</span>
        <span class="n">node_migrations</span><span class="p">[</span><span class="n">migration</span><span class="o">.</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span>
    <span class="n">mutation_population</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">num_mutations</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">trees</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">sites</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">mutation</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">mutations</span><span class="p">:</span>                
                <span class="n">mutation_population</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">population</span><span class="p">(</span><span class="n">mutation</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">mig</span> <span class="ow">in</span> <span class="n">node_migrations</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">node</span><span class="p">]:</span>
                    <span class="c1"># Stepping through all migations will be inefficient for large </span>
                    <span class="c1"># simulations. Should use an interval tree (e.g. </span>
                    <span class="c1"># https://pypi.python.org/pypi/intervaltree) to find all </span>
                    <span class="c1"># intervals intersecting with site.position.</span>
                    <span class="k">if</span> <span class="n">mig</span><span class="o">.</span><span class="n">left</span> <span class="o">&lt;=</span> <span class="n">site</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="n">mig</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
                        <span class="c1"># Note that we assume that we see the migration records in </span>
                        <span class="c1"># increasing order of time!</span>
                        <span class="k">if</span> <span class="n">mig</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">mutation_time</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]:</span>
                            <span class="k">assert</span> <span class="n">mutation_population</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="n">mig</span><span class="o">.</span><span class="n">source</span>
                            <span class="n">mutation_population</span><span class="p">[</span><span class="n">mutation</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mig</span><span class="o">.</span><span class="n">dest</span>
    <span class="k">return</span> <span class="n">mutation_population</span>

<span class="n">mutation_population</span> <span class="o">=</span> <span class="n">get_mutation_population</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">mutation_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">colour_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">}</span>
<span class="n">node_colours</span> <span class="o">=</span> <span class="p">{</span><span class="n">u</span><span class="p">:</span> <span class="n">colour_map</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">population</span><span class="p">(</span><span class="n">u</span><span class="p">)]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">nodes</span><span class="p">()}</span>
<span class="n">mutation_colours</span> <span class="o">=</span> <span class="p">{</span><span class="n">mut</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">colour_map</span><span class="p">[</span><span class="n">mutation_population</span><span class="p">[</span><span class="n">mut</span><span class="o">.</span><span class="n">id</span><span class="p">]]</span> <span class="k">for</span> <span class="n">mut</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">mutations</span><span class="p">()}</span>
<span class="n">SVG</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">node_colours</span><span class="o">=</span><span class="n">node_colours</span><span class="p">,</span> <span class="n">mutation_colours</span><span class="o">=</span><span class="n">mutation_colours</span><span class="p">))</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/introgression_15_0.svg" src="_images/introgression_15_0.svg" /></div>
</div>
<p>This example shows the locations in which the mutations along the tree branches. We show a single tree here for simplicity, but the method also works when we have recombination.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="bottlenecks.html" title="previous page">Bottlenecks</a>
    <a class='right-next' id="next-link" href="completing-forward-sims.html" title="next page">Completing forwards simulations</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Tskit Developers<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>